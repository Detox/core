/*
 0BSD
*/
(function(){function ba(g,p){var h=new Uint8Array(g.length+n);h.set(g);h.set(p,g.length);return h}function K(h,p,z,x){var m=new Uint8Array(2*g+z.length+n);m.set(h);m.set(p,g);m.set(z,2*g);m.set(x,2*g+z.length);return m}function T(h){return[h.subarray(0,g),h.subarray(g,2*g),h.subarray(2*g,h.length-n),h.subarray(h.length-n)]}function Ca(h){var p;var z=h[0];var x=h.subarray(1,1+g);var m=[];h=h.subarray(1+g);var n=0;for(p=h.length/g;n<p;++n){var L=n;m.push(h.subarray(L*g,(L+1)*g))}return[z,x,m]}function Da(h,
n,z,x,m,D){var p=new Uint8Array(3*g+G+M+g);p.set(h);p.set(n,g);p.set(z,2*g);p.set(x,3*g);p.set(m,3*g+G);p.set(D,3*g+G+M);return p}function Ea(h,p,n,x){var m=new Uint8Array(3*g+x.length);m.set(h);m.set(p,g);m.set(n,2*g);m.set(x,3*g);return m}function Fa(h,p,z){var x=new Uint8Array(n+g+G);x.set(h);x.set(p,n);x.set(z,n+g);return x}function ca(h){return[h.subarray(0,n),h.subarray(n,n+g),h.subarray(n+g)]}function Ga(h,p){var n=new Uint8Array(g+p.length);n.set(h);n.set(p,g);return n}function H(h,p,z,x,
m,H,L,P){function Q(a){return h.create_keypair(a)}function r(a,b,d,e,f){var c=this;null==d&&(d=1);null==e&&(e=2);null==f&&(f={});if(!(this instanceof r))return new r(a,b,d,e,f);L.call(this);this.a=Object.assign({dht_keypair_seed:null,state_history_size:1E3,values_cache_size:1E3,fraction_of_nodes_from_same_peer:.2,lookup_number:Math.max(e,5),max_pending_segments:10,aware_of_nodes_limit:1E3,min_number_of_peers_for_ready:e,connected_nodes_limit:50},f,{timeouts:Object.assign({},Ha,f.timeouts||{})});this.o=
w();this.Y=Q(this.a.dht_key_seed);this.h=this.Y.ed25519["public"];this.L=this.Y.ed25519["private"];this.O=x.MAX_DATA_SIZE;this.Ja=x.MAX_COMPRESSED_DATA_SIZE;this.w=new Set(a);this.ja=E();this.G=E();this.l=w();this.f=E();this.aa=E();this.K=w();this.c=w();this.N=E();this.u=w();this.m=w();this.s=w();this.W=w();this.V=w();this.D=w();this.A=w();this.C=w();this.J=E();this.B=w();this.$=w();this.X=w();this.F=w();this.I=E();this.Aa=R(this.a.timeouts.LAST_USED_TIMEOUT,function(){var a=+new Date-1E3*c.a.timeouts.LAST_USED_TIMEOUT;
c.V.forEach(function(b,l){if(b<a){if(c.u.has(l)){var k=c.u.get(l);b=k[0];k=k[1];c.ta(b,k)}c.V["delete"](l)}});c.W.forEach(function(b,l){b<a&&(c.W["delete"](l),c.b.destroy_connection(l))});var b=+new Date-2E3*c.a.timeouts.STALE_AWARE_OF_NODE_TIMEOUT;c.c.forEach(function(a,l){if(a<b)c.c["delete"](l)})});this.Ia=R(this.a.timeouts.LAST_USED_TIMEOUT/5*4,function(){c.o.forEach(function(a,b){var l=a[1];var d=a[3];a=a[4];d.size<l&&a&&(l=+new Date-3*c.a.timeouts.CONNECTION_TIMEOUT,a<l&&c.ia(b));d.forEach(function(a){a=
q([b,a]);var l=c.m.get(a);a=l[0];l=l[1];c.sa(a,l)&&(a=q([a,l]),c.J.add(a))})})});this.Fa=R(this.a.timeouts.GET_MORE_AWARE_OF_NODES_INTERVAL,function(){c.ua()&&c.Da()});this.b=x.Transport(this.h,b,d,Ia,this.a.timeouts.CONNECTION_TIMEOUT).on("connected",function(a){c.g.add_peer(a);c.f.add(a);c.c["delete"](a);c.fire("aware_of_nodes_count",c.c.size);c.fire("connected_nodes_count",c.f.size);c.j&&c.T(a,U,Ja(c.j));if(c.f.size>c.a.connected_nodes_limit){var b=[];var l=E();c.C.forEach(function(a){l.add(a[0])});
c.f.forEach(function(d){C(a,d)||c.G.has(d)||l.has(d)||c.aa.has(d)||b.push(d)});if(b.length){var d=N(b);c.b.destroy_connection(d)}}}).on("disconnected",function(a){c.g.del_peer(a);c.f["delete"](a);c.aa["delete"](a);c.fire("connected_nodes_count",c.f.size);c.N["delete"](a)}).on("data",function(a,b,d){c.ga(a,!1);b>=V?c.j&&b!==U||c.Ha(a,b-V,d):b===W?c.j||c.i.process_packet(a,d):b>=X?c.g.receive(a,b-X,d):c.j&&b!==D||c.Ga(a,b,d)});this.g=p.DHT(this.h,e,this.a.state_history_size,this.a.values_cache_size,
this.a.fraction_of_nodes_from_same_peer,this.a.timeouts).on("peer_error",function(a){c.oa(a)}).on("peer_warning",function(){}).on("connect_to",function(a,b){return new Promise(function(d,l){function e(){l()}if(c.f.has(a))d();else{var k=c.b.get_connection(a);if(!k){k=c.b.create_connection(!0,a);if(!k){l();return}k.on("signal",function(d){var l=h.sign(d,c.h,c.L);d=K(c.h,a,d,l);c.S(b,D,d)})}k.once("connected",function(){k.off("disconnected",e);d()}).once("disconnected",e)}})}).on("send",function(a,b,
d){c.va(a,b,d)}).on("peer_updated",function(a,b){var d;c.aa.add(a);a=0;for(d=b.length;a<d;++a){var e=b[a];c.f.has(e)||c.c.set(e,+new Date)}});this.i=z.Router(this.Y.x25519["private"],this.a.max_pending_segments,this.a.timeouts.ROUTING_PATH_SEGMENT_TIMEOUT).on("activity",function(a,b){var d=q([a,b]);c.u.has(d)||c.u.set(d,[a,b]);c.V.set(d,+new Date)}).on("send",function(a,b){c.wa(a,b)}).on("data",function(a,b,d,e){var l;var f=q([a,b]);switch(d){case da:var k=c.ya(e);if(!k)break;c.A.has(k)&&clearInterval(c.A.get(k)[2]);
d=R(c.a.timeouts.ANNOUNCE_INTERVAL,function(){c.u.has(f)&&c.pa(e)});c.A.set(k,[a,b,d]);c.pa(e);break;case ea:var t=e;if(t.length!==g)break;var m=function(d,e){var f=t,l;var k=l=new Uint8Array(1+g+e.length*g);k.set([d]);k.set(f,1);d=0;for(f=e.length;d<f;++d){k=d;var h=e[d];l.set(h,1+g+k*g)}c.v(a,b,fa,l)};c.Ba(t).then(function(a){a.length?m(ha,a):m(Y,[])})["catch"](function(a){J(a);m(Y,[])});break;case ia:var u=[e.subarray(0,g),e.subarray(g,2*g),e.subarray(2*g,3*g),e.subarray(3*g)];var y=u[0];d=u[1];
t=u[2];k=u[3];if(c.D.has(y))break;var A=O(c.a.timeouts.CONNECTION_TIMEOUT,function(){c.D["delete"](y)});c.D.set(y,[a,b,t,A]);c.T(d,ja,Ga(t,k));break;case ka:u=ca(e);k=u[0];y=u[1];var p=u[2];A=c.D.get(y);if(!A)break;d=A[0];var F=A[1];t=A[2];A=A[3];if(!h.verify(k,y,t))break;c.D["delete"](y);clearTimeout(A);c.v(d,F,la,e);k=q([d,F]);c.C.set(f,[d,F]);c.C.set(k,[a,b]);break;case ma:d=c.s.get(f);if(!d)break;var v=d[0];d=d[1];if(!c.o.has(v))break;u=c.o.get(v);var r=u[0];var x=u[3];if(!x.has(d))break;try{A=
h.one_way_decrypt(r.x25519["private"],e);k=A.subarray(0,n);F=A.subarray(n);u=[F.subarray(0,g),F.subarray(g,2*g),F.subarray(2*g,3*g),F.subarray(3*g,3*g+G),F.subarray(3*g+G,3*g+G+M),F.subarray(3*g+G+M,3*g+G+M+g)];t=u[0];var w=u[1];y=u[2];p=u[3];var C=u[4];var z=u[5];var E=q([d,F]);if(h.verify(k,E,t)){var B=q([v,t]);if(!c.m.has(B)){if(c.l.has(B)){var I=c.l.get(B);if(I.U&&!I.H){var D=0;for(l=v.length;D<l;++D){var H=D;var na=v[D];if(na!==t[H]){if(na>t[H])return;I.H=!0;break}}}}else I={U:!1},c.l.set(B,
I);e={real_public_key:v,target_id:t,secret:z,application:C,number_of_intermediate_nodes:null};c.fire("introduction",e).then(function(){var a=e.number_of_intermediate_nodes;if(null===a)throw"No event handler for introduction";if(!a)throw Error("Direct connections are not yet supported");if(a=c.da(a,[w])){a.push(w);var b=a[0];c.ca(a).then(function(a){var d=h.Encryptor(!1,r.x25519["private"]);d.put_handshake_message(p);var e=d.get_handshake_message();c.B.set(B,d);c.ea(v,t,b,a);c.l["delete"](B);c.ra(v,
t);a=h.sign(y,v,r.ed25519["private"]);c.fa(v,t,ka,Fa(a,y,e))})["catch"](function(a){J(a);c.l["delete"](B);I.U&&I.H&&c.fire("connection_failed",v,t,S)})}})["catch"](function(a){J(a);c.l["delete"](B);I.U&&I.H&&c.fire("connection_failed",v,t,S)})}}}catch(Ka){k=Ka,J(k)}break;case Z:if(c.C.has(f))u=c.C.get(f),d=u[0],F=u[1],c.v(d,F,Z,e);else if(c.s.has(f)&&(u=c.s.get(f),v=u[0],t=u[1],B=q([v,t]),d=c.B.get(B))&&(k=c.X.get(B)))for(d=d.decrypt(e),k.feed(d);k.have_more_data();)A=k.get_data(),d=A[0],c.fire("data",
v,t,d,A.subarray(1));break;case oa:if(c.s.has(f)&&c.J.has(f))c.J["delete"](f);else c.sa(a,b)}});this.na=this.i.get_max_packet_data_size()-La;if(this.w.size)this.g.once("peer_updated",function(){c.fire("ready")});else setTimeout(function(){c.fire("ready")});this.M()}null==P&&(P=window.fetch);var Ma=m.hex2array;var Na=m.array2hex;var Ja=m.string2array;var Oa=m.array2string;var aa=m.random_bytes;var Pa=m.random_int;var N=m.pull_random_item_from_array;var C=m.are_arrays_equal;var q=m.concat_arrays;var O=
m.timeoutSet;var R=m.intervalSet;var J=m.error_handler;var w=m.ArrayMap;var E=m.ArraySet;var Qa=m.sample;var pa=new Uint8Array(0);var qa=new Uint8Array(g);r.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=ra;r.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=sa;r.CONNECTION_ERROR_NO_INTRODUCTION_NODES=Y;r.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=S;r.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=ta;r.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ua;r.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=
va;r.CONNECTION_PROGRESS_INTRODUCTION_SENT=wa;r.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=xa;r.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=ya;r.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=za;r.prototype={start_bootstrap_node:function(a,b,d,e,f){var c=this;null==e&&(e=b);null==f&&(f=d);var l=h.create_keypair(a).ed25519;this.Z=require("http").createServer(function(a,b){b.setHeader("Access-Control-Allow-Origin","*");b.setHeader("Connection","close");var d=a.headers["content-length"];
if("POST"===a.method&&d&&d<=c.Ja){var e=[];a.on("data",function(a){e.push(a)}).on("end",function(){var a;e=q(e);var d=T(e);var f=d[0];var g=d[1];var k=d[2];var m=d[3];if(h.verify(m,k,f)&&C(g,qa))if(c.f.size&&Pa(0,c.f.size)?a=null!=(d=c.P(1))?d[0]:void 0:a=null,a){var y=q([f,a]);if(c.K.has(y))b.writeHead(503),b.end();else{k=K(f,a,k,m);c.S(a,D,k);c.K.set(y,function(c,d,e){clearTimeout(v);h.verify(d,c,a)?(c=ba(e,h.sign(e,l["public"],l["private"])),b.write(Buffer.from(c))):b.writeHead(502);b.end()});
var v=O(c.a.timeouts.CONNECTION_TIMEOUT,function(){c.K["delete"](y);b.writeHead(504);b.end()})}}else(d=c.b.create_connection(!1,f))?d.once("signal",function(a){var d=h.sign(a,c.h,c.L);a=K(c.h,f,a,d);a=ba(a,h.sign(a,l["public"],l["private"]));b.write(Buffer.from(a));b.end();return!1}).signal(k):(b.writeHead(503),b.end());else b.writeHead(400),b.end()})}else b.writeHead(400),b.end()});this.Z.on("error",J).listen(d,b,function(){var a=Na(l["public"]);c.j=a+":"+e+":"+f});this.ka()},get_bootstrap_nodes:function(){return Array.from(this.w)},
za:function(a){function b(){--d;d||"function"==typeof a&&a()}var d,e=this;(d=this.w.size)?this.w.forEach(function(a){function c(){b()}var d;a=a.split(":");var f=Ma(a[0]);var k=a[1]+":"+a[2];var m=aa(g);if(d=e.b.create_connection(!0,m))d.on("signal",function(a){var b=h.sign(a,e.h,e.L);var c={method:"POST",headers:{Connection:"close"},body:K(e.h,qa,a,b).buffer};P("https://"+k,c)["catch"](function(a){if("undefined"===typeof location||"http:"===location.protocol)return P("http://"+k,c);throw a;}).then(function(a){if(!a.ok)throw"Request failed, status code "+
a.status;return a.arrayBuffer()}).then(function(a){return new Uint8Array(a)}).then(function(a){a=[a.subarray(0,a.length-n),a.subarray(a.length-n)];var b=a[0];a=a[1];if(!h.verify(a,b,f))throw"Bad bootstrap node response";a=T(b);b=a[0];var c=a[1];var g=a[2];a=a[3];if(!h.verify(a,g,b)||!C(c,e.h))throw"Bad response";if(e.b.get_connection(b))throw"Already connected";e.b.update_peer_id(m,b);d.signal(g)})["catch"](function(){d.destroy()})}).once("connected",function(){d.off("disconnected",c);b()}).once("disconnected",
c)}):"function"==typeof a&&a()},announce:function(a,b,d){if(this.j)return null;a=Q(a);var e=a.ed25519["public"];if(this.o.has(e))return null;this.o.set(e,[a,b,d,E()]);this.ia(e);return e},ia:function(a){function b(b){var c;b&&n.push(b);--p;if(!p)if(n.length){n=n.concat(q);var d=f.Ca(a,g.ed25519["private"],n);var e=0;for(c=n.length;e<c;++e)b=n[e],f.fa(a,b,da,d);f.fire("announced",a)}else f.ha(a,1),f.fire("announcement_failed",a,ya)}function d(c){var d,f=this;if(d=this.da(k,e.concat(q))){d.push(c);
var g=d[0];this.ca(d).then(function(d){f.ea(a,c,g,d);m.add(c);b(c)})["catch"](function(a){J(a);b()})}else this.fire("announcement_failed",a,za)}var e,f=this;var c=this.o.get(a);var g=c[0];var h=c[1];var k=c[2];var m=c[3];var q=[];m.forEach(function(a){q.push(a)});if(h-=q.length)if(this.ha(a,+new Date),e=this.ba(h,q)){var p=h;var n=[];c=0;for(h=e.length;c<h;++c)d.call(this,e[c])}else this.ha(a,1),this.fire("announcement_failed",a,xa)},ha:function(a,b){this.o.get(a)[4]=b},connect_to:function(a,b,d,
e,f){function c(a){if(!p.H){l.l["delete"](n);if(r)l.G["delete"](r);l.fire("connection_failed",k,b,a)}}var l=this;if(this.j)return null;if(!f)throw Error("Direct connections are not yet supported");var m=Q(a);var k=m.ed25519["public"];if(C(k,b))return null;var n=q([k,b]);if(this.l.has(n))return k;var p={U:!0,H:!1};this.l.set(n,p);if(this.m.has(n))return null;a=this.da(f);if(!a)return c(sa),null;var r=a[0];var x=a[a.length-1];this.ca(a).then(function(a){function f(f,v,t,u){function w(){function f(c,
d,e,g){C(r,c)&&C(a,d)&&e===la&&(e=ca(g),c=e[0],d=e[1],e=e[2],C(d,y)&&h.verify(c,y,b)&&(u.put_handshake_message(e),l.B.set(n,u),clearTimeout(D),l.i.off("data",f),l.ea(k,b,r,a),l.l["delete"](n),l.ra(k,b)))}if(!p.H)if(A.length){var v=N(A);var y=aa(g);var t=h.convert_public_key(b);var u=h.Encryptor(!0,t);var B=u.get_handshake_message();B=Da(k,x,y,B,d,e);var z=q([v,B]);z=h.sign(z,k,m.ed25519["private"]);B=q([z,B]);t=h.one_way_encrypt(t,B);l.i.on("data",f);l.v(r,a,ia,Ea(y,v,b,t));l.fire("connection_progress",
k,b,wa);var D=O(l.a.timeouts.CONNECTION_TIMEOUT,function(){l.i.off("data",f);u.destroy();w()})}else c(ta)}if(C(r,f)&&C(a,v)&&t===fa){f=Ca(u);v=f[0];t=f[1];var A=f[2];C(b,t)&&(clearTimeout(y),v!==ha?c(v):(l.fire("connection_progress",k,b,va),w()))}}l.fire("connection_progress",k,b,ua);l.i.on("data",f);l.v(r,a,ea,b);var y=O(l.a.timeouts.CONNECTION_TIMEOUT,function(){l.i.off("data",f);c(ra)})})["catch"](function(a){J(a);c(S)});return k},get_max_data_size:function(){return this.O},send_to:function(a,
b,d,e){var f,c,g=this;if(!this.j){var h=q([a,b]);!(f=this.B.get(h))||e.length>this.O||!(c=this.$.get(h))||(d=q([[d],e]),c.feed(d),this.F.has(h)||this.F.set(h,setTimeout(function(){for(g.F["delete"](h);c.have_more_blocks();){var d=c.get_block();d=f.encrypt(d);g.fa(a,b,Z,d)}})))}},destroy:function(){this.la||(this.la=!0,this.j?this.Z&&this.Z.close():this.ka(),clearTimeout(this.qa),this.b.destroy(),this.g.destroy())},ka:function(){var a=this;clearInterval(this.Aa);clearInterval(this.Ia);clearInterval(this.Fa);
this.u.forEach(function(b){a.ta(b[0],b[1])});this.D.forEach(function(a){clearTimeout(a[3])});this.i.destroy()},ua:function(){return!this.j&&!!(this.c.size<this.a.aware_of_nodes_limit||this.ma(!0).length)},ma:function(a){null==a&&(a=!1);var b=[];var d=+new Date-1E3*this.a.timeouts.STALE_AWARE_OF_NODE_TIMEOUT;var e=!1;this.c.forEach(function(f,c){!e&&f<d&&(b.push(c),a&&!e&&(e=!0))});return b},Da:function(){var a,b;if(a=this.P(5)){var d=0;for(b=a.length;d<b;++d){var e=a[d];this.Ea(e)}}},Ea:function(a){this.N.add(a);
this.T(a,Aa,pa)},da:function(a,b){var d;null==b&&(b=[]);b=Array.from(this.G.values()).concat(b);var e=null!=(d=this.P(1,b))?d[0]:void 0;return e?(a=this.ba(a-1,b.concat([e])))?[e].concat(a):null:null},P:function(a,b){var d=[];null==a&&(a=1);null==b&&(b=[]);if(!this.f.size)return null;var e=Array.from(this.f.values());var f=E(b.concat(Array.from(this.ja)));e=e.filter(function(a){return!f.has(a)});if(!e.length)return null;for(b=0;b<a;++b)e.length&&d.push(N(e));return d},ba:function(a,b){var d=[];if(this.c.size<
a)return null;var e=Array.from(this.c.keys());if(b){var f=E(b);e=e.filter(function(a){return!f.has(a)})}if(e.length<a)return null;for(b=0;b<a;++b)d.push(N(e));return d},M:function(){var a=this;if(!this.la)if(this.g.get_peers().length<this.w.size&&this.w.size)this.za(function(){a.M()});else{var b=Qa(this.a.timeouts.RANDOM_LOOKUPS_INTERVAL);this.qa=O(this.qa?b:0,function(){a.g.lookup(Q(null).ed25519["public"],a.a.lookup_number).then(function(){a.M()})["catch"](function(){a.M()})})}},ca:function(a){var b=
this;var d=a[0];this.G.add(d);a=this.i.construct_routing_path(a);a["catch"](function(a){J(a);b.G["delete"](d)});return a},ea:function(a,b,d,e){var f=q([d,e]);if(!this.s.has(f)){var c=q([a,b]);this.m.set(c,[d,e]);this.s.set(f,[a,b]);this.$.set(c,H.Multiplexer(this.O,this.na));this.X.set(c,H.Demultiplexer(this.O,this.na));this.fire("routing_paths_count",this.m.size)}},ta:function(a,b){var d=this;var e=q([a,b]);if(this.u.has(e)&&(this.G["delete"](a),this.u["delete"](e),this.i.destroy_routing_path(a,
b),this.C["delete"](e),this.J["delete"](e),this.A.forEach(function(a,b){var c=a[0];var f=a[1];a=a[2];c=q([c,f]);C(e,c)&&(clearInterval(a),d.A["delete"](b))}),this.s.has(e))){b=this.s.get(e);a=b[0];b=b[1];var f=q([a,b]);this.s["delete"](e);this.m["delete"](f);this.F.has(f)&&(clearTimeout(this.F.get(f)),this.F["delete"](f));if(this.o.has(a)){var c=this.o.get(a)[3];c["delete"](b)}if(c=this.B.get(f))c.destroy(),this.B["delete"](f);this.$["delete"](f);this.X["delete"](f);this.xa(a,b);this.fire("routing_paths_count",
this.m.size)}},ra:function(a,b){var d=q([a,b]);this.I.add(d);this.fire("connected",a,b);this.fire("application_connections_count",this.I.size)},xa:function(a,b){var d=q([a,b]);this.I.has(d)&&(this.I["delete"](d),this.fire("disconnected",a,b),this.fire("application_connections_count",this.I.size))},Ga:function(a,b,d){var e,f=this;switch(b){case D:var c=T(d);var g=c[0];var m=c[1];b=c[2];c=c[3];if(h.verify(c,b,g)){var k=q([m,g]);if(e=this.K.get(k))this.K["delete"](k),e(b,c,d);else if(this.f.has(m)&&
C(a,g))this.S(m,D,d);else if(C(m,this.h)){d=this.b.get_connection(g);if(!d){d=this.b.create_connection(!1,g);if(!d)break;d.on("signal",function(b){var c=h.sign(b,f.h,f.L);b=K(f.h,g,b,c);f.S(a,D,b)})}d.signal(b)}}else this.oa(a)}},Ha:function(a,b,d){var e;switch(b){case ja:a=[d.subarray(0,g),d.subarray(g)];b=a[0];d=a[1];if(!this.A.has(b))break;a=this.A.get(b);b=a[0];a=a[1];this.v(b,a,ma,d);break;case Aa:d=this.P(7)||[];d=d.concat(this.ba(10-d.length)||[]);d=q(d);this.T(a,Ba,d);break;case Ba:if(!this.N.has(a))break;
this.N["delete"](a);if(!d.length||0!==d.length%g)break;a=d.length/g;b=this.ma();for(e=0;e<a;++e){var f=e;f=d.subarray(f*g,(f+1)*g);if(!C(f,this.h)&&!this.f.has(f))if(this.c.has(f)||this.c.size<this.a.aware_of_nodes_limit)this.c.set(f,+new Date),this.fire("aware_of_nodes_count",this.c.size);else if(b.length){var c=N(b);this.c["delete"](c);this.c.set(f,+new Date);this.fire("aware_of_nodes_count",this.c.size)}else break}break;case U:this.w.add(Oa(d)),this.ja.add(a)}},S:function(a,b,d){this.R(a,b,d)},
va:function(a,b,d){this.R(a,b+X,d)},wa:function(a,b){this.R(a,W,b)},T:function(a,b,d){this.R(a,b+V,d)},R:function(a,b,d){function e(c){C(a,c)&&(f.ga(a,!0),f.b.send(a,b,d))}var f=this;this.f.has(a)?(this.ga(a,!0),this.b.send(a,b,d)):(this.b.on("connected",e),this.g.lookup(a,this.a.lookup_number).then(function(){f.b.off("connected",e)})["catch"](function(){f.b.off("connected",e)}))},fa:function(a,b,d,e){a=q([a,b]);this.m.has(a)&&(b=this.m.get(a),a=b[0],b=b[1],this.v(a,b,d,e))},v:function(a,b,d,e){0===
e.length&&(e=new Uint8Array(1));return this.i.send_data(a,b,d,e)},sa:function(a,b){var d=q([a,b]);if(this.J.has(d)||!this.u.has(d))return!1;this.v(a,b,oa,pa);return!0},ga:function(a){this.W.set(a,+new Date)},Ca:function(a,b,d){return q(this.g.make_mutable_value(a,b,parseInt(+new Date/1E3,10),q(d)))},ya:function(a){var b=a.subarray(0,g);a=this.g.verify_value(b,a.subarray(g));return!a||a[1].length%g?null:b},pa:function(a){this.g.put_value(a.subarray(0,g),a.subarray(g),this.a.lookup_number)},Ba:function(a){return this.g.get_value(a,
this.a.lookup_number).then(function(a){var b;if(0!==a.length%g)throw"";var e=[];var f=0;for(b=a.length/g;f<b;++f){var c=f;e.push(a.subarray(c*g,(c+1)*g))}return e})},oa:function(a){this.g.del_peer(a);this.b.destroy_connection(a)}};r.prototype=Object.assign(Object.create(L.prototype),r.prototype);Object.defineProperty(r.prototype,"constructor",{value:r});return{ready:function(a){h.ready(function(){p.ready(function(){z.ready(function(){a()})})})},generate_seed:function(){return aa(g)},Core:r}}var W,
D;var X=10;var Ia=W=20;var V=21;var ja=D=0;var Aa=1;var Ba=2;var U=3;var da=0;var ea=1;var fa=2;var ia=3;var ma=4;var ka=5;var la=6;var Z=7;var oa=8;var g=32;var n=64;var G=48;var La=16;var M=64;var Ha={CONNECTION_TIMEOUT:10,LAST_USED_TIMEOUT:60,ANNOUNCE_INTERVAL:300,STALE_AWARE_OF_NODE_TIMEOUT:300,GET_MORE_AWARE_OF_NODES_INTERVAL:30,RANDOM_LOOKUPS_INTERVAL:60,ROUTING_PATH_SEGMENT_TIMEOUT:10};var ha=0;var Y=1;var ra=2;var sa=3;var S=4;var ta=5;var ua=0;var va=1;var wa=2;var xa=0;var ya=1;var za=2;
"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht @detox/routing @detox/transport @detox/utils fixed-size-multiplexer async-eventer".split(" "),H):"object"===typeof exports?module.exports=H(require("@detox/crypto"),require("@detox/dht"),require("@detox/routing"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("node-fetch")):this.detox_core=H(this.detox_crypto,this.detox_dht,this.detox_routing,this.detox_transport,
this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);