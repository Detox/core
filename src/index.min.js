/*
 0BSD
*/
(function(){function Z(f,l){var k=new Uint8Array(f.length+p);k.set(f);k.set(l,f.length);return k}function I(k,l,y,v){var m=new Uint8Array(2*f+y.length+p);m.set(k);m.set(l,f);m.set(y,2*f);m.set(v,2*f+y.length);return m}function R(k){return[k.subarray(0,f),k.subarray(f,2*f),k.subarray(2*f,k.length-p),k.subarray(k.length-p)]}function Ba(k){var l;var y=k[0];var v=k.subarray(1,1+f);var m=[];k=k.subarray(1+f);var p=0;for(l=k.length/f;p<l;++p){var J=p;m.push(k.subarray(J*f,(J+1)*f))}return[y,v,m]}function Ca(k,
p,y,v,m,C){var l=new Uint8Array(3*f+F+K+f);l.set(k);l.set(p,f);l.set(y,2*f);l.set(v,3*f);l.set(m,3*f+F);l.set(C,3*f+F+K);return l}function Da(k,l,p,v){var m=new Uint8Array(3*f+v.length);m.set(k);m.set(l,f);m.set(p,2*f);m.set(v,3*f);return m}function Ea(k,l,y){var v=new Uint8Array(p+f+F);v.set(k);v.set(l,p);v.set(y,p+f);return v}function aa(k){return[k.subarray(0,p),k.subarray(p,p+f),k.subarray(p+f)]}function Fa(k,l){var p=new Uint8Array(f+l.length);p.set(k);p.set(l,f);return p}function G(k,l,y,v,
m,G,J,N){function O(a){return k.create_keypair(a)}function q(a,c,b,e,h,g){var d=this;null==e&&(e=1);null==h&&(h=2);null==g&&(g={});if(!(this instanceof q))return new q(a,c,b,e,h,g);J.call(this);this.a=Object.assign({state_history_size:1E3,values_cache_size:1E3,fraction_of_nodes_from_same_peer:.2,lookup_number:Math.max(h,5),max_pending_segments:10,aware_of_nodes_limit:1E3,min_number_of_peers_for_ready:h,connected_nodes_limit:50},g,{timeouts:Object.assign({},Ga,g.timeouts||{})});this.o=w();this.b=O(a);
this.N=v.MAX_DATA_SIZE;this.Fa=v.MAX_COMPRESSED_DATA_SIZE;this.w=new Set(c);this.ha=x();this.G=x();this.l=w();this.g=x();this.Z=x();this.K=w();this.f=w();this.M=x();this.u=w();this.m=w();this.s=w();this.V=w();this.aa=w();this.D=w();this.A=w();this.C=w();this.J=x();this.B=w();this.Y=w();this.W=w();this.F=w();this.I=x();this.wa=P(this.a.timeouts.LAST_USED_TIMEOUT,function(){var a=+new Date-1E3*d.a.timeouts.LAST_USED_TIMEOUT;d.aa.forEach(function(c,b){if(c<a){if(d.u.has(b)){var e=d.u.get(b);c=e[0];e=
e[1];d.ra(c,e)}d.aa["delete"](b)}});d.V.forEach(function(c,b){c<a&&(d.V["delete"](b),d.c.destroy_connection(b))});var c=+new Date-2E3*d.a.timeouts.STALE_AWARE_OF_NODE_TIMEOUT;d.f.forEach(function(a,b){if(a<c)d.f["delete"](b)})});this.Ea=P(this.a.timeouts.LAST_USED_TIMEOUT/5*4,function(){d.o.forEach(function(a,c){var b=a[1];var e=a[3];a=a[4];e.size<b&&a&&(b=+new Date-3*d.a.timeouts.CONNECTION_TIMEOUT,a<b&&d.ga(c));e.forEach(function(a){a=r([c,a]);var b=d.m.get(a);a=b[0];b=b[1];d.qa(a,b)&&(a=r([a,b]),
d.J.add(a))})})});this.Ba=P(this.a.timeouts.GET_MORE_AWARE_OF_NODES_INTERVAL,function(){d.Ga()&&d.za()});this.c=v.Transport(this.b.ed25519["public"],b,e,Ia,this.a.timeouts.CONNECTION_TIMEOUT).on("connected",function(a){d.h.add_peer(a);d.g.add(a);d.f["delete"](a);d.fire("aware_of_nodes_count",d.f.size);d.fire("connected_nodes_count",d.g.size);d.j&&d.S(a,S,Ja(d.j));if(d.g.size>d.a.connected_nodes_limit){var c=[];var b=x();d.C.forEach(function(a){b.add(a[0])});d.g.forEach(function(e){B(a,e)||d.G.has(e)||
b.has(e)||d.Z.has(e)||c.push(e)});if(c.length){var e=L(c);d.c.destroy_connection(e)}}}).on("disconnected",function(a){d.h.del_peer(a);d.g["delete"](a);d.Z["delete"](a);d.fire("connected_nodes_count",d.g.size);d.M["delete"](a)}).on("data",function(a,c,b){d.U(a,!1);c>=T?d.j&&c!==S||d.Da(a,c-T,b):c===U?d.j||d.i.process_packet(a,b):c>=V?d.h.receive(a,c-V,b):d.j&&c!==C||d.Ca(a,c,b)});this.h=l.DHT(this.b.ed25519["public"],h,this.a.state_history_size,this.a.values_cache_size,this.a.fraction_of_nodes_from_same_peer,
this.a.timeouts).on("peer_error",function(a){d.ma(a)}).on("peer_warning",function(){}).on("connect_to",function(a,c){return new Promise(function(b,e){function f(){e()}if(d.g.has(a))b();else{var g=d.c.get_connection(a);if(!g){g=d.c.create_connection(!0,a);if(!g){e();return}g.on("signal",function(b){var e=k.sign(b,d.b.ed25519["public"],d.b.ed25519["private"]);b=I(d.b.ed25519["public"],a,b,e);d.R(c,C,b)})}g.once("connected",function(){g.off("disconnected",f);b()}).once("disconnected",f)}})}).on("send",
function(a,c,b){d.Ha(a,c,b)}).on("peer_updated",function(a,c){var b;d.Z.add(a);a=0;for(b=c.length;a<b;++a){var e=c[a];d.g.has(e)||d.f.set(e,+new Date)}});this.i=y.Router(this.b.x25519["private"],this.a.max_pending_segments,this.a.timeouts.ROUTING_PATH_SEGMENT_TIMEOUT).on("activity",function(a,c){var b=r([a,c]);d.u.has(b)||d.u.set(b,[a,c]);d.aa.set(b,+new Date)}).on("send",function(a,c){d.sa(a,c)}).on("data",function(a,c,b,e){var g;var h=r([a,c]);switch(b){case ca:var t=d.ua(e);if(!t)break;d.A.has(t)&&
clearInterval(d.A.get(t)[2]);b=P(d.a.timeouts.ANNOUNCE_INTERVAL,function(){d.u.has(h)&&d.na(e)});d.A.set(t,[a,c,b]);d.na(e);break;case da:var n=e;if(n.length!==f)break;var m=function(b,e){var g=n,h;var t=h=new Uint8Array(1+f+e.length*f);t.set([b]);t.set(g,1);b=0;for(g=e.length;b<g;++b){t=b;var k=e[b];h.set(k,1+f+t*f)}d.v(a,c,ea,h)};d.xa(n).then(function(a){a.length?m(fa,a):m(W,[])})["catch"](function(a){H(a);m(W,[])});break;case ha:var u=[e.subarray(0,f),e.subarray(f,2*f),e.subarray(2*f,3*f),e.subarray(3*
f)];var z=u[0];b=u[1];n=u[2];t=u[3];if(d.D.has(z))break;var l=M(d.a.timeouts.CONNECTION_TIMEOUT,function(){d.D["delete"](z)});d.D.set(z,[a,c,n,l]);d.S(b,ia,Fa(n,t));break;case ja:u=aa(e);t=u[0];z=u[1];var ba=u[2];l=d.D.get(z);if(!l)break;b=l[0];var E=l[1];n=l[2];l=l[3];if(!k.verify(t,z,n))break;d.D["delete"](z);clearTimeout(l);d.v(b,E,ka,e);t=r([b,E]);d.C.set(h,[b,E]);d.C.set(t,[a,c]);break;case la:b=d.s.get(h);if(!b)break;var A=b[0];b=b[1];if(!d.o.has(A))break;u=d.o.get(A);var q=u[0];var Ha=u[3];
if(!Ha.has(b))break;try{l=k.one_way_decrypt(q.x25519["private"],e);t=l.subarray(0,p);E=l.subarray(p);u=[E.subarray(0,f),E.subarray(f,2*f),E.subarray(2*f,3*f),E.subarray(3*f,3*f+F),E.subarray(3*f+F,3*f+F+K),E.subarray(3*f+F+K,3*f+F+K+f)];n=u[0];var v=u[1];z=u[2];ba=u[3];var w=u[4];var B=u[5];var y=r([b,E]);if(k.verify(t,y,n)){var D=r([A,n]);if(!d.m.has(D)){if(d.l.has(D)){var x=d.l.get(D);if(x.T&&!x.H){var C=0;for(g=A.length;C<g;++C){var G=C;var ma=A[C];if(ma!==n[G]){if(ma>n[G])return;x.H=!0;break}}}}else x=
{T:!1},d.l.set(D,x);e={real_public_key:A,target_id:n,secret:B,application:w,number_of_intermediate_nodes:null};d.fire("introduction",e).then(function(){var a=e.number_of_intermediate_nodes;if(null===a)throw"No event handler for introduction";if(!a)throw Error("Direct connections are not yet supported");if(a=d.da(a,[v])){a.push(v);var c=a[0];d.ca(a).then(function(a){var b=k.Encryptor(!1,q.x25519["private"]);b.put_handshake_message(ba);var e=b.get_handshake_message();d.B.set(D,b);d.ea(A,n,c,a);d.l["delete"](D);
d.pa(A,n);a=k.sign(z,A,q.ed25519["private"]);d.ba(A,n,ja,Ea(a,z,e))})["catch"](function(a){H(a);d.l["delete"](D);x.T&&x.H&&d.fire("connection_failed",A,n,Q)})}})["catch"](function(a){H(a);d.l["delete"](D);x.T&&x.H&&d.fire("connection_failed",A,n,Q)})}}}catch(Ka){t=Ka,H(t)}break;case X:if(d.C.has(h))u=d.C.get(h),b=u[0],E=u[1],d.v(b,E,X,e);else if(d.s.has(h)&&(u=d.s.get(h),A=u[0],n=u[1],D=r([A,n]),b=d.B.get(D))&&(t=d.W.get(D)))for(b=b.decrypt(e),t.feed(b);t.have_more_data();)l=t.get_data(),b=l[0],d.fire("data",
A,n,b,l.subarray(1));break;case na:if(d.s.has(h)&&d.J.has(h))d.J["delete"](h);else d.qa(a,c)}});this.la=this.i.get_max_packet_data_size()-La;if(this.w.size)this.h.once("peer_updated",function(){d.fire("ready")});else setTimeout(function(){d.fire("ready")});this.L()}null==N&&(N=window.fetch);var Ma=m.hex2array;var Na=m.array2hex;var Ja=m.string2array;var Oa=m.array2string;var Y=m.random_bytes;var Pa=m.random_int;var L=m.pull_random_item_from_array;var B=m.are_arrays_equal;var r=m.concat_arrays;var M=
m.timeoutSet;var P=m.intervalSet;var H=m.error_handler;var w=m.ArrayMap;var x=m.ArraySet;var Qa=m.sample;var oa=new Uint8Array(0);var pa=new Uint8Array(f);q.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=qa;q.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ra;q.CONNECTION_ERROR_NO_INTRODUCTION_NODES=W;q.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=Q;q.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=sa;q.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ta;q.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=
ua;q.CONNECTION_PROGRESS_INTRODUCTION_SENT=va;q.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=wa;q.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=xa;q.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ya;q.prototype={start_bootstrap_node:function(a,c,b,e,h){var g=this;null==e&&(e=c);null==h&&(h=b);var d=k.create_keypair(a).ed25519;this.X=require("http").createServer(function(a,c){c.setHeader("Access-Control-Allow-Origin","*");c.setHeader("Connection","close");var b=a.headers["content-length"];
if("POST"===a.method&&b&&b<=g.Fa){var e=[];a.on("data",function(a){e.push(a)}).on("end",function(){var a;e=r(e);var b=R(e);var h=b[0];var f=b[1];var n=b[2];var u=b[3];if(k.verify(u,n,h)&&B(f,pa))if(g.g.size&&Pa(0,g.g.size)?a=null!=(b=g.O(1))?b[0]:void 0:a=null,a){var l=r([h,a]);if(g.K.has(l))c.writeHead(503),c.end();else{n=I(h,a,n,u);g.R(a,C,n);g.K.set(l,function(b,e,h){clearTimeout(m);k.verify(e,b,a)?(b=Z(h,k.sign(h,d["public"],d["private"])),c.write(Buffer.from(b))):c.writeHead(502);c.end()});var m=
M(g.a.timeouts.CONNECTION_TIMEOUT,function(){g.K["delete"](l);c.writeHead(504);c.end()})}}else(b=g.c.create_connection(!1,h))?b.once("signal",function(a){var b=k.sign(a,g.b.ed25519["public"],g.b.ed25519["private"]);a=I(g.b.ed25519["public"],h,a,b);a=Z(a,k.sign(a,d["public"],d["private"]));c.write(Buffer.from(a));c.end();return!1}).signal(n):(c.writeHead(503),c.end());else c.writeHead(400),c.end()})}else c.writeHead(400),c.end()});this.X.on("error",H).listen(b,c,function(){var a=Na(d["public"]);g.j=
a+":"+e+":"+h});this.ia()},get_bootstrap_nodes:function(){return Array.from(this.w)},va:function(a){function c(){--b;b||"function"==typeof a&&a()}var b,e=this;(b=this.w.size)?this.w.forEach(function(a){function b(){c()}var d;a=a.split(":");var h=Ma(a[0]);var n=a[1]+":"+a[2];var l=Y(f);if(d=e.c.create_connection(!0,l))d.on("signal",function(a){var c=k.sign(a,e.b.ed25519["public"],e.b.ed25519["private"]);var b={method:"POST",headers:{Connection:"close"},body:I(e.b.ed25519["public"],pa,a,c).buffer};
N("https://"+n,b)["catch"](function(a){if("undefined"===typeof location||"http:"===location.protocol)return N("http://"+n,b);throw a;}).then(function(a){if(!a.ok)throw"Request failed, status code "+a.status;return a.arrayBuffer()}).then(function(a){return new Uint8Array(a)}).then(function(a){a=[a.subarray(0,a.length-p),a.subarray(a.length-p)];var c=a[0];a=a[1];if(!k.verify(a,c,h))throw"Bad bootstrap node response";a=R(c);c=a[0];var b=a[1];var g=a[2];a=a[3];if(!k.verify(a,g,c)||!B(b,e.b.ed25519["public"]))throw"Bad response";
if(e.c.get_connection(c))throw"Already connected";e.c.update_peer_id(l,c);d.signal(g)})["catch"](function(){d.destroy()})}).once("connected",function(){d.off("disconnected",b);c()}).once("disconnected",b)}):"function"==typeof a&&a()},announce:function(a,c,b){if(this.j)return null;a=O(a);var e=a.ed25519["public"];if(this.o.has(e))return null;this.o.set(e,[a,c,b,x()]);this.ga(e);return e},ga:function(a){function c(c){var b;c&&p.push(c);--r;if(!r)if(p.length){p=p.concat(m);var e=h.ya(a,d.ed25519["private"],
p);var f=0;for(b=p.length;f<b;++f)c=p[f],h.ba(a,c,ca,e);h.fire("announced",a)}else h.fa(a,1),h.fire("announcement_failed",a,xa)}function b(b){var d,f=this;if(d=this.da(k,e.concat(m))){d.push(b);var h=d[0];this.ca(d).then(function(d){f.ea(a,b,h,d);l.add(b);c(b)})["catch"](function(a){H(a);c()})}else this.fire("announcement_failed",a,ya)}var e,h=this;var g=this.o.get(a);var d=g[0];var f=g[1];var k=g[2];var l=g[3];var m=[];l.forEach(function(a){m.push(a)});if(f-=m.length)if(this.fa(a,+new Date),e=this.$(f,
m)){var r=f;var p=[];g=0;for(f=e.length;g<f;++g)b.call(this,e[g])}else this.fa(a,1),this.fire("announcement_failed",a,wa)},fa:function(a,c){this.o.get(a)[4]=c},connect_to:function(a,c,b,e,h){function g(a){if(!p.H){d.l["delete"](m);if(q)d.G["delete"](q);d.fire("connection_failed",n,c,a)}}var d=this;if(this.j)return null;if(!h)throw Error("Direct connections are not yet supported");var l=O(a);var n=l.ed25519["public"];if(B(n,c))return null;var m=r([n,c]);if(this.l.has(m))return n;var p={T:!0,H:!1};
this.l.set(m,p);if(this.m.has(m))return null;a=this.da(h);if(!a)return g(ra),null;var q=a[0];var x=a[a.length-1];this.ca(a).then(function(a){function h(h,z,v,w){function u(){function h(b,e,f,g){B(q,b)&&B(a,e)&&f===ka&&(f=aa(g),b=f[0],e=f[1],f=f[2],B(e,t)&&k.verify(b,t,c)&&(w.put_handshake_message(f),d.B.set(m,w),clearTimeout(C),d.i.off("data",h),d.ea(n,c,q,a),d.l["delete"](m),d.pa(n,c)))}if(!p.H)if(A.length){var z=L(A);var t=Y(f);var v=k.convert_public_key(c);var w=k.Encryptor(!0,v);var y=w.get_handshake_message();
y=Ca(n,x,t,y,b,e);var D=r([z,y]);D=k.sign(D,n,l.ed25519["private"]);y=r([D,y]);v=k.one_way_encrypt(v,y);d.i.on("data",h);d.v(q,a,ha,Da(t,z,c,v));d.fire("connection_progress",n,c,va);var C=M(d.a.timeouts.CONNECTION_TIMEOUT,function(){d.i.off("data",h);w.destroy();u()})}else g(sa)}if(B(q,h)&&B(a,z)&&v===ea){h=Ba(w);z=h[0];v=h[1];var A=h[2];B(c,v)&&(clearTimeout(t),z!==fa?g(z):(d.fire("connection_progress",n,c,ua),u()))}}d.fire("connection_progress",n,c,ta);d.i.on("data",h);d.v(q,a,da,c);var t=M(d.a.timeouts.CONNECTION_TIMEOUT,
function(){d.i.off("data",h);g(qa)})})["catch"](function(a){H(a);g(Q)});return n},get_max_data_size:function(){return this.N},send_to:function(a,c,b,e){var h,f,d=this;if(!this.j){var k=r([a,c]);!(h=this.B.get(k))||e.length>this.N||!(f=this.Y.get(k))||(b=r([[b],e]),f.feed(b),this.F.has(k)||this.F.set(k,setTimeout(function(){for(d.F["delete"](k);f.have_more_blocks();){var b=f.get_block();b=h.encrypt(b);d.ba(a,c,X,b)}})))}},destroy:function(){this.ja||(this.ja=!0,this.j?this.X&&this.X.close():this.ia(),
clearTimeout(this.oa),this.c.destroy(),this.h.destroy())},ia:function(){var a=this;clearInterval(this.wa);clearInterval(this.Ea);clearInterval(this.Ba);this.u.forEach(function(c){a.ra(c[0],c[1])});this.D.forEach(function(a){clearTimeout(a[3])});this.i.destroy()},Ga:function(){return!this.j&&!!(this.f.size<this.a.aware_of_nodes_limit||this.ka(!0).length)},ka:function(a){null==a&&(a=!1);var c=[];var b=+new Date-1E3*this.a.timeouts.STALE_AWARE_OF_NODE_TIMEOUT;var e=!1;this.f.forEach(function(f,g){!e&&
f<b&&(c.push(g),a&&!e&&(e=!0))});return c},za:function(){var a,c;if(a=this.O(5)){var b=0;for(c=a.length;b<c;++b){var e=a[b];this.Aa(e)}}},Aa:function(a){this.M.add(a);this.S(a,za,oa)},da:function(a,c){var b;null==c&&(c=[]);c=Array.from(this.G.values()).concat(c);var e=null!=(b=this.O(1,c))?b[0]:void 0;return e?(a=this.$(a-1,c.concat([e])))?[e].concat(a):null:null},O:function(a,c){var b=[];null==a&&(a=1);null==c&&(c=[]);if(!this.g.size)return null;var e=Array.from(this.g.values());var f=x(c.concat(Array.from(this.ha)));
e=e.filter(function(a){return!f.has(a)});if(!e.length)return null;for(c=0;c<a;++c)e.length&&b.push(L(e));return b},$:function(a,c){var b=[];if(this.f.size<a)return null;var e=Array.from(this.f.keys());if(c){var f=x(c);e=e.filter(function(a){return!f.has(a)})}if(e.length<a)return null;for(c=0;c<a;++c)b.push(L(e));return b},L:function(){var a=this;if(!this.ja)if(this.h.get_peers().length<this.w.size&&this.w.size)this.va(function(){a.L()});else{var c=Qa(this.a.timeouts.RANDOM_LOOKUPS_INTERVAL);this.oa=
M(this.oa?c:0,function(){a.h.lookup(O(null).ed25519["public"],a.a.lookup_number).then(function(){a.L()})["catch"](function(){a.L()})})}},ca:function(a){var c=this;var b=a[0];this.G.add(b);a=this.i.construct_routing_path(a);a["catch"](function(a){H(a);c.G["delete"](b)});return a},ea:function(a,c,b,e){var f=r([b,e]);if(!this.s.has(f)){var g=r([a,c]);this.m.set(g,[b,e]);this.s.set(f,[a,c]);this.Y.set(g,G.Multiplexer(this.N,this.la));this.W.set(g,G.Demultiplexer(this.N,this.la));this.fire("routing_paths_count",
this.m.size)}},ra:function(a,c){var b=this;var e=r([a,c]);if(this.u.has(e)&&(this.G["delete"](a),this.u["delete"](e),this.i.destroy_routing_path(a,c),this.C["delete"](e),this.J["delete"](e),this.A.forEach(function(a,c){var d=a[0];var f=a[1];a=a[2];d=r([d,f]);B(e,d)&&(clearInterval(a),b.A["delete"](c))}),this.s.has(e))){c=this.s.get(e);a=c[0];c=c[1];var f=r([a,c]);this.s["delete"](e);this.m["delete"](f);this.F.has(f)&&(clearTimeout(this.F.get(f)),this.F["delete"](f));if(this.o.has(a)){var g=this.o.get(a)[3];
g["delete"](c)}if(g=this.B.get(f))g.destroy(),this.B["delete"](f);this.Y["delete"](f);this.W["delete"](f);this.ta(a,c);this.fire("routing_paths_count",this.m.size)}},pa:function(a,c){var b=r([a,c]);this.I.add(b);this.fire("connected",a,c);this.fire("application_connections_count",this.I.size)},ta:function(a,c){var b=r([a,c]);this.I.has(b)&&(this.I["delete"](b),this.fire("disconnected",a,c),this.fire("application_connections_count",this.I.size))},Ca:function(a,c,b){var e,f=this;switch(c){case C:var g=
R(b);var d=g[0];var l=g[1];c=g[2];g=g[3];if(k.verify(g,c,d)){var m=r([l,d]);if(e=this.K.get(m))this.K["delete"](m),e(c,g,b);else if(this.g.has(l)&&B(a,d))this.R(l,C,b);else if(B(l,this.b.ed25519["public"])){b=this.c.get_connection(d);if(!b){b=this.c.create_connection(!1,d);if(!b)break;b.on("signal",function(b){var c=k.sign(b,f.b.ed25519["public"],f.b.ed25519["private"]);b=I(f.b.ed25519["public"],d,b,c);f.R(a,C,b)})}b.signal(c)}}else this.ma(a)}},Da:function(a,c,b){var e;switch(c){case ia:a=[b.subarray(0,
f),b.subarray(f)];c=a[0];b=a[1];if(!this.A.has(c))break;a=this.A.get(c);c=a[0];a=a[1];this.v(c,a,la,b);break;case za:b=this.O(7)||[];b=b.concat(this.$(10-b.length)||[]);b=r(b);this.S(a,Aa,b);break;case Aa:if(!this.M.has(a))break;this.M["delete"](a);if(!b.length||0!==b.length%f)break;a=b.length/f;c=this.ka();for(e=0;e<a;++e){var h=e;h=b.subarray(h*f,(h+1)*f);if(!B(h,this.b.ed25519["public"])&&!this.g.has(h))if(this.f.has(h)||this.f.size<this.a.aware_of_nodes_limit)this.f.set(h,+new Date),this.fire("aware_of_nodes_count",
this.f.size);else if(c.length){var g=L(c);this.f["delete"](g);this.f.set(h,+new Date);this.fire("aware_of_nodes_count",this.f.size)}else break}break;case S:this.w.add(Oa(b)),this.ha.add(a)}},R:function(a,c,b){this.P(a,c,b)},Ha:function(a,c,b){this.P(a,c+V,b)},sa:function(a,c){this.P(a,U,c)},S:function(a,c,b){this.P(a,c+T,b)},P:function(a,c,b){function e(e){B(a,e)&&(f.U(a,!0),f.c.send(a,c,b))}var f=this;this.g.has(a)?(this.U(a,!0),this.c.send(a,c,b)):(this.c.on("connected",e),this.h.lookup(a,this.a.lookup_number).then(function(){f.c.off("connected",
e)})["catch"](function(){f.c.off("connected",e)}))},ba:function(a,c,b,e){a=r([a,c]);this.m.has(a)&&(c=this.m.get(a),a=c[0],c=c[1],this.v(a,c,b,e))},v:function(a,c,b,e){0===e.length&&(e=new Uint8Array(1));return this.i.send_data(a,c,b,e)},qa:function(a,c){var b=r([a,c]);if(this.J.has(b)||!this.u.has(b))return!1;this.v(a,c,na,oa);return!0},U:function(a){this.V.set(a,+new Date)},ya:function(a,c,b){return r(this.h.make_mutable_value(a,c,parseInt(+new Date/1E3,10),r(b)))},ua:function(a){var c=a.subarray(0,
f);a=this.h.verify_value(c,a.subarray(f));return!a||a[1].length%f?null:c},na:function(a){this.h.put_value(a.subarray(0,f),a.subarray(f),this.a.lookup_number)},xa:function(a){return this.h.get_value(a,this.a.lookup_number).then(function(a){var b;if(0!==a.length%f)throw"";var c=[];var h=0;for(b=a.length/f;h<b;++h){var g=h;c.push(a.subarray(g*f,(g+1)*f))}return c})},ma:function(a){this.h.del_peer(a);this.c.destroy_connection(a)}};q.prototype=Object.assign(Object.create(J.prototype),q.prototype);Object.defineProperty(q.prototype,
"constructor",{value:q});return{ready:function(a){k.ready(function(){l.ready(function(){y.ready(function(){a()})})})},generate_seed:function(){return Y(f)},Core:q}}var U,C;var V=10;var Ia=U=20;var T=21;var ia=C=0;var za=1;var Aa=2;var S=3;var ca=0;var da=1;var ea=2;var ha=3;var la=4;var ja=5;var ka=6;var X=7;var na=8;var f=32;var p=64;var F=48;var La=16;var K=64;var Ga={CONNECTION_TIMEOUT:10,LAST_USED_TIMEOUT:60,ANNOUNCE_INTERVAL:300,STALE_AWARE_OF_NODE_TIMEOUT:300,GET_MORE_AWARE_OF_NODES_INTERVAL:30,
RANDOM_LOOKUPS_INTERVAL:60,ROUTING_PATH_SEGMENT_TIMEOUT:10};var fa=0;var W=1;var qa=2;var ra=3;var Q=4;var sa=5;var ta=0;var ua=1;var va=2;var wa=0;var xa=1;var ya=2;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht @detox/routing @detox/transport @detox/utils fixed-size-multiplexer async-eventer".split(" "),G):"object"===typeof exports?module.exports=G(require("@detox/crypto"),require("@detox/dht"),require("@detox/routing"),require("@detox/transport"),require("@detox/utils"),
require("fixed-size-multiplexer"),require("async-eventer"),require("node-fetch")):this.detox_core=G(this.detox_crypto,this.detox_dht,this.detox_routing,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);