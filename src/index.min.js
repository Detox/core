/*
 0BSD
*/
(function(){function ua(n){var q;var m=n[0];var x=n.subarray(1,1+d);var v=[];n=n.subarray(1+d);var g=0;for(q=n.length/d;g<q;++g){var p=g;v.push(n.subarray(p*d,(p+1)*d))}return[m,x,v]}function va(n,q,m,x,v,g){var p=new Uint8Array(3*d+C+I+d);p.set(n);p.set(q,d);p.set(m,2*d);p.set(x,3*d);p.set(v,3*d+C);p.set(g,3*d+C+I);return p}function wa(n,q,m,x){var v=new Uint8Array(3*d+x.length);v.set(n);v.set(q,d);v.set(m,2*d);v.set(x,3*d);return v}function xa(n,q,m){var x=new Uint8Array(E+d+C);x.set(n);x.set(q,
E);x.set(m,E+d);return x}function U(n){return[n.subarray(0,E),n.subarray(E,E+d),n.subarray(E+d)]}function ya(n,q){var m=new Uint8Array(d+q.length);m.set(n);m.set(q,d);return m}function J(n,q,m,x,v){function g(a,b,f,w,h,k,l){var c=this;null==w&&(w=1);null==h&&(h=2);null==k&&(k=10);null==l&&(l={});if(!(this instanceof g))return new g(a,b,f,w,h,k,l);v.call(this);this.i=r();this.F=n.create_keypair(a);this.I=q.MAX_DATA_SIZE;this.f=r();this.l=A();this.c=r();this.H=A();this.j=r();this.h=r();this.g=r();this.A=
r();this.D=r();this.P=r();this.o=r();this.m=r();this.G=r();this.w=A();this.u=r();this.M=r();this.L=r();this.v=r();this.B=A();this.ga=L(R,function(){var a=+new Date-1E3*R;c.P.forEach(function(b,e){if(b<a){if(c.j.has(e)){var d=c.j.get(e);b=d[0];d=d[1];c.W(b,d)}c.P["delete"](e)}});c.D.forEach(function(b,e){b<a&&(c.Y(e),c.D["delete"](e))})});this.ka=L(R,function(){c.i.forEach(function(a,b){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*M,a<e&&c.X(b));d.forEach(function(a){a=t([b,a]);var e=c.h.get(a);
a=e[0];e=e[1];c.ea(a,e)&&(a=t([a,e]),c.w.add(a))})})});this.ja=L(Aa,function(){c.ca()&&c.ia()});this.b=q.DHT(this.F.ed25519["public"],this.F.ed25519["private"],b,f,w,h,l).on("node_connected",function(a){c.l.add(a);c.c["delete"](a);c.fire("aware_of_nodes_count",c.c.size);c.fire("connected_nodes_count",c.l.size);var b=J(a);if(c.ca()){var e=c.get_bootstrap_nodes().map(function(a){return a.node_id});Ba(b,e)||c.$(a)}}).on("node_disconnected",function(a){c.l["delete"](a);c.fire("connected_nodes_count",
c.l.size);c.H["delete"](a)}).on("data",function(a,b,e){var w;switch(b){case V:c.a.process_packet(a,e);break;case W:b=[e.subarray(0,d),e.subarray(d)];var f=b[0];e=b[1];if(!c.m.has(f))break;b=c.m.get(f);f=b[0];b=b[1];c.a.send_data(f,b,X,e);break;case Y:var k=c.O(7)||[];k=k.concat(c.N(10-k.length)||[]);e=new Uint8Array(k.length*d);b=0;for(w=k.length;b<w;++b){f=b;var l=k[b];e.set(l,f*d)}c.J(a,Z,e);break;case Z:if(c.H.has(a)&&(c.H["delete"](a),e.length&&0===e.length%d))for(a=e.length/d,k=c.aa(),b=0;b<
a;++b)if(f=b,f=e.subarray(f*d,(f+1)*d),!D(f,c.F.ed25519["public"])&&!c.l.has(f))if(c.c.has(f)||c.c.size<aa)c.c.set(f,+new Date),c.fire("aware_of_nodes_count",c.c.size);else if(k.length)w=N(k),c.c["delete"](w),c.c.set(f,+new Date),c.fire("aware_of_nodes_count",c.c.size);else break}}).on("ready",function(){c.b.lookup(p(d));c.b.lookup(p(d));c.b.lookup(p(d));c.fire("ready")});this.a=q.Router(this.F.x25519["private"],k).on("activity",function(a,b){var e=t([a,b]);c.j.has(e)||c.j.set(e,[a,b]);c.S(a);c.P.set(e,
+new Date)}).on("send",function(a,b){c.J(a,V,b)}).on("data",function(a,b,e,f){var w,k;var l=t([a,b]);switch(e){case ba:var h=c.b.verify_announcement_message(f);if(!h)break;c.m.has(h)&&clearInterval(c.m.get(h)[2]);e=L(Ca,function(){c.j.has(l)&&c.b.publish_announcement_message(f)});c.m.set(h,[a,b,e]);c.b.publish_announcement_message(f);break;case ca:var u=f;if(u.length!==d)break;var m=function(e,f){var w=u,h;var k=h=new Uint8Array(1+d+f.length*d);k.set([e]);k.set(w,1);e=0;for(w=f.length;e<w;++e){k=
e;var l=f[e];h.set(l,1+d+k*d)}c.a.send_data(a,b,da,h)};c.b.find_introduction_nodes(u,function(a){a.length?m(ea,a):m(S,[])},function(){m(S,[])});break;case fa:e=[f.subarray(0,d),f.subarray(d,2*d),f.subarray(2*d,3*d),f.subarray(3*d)];var y=e[0];var g=e[1];u=e[2];h=e[3];if(c.o.has(y))break;e=O(M,function(){c.o["delete"](y)});c.o.set(y,[a,b,u,e]);c.J(g,W,ya(u,h));break;case ha:e=U(f);h=e[0];y=e[1];var q=e[2];if(!c.o.has(y))break;e=c.o.get(y);g=e[0];var p=e[1];u=e[2];e=e[3];if(!n.verify(h,y,u))break;c.o["delete"](y);
clearTimeout(e);c.a.send_data(g,p,ia,f);h=t([g,p]);c.G.set(l,[g,p]);c.G.set(h,[a,b]);break;case X:if(!c.g.has(l))break;e=c.g.get(l);var B=e[0];g=e[1];if(!c.i.has(B))break;e=c.i.get(B);var x=e[0];var r=e[3];if(!r.has(g))break;try{p=n.one_way_decrypt(x.x25519["private"],f);h=p.subarray(0,E);var F=p.subarray(E);e=[F.subarray(0,d),F.subarray(d,2*d),F.subarray(2*d,3*d),F.subarray(3*d,3*d+C),F.subarray(3*d+C,3*d+C+I),F.subarray(3*d+C+I,3*d+C+I+d)];u=e[0];var v=e[1];y=e[2];q=e[3];var D=e[4];var za=e[5];
var H=w=new Uint8Array(d+F.length);H.set(g);H.set(F,d);if(n.verify(h,w,u)){var z=t([B,u]);if(!c.h.has(z)){if(c.f.has(z)){var G=c.f.get(z);if(G.K&&!G.s){var P=0;for(k=B.length;P<k;++P){var A=P;var ja=B[P];if(ja!==u[A]){if(ja>u[A])return;G.s=!0;break}}}}else G={K:!1},c.f.set(z,G);f={real_public_key:B,target_id:u,secret:za,application:D,number_of_intermediate_nodes:null};c.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=c.U(a,[v])){a.push(v);var b=a[0];c.a.construct_routing_path(a).then(function(a){var e=n.Encryptor(!1,x.x25519["private"]);e.put_handshake_message(q);var f=e.get_handshake_message();c.u.set(z,e);c.V(B,u,b,a);c.f["delete"](z);c.da(B,u);a=n.sign(y,B,x.ed25519["private"]);c.R(B,u,ha,xa(a,y,f))})["catch"](function(a){K(a);c.f["delete"](z);G.K&&G.s&&c.fire("connection_failed",B,u,Q)})}})["catch"](function(a){K(a);c.f["delete"](z);G.K&&G.s&&c.fire("connection_failed",B,u,Q)})}}}catch(Da){h=Da,K(h)}break;
case T:if(c.G.has(l))e=c.G.get(l),g=e[0],p=e[1],c.a.send_data(g,p,T,f);else if(c.g.has(l)&&(e=c.g.get(l),B=e[0],u=e[1],z=t([B,u]),e=c.u.get(z))&&(h=c.L.get(z)))for(e=e.decrypt(f),h.feed(e);h.have_more_data();)g=h.get_data(),e=g[0],c.fire("data",B,u,e,g.subarray(1));break;case ka:if(c.g.has(l)&&c.w.has(l))c.w["delete"](l);else c.ea(a,b)}});this.ba=this.a.get_max_packet_data_size()-Ea}var p=m.random_bytes;var N=m.pull_random_item_from_array;var D=m.are_arrays_equal;var J=m.array2hex;var Fa=m.hex2array;
var t=m.concat_arrays;var O=m.timeoutSet;var L=m.intervalSet;var K=m.error_handler;var r=m.ArrayMap;var A=m.ArraySet;g.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=la;g.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ma;g.CONNECTION_ERROR_NO_INTRODUCTION_NODES=S;g.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=Q;g.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=na;g.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=oa;g.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=pa;g.CONNECTION_PROGRESS_INTRODUCTION_SENT=
qa;g.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=ra;g.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=sa;g.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ta;g.prototype={start_bootstrap_node:function(a,b,f,d){null==f&&(f=a);null==d&&(d=b);this.b.start_bootstrap_node(a,b,f,d);this.C=!0;this.Z()},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,b,f){if(this.C)return null;a=n.create_keypair(a);var d=a.ed25519["public"];if(this.i.has(d))return null;this.i.set(d,
[a,b,f,A()]);this.X(d);return d},X:function(a){function b(b){var c;b&&p.push(b);--m;if(!m)if(p.length){p=p.concat(e);var f=h.b.generate_announcement_message(a,l.ed25519["private"],p);var d=0;for(c=p.length;d<c;++d)b=p[d],h.R(a,b,ba,f);h.fire("announced",a)}else h.T(a,1),h.fire("announcement_failed",a,sa)}function f(c){var f,h=this;if(f=this.U(g,d.concat(e))){f.push(c);var k=f[0];this.a.construct_routing_path(f).then(function(e){h.V(a,c,k,e);n.add(c);b(c)})["catch"](function(a){K(a);b()})}else this.fire("announcement_failed",
a,ta)}var d,h=this;var k=this.i.get(a);var l=k[0];var c=k[1];var g=k[2];var n=k[3];var e=[];n.forEach(function(a){e.push(a)});if(c-=e.length)if(this.T(a,+new Date),d=this.N(c,e)){var m=c;var p=[];k=0;for(c=d.length;k<c;++k)f.call(this,d[k])}else this.T(a,1),this.fire("announcement_failed",a,ra)},T:function(a,b){this.i.get(a)[4]=b},connect_to:function(a,b,f,w,h){function k(a){e.s||(l.f["delete"](m),l.fire("connection_failed",g,b,a))}var l=this;if(this.C)return null;if(!h)throw Error("Direct connections are not yet supported");
var c=n.create_keypair(a);var g=c.ed25519["public"];if(D(g,b))return null;var m=t([g,b]);if(this.f.has(m))return g;var e={K:!0,s:!1};this.f.set(m,e);if(this.h.has(m))return null;a=this.U(h);if(!a)return k(ma),null;var q=a[0];var x=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function h(h,r,t,v){function u(){function h(c,e,f,d){D(q,c)&&D(a,e)&&f===ia&&(f=U(d),c=f[0],e=f[1],f=f[2],D(e,v)&&n.verify(c,v,b)&&(C.put_handshake_message(f),l.u.set(m,C),clearTimeout(G),l.a.off("data",h),
l.V(g,b,q,a),l.f["delete"](m),l.da(g,b)))}var y,r;if(!e.s)if(F.length){var t=N(F);var v=p(d);var A=n.convert_public_key(b);var C=n.Encryptor(!0,A);var H=C.get_handshake_message();H=va(g,x,v,H,f,w);var z=y=new Uint8Array(d+H.length);z.set(t);z.set(H,d);z=n.sign(y,g,c.ed25519["private"]);y=r=new Uint8Array(H.length+E);y.set(z);y.set(H,E);A=n.one_way_encrypt(A,r);l.a.on("data",h);l.a.send_data(q,a,fa,wa(v,t,b,A));l.fire("connection_progress",g,b,qa);var G=O(M,function(){l.a.off("data",h);C.destroy();
u()})}else k(na)}if(D(q,h)&&D(a,r)&&t===da){h=ua(v);r=h[0];t=h[1];var F=h[2];D(b,t)&&(clearTimeout(y),r!==ea?k(r):(l.fire("connection_progress",g,b,pa),u()))}}l.fire("connection_progress",g,b,oa);l.a.on("data",h);l.a.send_data(q,a,ca,b);var y=O(M,function(){l.a.off("data",h);k(la)})})["catch"](function(a){K(a);k(Q)});return g},get_max_data_size:function(){return this.I},send_to:function(a,b,f,d){var h,k,l,c=this;if(!this.C){var g=t([a,b]);if((h=this.u.get(g))&&!(d.length>this.I)&&(k=this.M.get(g))){var w=
l=new Uint8Array(d.length+1);w.set([f]);w.set(d,1);k.feed(l);this.v.has(g)||this.v.set(g,setTimeout(function(){for(c.v["delete"](g);k.have_more_blocks();){var e=k.get_block();e=h.encrypt(e);c.R(a,b,T,e)}}))}}},destroy:function(){this.ha||(this.C||this.Z(),this.b.destroy(),this.ha=!0)},Z:function(){var a=this;clearInterval(this.ga);clearInterval(this.ka);clearInterval(this.ja);this.D.forEach(function(b,f){a.Y(f)});this.j.forEach(function(b){a.W(b[0],b[1])});this.o.forEach(function(a){clearTimeout(a[3])});
this.a.destroy()},ca:function(){return!this.C&&!!(this.c.size<aa||this.aa(!0).length)},aa:function(a){null==a&&(a=!1);var b=[];var f=+new Date-1E3*Ga;var d=!1;this.c.forEach(function(h,k){!d&&h<f&&(b.push(k),a&&!d&&(d=!0))});return b},ia:function(){var a,b;if(a=this.O(5)){var f=0;for(b=a.length;f<b;++f){var d=a[f];this.$(d)}}},$:function(a){this.H.add(a);this.J(a,Y,new Uint8Array(0))},U:function(a,b){var f;null==b&&(b=[]);var d=null!=(f=this.O(1,b))?f[0]:void 0;return d?(a=this.N(a-1,b.concat([d])))?
[d].concat(a):null:null},O:function(a,b){var f,g,h=[];null==a&&(a=1);null==b&&(b=[]);if(!this.l.size)return this.b.lookup(p(d)),null;var k=Array.from(this.l.values());var l=0;for(g=(f=this.get_bootstrap_nodes()).length;l<g;++l){var c=f[l];b.push(Fa(c.node_id))}var m=A(b);k=k.filter(function(a){return!m.has(a)});if(!k.length)return null;for(l=0;l<a;++l)k.length&&h.push(N(k));return h},N:function(a,b){var d=[];if(this.c.size<a)return null;var g=Array.from(this.c.keys());if(b){var h=A(b);g=g.filter(function(a){return!h.has(a)})}if(g.length<
a)return null;for(b=0;b<a;++b)d.push(N(g));return d},V:function(a,b,d,g){var f=t([d,g]);if(!this.g.has(f)){var k=t([a,b]);this.h.set(k,[d,g]);this.g.set(f,[a,b]);this.M.set(k,x.Multiplexer(this.I,this.ba));this.L.set(k,x.Demultiplexer(this.I,this.ba));this.fire("routing_paths_count",this.h.size)}},W:function(a,b){var d=this;var g=t([a,b]);if(this.j.has(g)&&(this.j["delete"](g),this.a.destroy_routing_path(a,b),this.w["delete"](g),this.m.forEach(function(a,b){var c=a[0];var f=a[1];a=a[2];c=t([c,f]);
D(g,c)&&(clearInterval(a),d.m["delete"](b))}),this.g.has(g))){b=this.g.get(g);a=b[0];b=b[1];var h=t([a,b]);this.g["delete"](g);this.h["delete"](h);this.v.has(h)&&(clearTimeout(this.v.get(h)),this.v["delete"](h));if(this.i.has(a)){var k=this.i.get(a)[3];k["delete"](b)}if(k=this.u.get(h))k.destroy(),this.u["delete"](h);this.M["delete"](h);this.L["delete"](h);this.la(a,b);this.fire("routing_paths_count",this.h.size)}},da:function(a,b){var d=t([a,b]);this.B.add(d);this.fire("connected",a,b);this.fire("application_connections_count",
this.B.size)},la:function(a,b){var d=t([a,b]);this.B.has(d)&&(this.B["delete"](d),this.fire("disconnected",a,b),this.fire("application_connections_count",this.B.size))},J:function(a,b,d){function f(h){D(a,h)&&(clearTimeout(k),g.b.off("node_connected",f),g.S(a),g.b.send_data(a,b,d))}var g=this;if(this.l.has(a))this.S(a),this.b.send_data(a,b,d);else{this.b.on("node_connected",f);var k=O(Ha,function(){g.b.off("node_connected",f)});this.b.lookup(a)}},R:function(a,b,d,g){a=t([a,b]);this.h.has(a)&&(b=this.h.get(a),
a=b[0],b=b[1],this.a.send_data(a,b,d,g))},ea:function(a,b){var d=t([a,b]);if(this.w.has(d)||!this.j.has(d))return!1;this.a.send_data(a,b,ka,new Uint8Array(0));return!0},S:function(a){this.D.has(a)||this.fa(a);this.D.set(a,+new Date)},fa:function(a){var b=this.A.get(a)||0;++b;this.A.set(a,b);1===b&&this.b.add_used_tag(a)},Y:function(a){var b;if(b=this.A.get(a))--b,b?this.A.set(a,b):(this.A["delete"](a),this.b.del_used_tag(a))}};g.prototype=Object.assign(Object.create(v.prototype),g.prototype);Object.defineProperty(g.prototype,
"constructor",{value:g});return{ready:function(a){n.ready(function(){q.ready(function(){a()})})},generate_seed:function(){return p(d)},Core:g}}function Ba(d,q){for(var m=-1,n=q.length>>>0;++m<n;)if(d===q[m])return!0;return!1}var V=0;var W=1;var Y=2;var Z=3;var ba=0;var ca=1;var da=2;var fa=3;var X=4;var ha=5;var ia=6;var T=7;var ka=8;var d=32;var E=64;var C=48;var Ea=16;var I=64;var M=30;var Ha=10;var R=60;var Ca=1800;var Ga=300;var aa=1E3;var Aa=30;var ea=0;var S=1;var la=2;var ma=3;var Q=4;var na=
5;var oa=0;var pa=1;var qa=2;var ra=0;var sa=1;var ta=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],J):"object"===typeof exports?module.exports=J(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=J(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);