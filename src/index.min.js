/*
 0BSD
*/
(function(){function va(n){var r;var l=n[0];var x=n.subarray(1,1+d);var w=[];n=n.subarray(1+d);var h=0;for(r=n.length/d;h<r;++h){var q=h;w.push(n.subarray(q*d,(q+1)*d))}return[l,x,w]}function wa(n,r,l,x,w,h){var q=new Uint8Array(3*d+C+I+d);q.set(n);q.set(r,d);q.set(l,2*d);q.set(x,3*d);q.set(w,3*d+C);q.set(h,3*d+C+I);return q}function xa(n,r,l,x){var w=new Uint8Array(3*d+x.length);w.set(n);w.set(r,d);w.set(l,2*d);w.set(x,3*d);return w}function ya(n,r,l){var x=new Uint8Array(E+d+C);x.set(n);x.set(r,
E);x.set(l,E+d);return x}function U(n){return[n.subarray(0,E),n.subarray(E,E+d),n.subarray(E+d)]}function za(n,r){var l=new Uint8Array(d+r.length);l.set(n);l.set(r,d);return l}function J(n,r,l,x,w){function h(a,b,m,f,g,p,k){var c=this;null==f&&(f=1);null==g&&(g=2);null==p&&(p=10);null==k&&(k={});if(!(this instanceof h))return new h(a,b,m,f,g,p,k);w.call(this);this.i=t();this.G=n.create_keypair(a);this.J=r.MAX_DATA_SIZE;this.f=t();this.l=A();this.b=t();this.I=A();this.j=t();this.h=t();this.g=t();this.C=
t();this.A=t();this.R=t();this.s=t();this.o=t();this.H=t();this.B=A();this.v=t();this.N=t();this.M=t();this.w=t();this.D=A();this.ha=L(R,function(){var a=+new Date-1E3*R;c.R.forEach(function(b,d){if(b<a){if(c.j.has(d)){var e=c.j.get(d);b=e[0];e=e[1];c.fa(b,e)}c.R["delete"](d)}});c.A.forEach(function(b,d){b<a&&(c.Z(d),c.A["delete"](d))});var b=+new Date-2E3*V;c.b.forEach(function(a,d){if(a<b)c.b["delete"](d)})});this.la=L(R/5*4,function(){c.i.forEach(function(a,b){var e=a[1];var d=a[3];a=a[4];d.size<
e&&a&&(e=+new Date-3*M,a<e&&c.Y(b));d.forEach(function(a){a=u([b,a]);var e=c.h.get(a);a=e[0];e=e[1];c.X(a,e)&&(a=u([a,e]),c.B.add(a))})})});this.ka=L(Ba,function(){c.da()&&c.ja()});this.a=r.DHT(this.G.ed25519["public"],this.G.ed25519["private"],b,m,f,g,k).on("node_connected",function(a){c.l.add(a);c.b["delete"](a);c.fire("aware_of_nodes_count",c.b.size);c.fire("connected_nodes_count",c.l.size);var b=J(a);if(c.da()){var e=c.get_bootstrap_nodes().map(function(a){return a.node_id});Ca(b,e)||c.aa(a)}}).on("node_disconnected",
function(a){c.l["delete"](a);c.fire("connected_nodes_count",c.l.size);c.I["delete"](a)}).on("data",function(a,b,e){var f;switch(b){case W:c.c.process_packet(a,e);break;case X:b=[e.subarray(0,d),e.subarray(d)];var m=b[0];e=b[1];if(!c.o.has(m))break;b=c.o.get(m);m=b[0];b=b[1];c.m(m,b,Y,e);break;case Z:var p=c.P(7)||[];p=p.concat(c.O(10-p.length)||[]);e=new Uint8Array(p.length*d);b=0;for(f=p.length;b<f;++b){m=b;var k=p[b];e.set(k,m*d)}c.K(a,aa,e);break;case aa:if(c.I.has(a)&&(c.I["delete"](a),e.length&&
0===e.length%d))for(a=e.length/d,p=c.ba(),b=0;b<a;++b)if(m=b,m=e.subarray(m*d,(m+1)*d),!D(m,c.G.ed25519["public"])&&!c.l.has(m))if(c.b.has(m)||c.b.size<ba)c.b.set(m,+new Date),c.fire("aware_of_nodes_count",c.b.size);else if(p.length)f=N(p),c.b["delete"](f),c.b.set(m,+new Date),c.fire("aware_of_nodes_count",c.b.size);else break}}).on("ready",function(){c.a.lookup(q(d));c.a.lookup(q(d));c.a.lookup(q(d));c.fire("ready")});this.c=r.Router(this.G.x25519["private"],p).on("activity",function(a,b){var e=
u([a,b]);c.j.has(e)||c.j.set(e,[a,b]);c.T(a);c.R.set(e,+new Date)}).on("send",function(a,b){c.K(a,W,b)}).on("data",function(a,b,e,f){var m,p;var k=u([a,b]);switch(e){case ca:var g=c.a.verify_announcement_message(f);if(!g)break;c.o.has(g)&&clearInterval(c.o.get(g)[2]);e=L(Da,function(){c.j.has(k)&&c.a.publish_announcement_message(f)});c.o.set(g,[a,b,e]);c.a.publish_announcement_message(f);break;case da:var v=f;if(v.length!==d)break;var l=function(e,f){var m=v,g;var p=g=new Uint8Array(1+d+f.length*
d);p.set([e]);p.set(m,1);e=0;for(m=f.length;e<m;++e){p=e;var k=f[e];g.set(k,1+d+p*d)}c.m(a,b,ea,g)};c.a.find_introduction_nodes(v,function(a){a.length?l(fa,a):l(S,[])},function(){l(S,[])});break;case ha:e=[f.subarray(0,d),f.subarray(d,2*d),f.subarray(2*d,3*d),f.subarray(3*d)];var y=e[0];var h=e[1];v=e[2];g=e[3];if(c.s.has(y))break;e=O(M,function(){c.s["delete"](y)});c.s.set(y,[a,b,v,e]);c.K(h,X,za(v,g));break;case ia:e=U(f);g=e[0];y=e[1];var r=e[2];if(!c.s.has(y))break;e=c.s.get(y);h=e[0];var q=e[1];
v=e[2];e=e[3];if(!n.verify(g,y,v))break;c.s["delete"](y);clearTimeout(e);c.m(h,q,ja,f);g=u([h,q]);c.H.set(k,[h,q]);c.H.set(g,[a,b]);break;case Y:if(!c.g.has(k))break;e=c.g.get(k);var B=e[0];h=e[1];if(!c.i.has(B))break;e=c.i.get(B);var x=e[0];var t=e[3];if(!t.has(h))break;try{q=n.one_way_decrypt(x.x25519["private"],f);g=q.subarray(0,E);var F=q.subarray(E);e=[F.subarray(0,d),F.subarray(d,2*d),F.subarray(2*d,3*d),F.subarray(3*d,3*d+C),F.subarray(3*d+C,3*d+C+I),F.subarray(3*d+C+I,3*d+C+I+d)];v=e[0];var w=
e[1];y=e[2];r=e[3];var D=e[4];var Aa=e[5];var H=m=new Uint8Array(d+F.length);H.set(h);H.set(F,d);if(n.verify(g,m,v)){var z=u([B,v]);if(!c.h.has(z)){if(c.f.has(z)){var G=c.f.get(z);if(G.L&&!G.u){var P=0;for(p=B.length;P<p;++P){var A=P;var ka=B[P];if(ka!==v[A]){if(ka>v[A])return;G.u=!0;break}}}}else G={L:!1},c.f.set(z,G);f={real_public_key:B,target_id:v,secret:Aa,application:D,number_of_intermediate_nodes:null};c.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=c.V(a,[w])){a.push(w);var b=a[0];c.c.construct_routing_path(a).then(function(a){var e=n.Encryptor(!1,x.x25519["private"]);e.put_handshake_message(r);var f=e.get_handshake_message();c.v.set(z,e);c.W(B,v,b,a);c.f["delete"](z);c.ea(B,v);a=n.sign(y,B,x.ed25519["private"]);c.S(B,v,ia,ya(a,y,f))})["catch"](function(a){K(a);c.f["delete"](z);G.L&&G.u&&c.fire("connection_failed",B,v,Q)})}})["catch"](function(a){K(a);c.f["delete"](z);G.L&&G.u&&c.fire("connection_failed",B,v,Q)})}}}catch(Ea){g=Ea,K(g)}break;
case T:if(c.H.has(k))e=c.H.get(k),h=e[0],q=e[1],c.m(h,q,T,f);else if(c.g.has(k)&&(e=c.g.get(k),B=e[0],v=e[1],z=u([B,v]),e=c.v.get(z))&&(g=c.M.get(z)))for(e=e.decrypt(f),g.feed(e);g.have_more_data();)h=g.get_data(),e=h[0],c.fire("data",B,v,e,h.subarray(1));break;case la:if(c.g.has(k)&&c.B.has(k))c.B["delete"](k);else c.X(a,b)}});this.ca=this.c.get_max_packet_data_size()-Fa}var q=l.random_bytes;var N=l.pull_random_item_from_array;var D=l.are_arrays_equal;var J=l.array2hex;var Ga=l.hex2array;var u=l.concat_arrays;
var O=l.timeoutSet;var L=l.intervalSet;var K=l.error_handler;var t=l.ArrayMap;var A=l.ArraySet;h.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=ma;h.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=na;h.CONNECTION_ERROR_NO_INTRODUCTION_NODES=S;h.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=Q;h.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=oa;h.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=pa;h.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=qa;h.CONNECTION_PROGRESS_INTRODUCTION_SENT=ra;h.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=
sa;h.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=ta;h.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ua;h.prototype={start_bootstrap_node:function(a,b,d,f){null==d&&(d=a);null==f&&(f=b);this.a.start_bootstrap_node(a,b,d,f);this.F=!0;this.$()},get_bootstrap_nodes:function(){return this.a.get_bootstrap_nodes()},announce:function(a,b,d){if(this.F)return null;a=n.create_keypair(a);var f=a.ed25519["public"];if(this.i.has(f))return null;this.i.set(f,[a,b,d,A()]);this.Y(f);return f},Y:function(a){function b(b){var c;
b&&q.push(b);--l;if(!l)if(q.length){q=q.concat(e);var f=g.a.generate_announcement_message(a,k.ed25519["private"],q);var d=0;for(c=q.length;d<c;++d)b=q[d],g.S(a,b,ca,f);g.fire("announced",a)}else g.U(a,1),g.fire("announcement_failed",a,ta)}function d(c){var d,m=this;if(d=this.V(h,f.concat(e))){d.push(c);var g=d[0];this.c.construct_routing_path(d).then(function(e){m.W(a,c,g,e);n.add(c);b(c)})["catch"](function(a){K(a);b()})}else this.fire("announcement_failed",a,ua)}var f,g=this;var p=this.i.get(a);
var k=p[0];var c=p[1];var h=p[2];var n=p[3];var e=[];n.forEach(function(a){e.push(a)});if(c-=e.length)if(this.U(a,+new Date),f=this.O(c,e)){var l=c;var q=[];p=0;for(c=f.length;p<c;++p)d.call(this,f[p])}else this.U(a,1),this.fire("announcement_failed",a,sa)},U:function(a,b){this.i.get(a)[4]=b},connect_to:function(a,b,m,f,g){function p(a){e.u||(k.f["delete"](l),k.fire("connection_failed",h,b,a))}var k=this;if(this.F)return null;if(!g)throw Error("Direct connections are not yet supported");var c=n.create_keypair(a);
var h=c.ed25519["public"];if(D(h,b))return null;var l=u([h,b]);if(this.f.has(l))return h;var e={L:!0,u:!1};this.f.set(l,e);if(this.h.has(l))return null;a=this.V(g);if(!a)return p(na),null;var r=a[0];var x=a[a.length-1];this.c.construct_routing_path(a).then(function(a){function g(g,t,u,w){function v(){function g(c,e,f,d){D(r,c)&&D(a,e)&&f===ja&&(f=U(d),c=f[0],e=f[1],f=f[2],D(e,w)&&n.verify(c,w,b)&&(C.put_handshake_message(f),k.v.set(l,C),clearTimeout(G),k.c.off("data",g),k.W(h,b,r,a),k.f["delete"](l),
k.ea(h,b)))}var y,t;if(!e.u)if(F.length){var u=N(F);var w=q(d);var A=n.convert_public_key(b);var C=n.Encryptor(!0,A);var H=C.get_handshake_message();H=wa(h,x,w,H,m,f);var z=y=new Uint8Array(d+H.length);z.set(u);z.set(H,d);z=n.sign(y,h,c.ed25519["private"]);y=t=new Uint8Array(H.length+E);y.set(z);y.set(H,E);A=n.one_way_encrypt(A,t);k.c.on("data",g);k.m(r,a,ha,xa(w,u,b,A));k.fire("connection_progress",h,b,ra);var G=O(M,function(){k.c.off("data",g);C.destroy();v()})}else p(oa)}if(D(r,g)&&D(a,t)&&u===
ea){g=va(w);t=g[0];u=g[1];var F=g[2];D(b,u)&&(clearTimeout(y),t!==fa?p(t):(k.fire("connection_progress",h,b,qa),v()))}}k.fire("connection_progress",h,b,pa);k.c.on("data",g);k.m(r,a,da,b);var y=O(M,function(){k.c.off("data",g);p(ma)})})["catch"](function(a){K(a);p(Q)});return h},get_max_data_size:function(){return this.J},send_to:function(a,b,d,f){var g,m,k,c=this;if(!this.F){var h=u([a,b]);if((g=this.v.get(h))&&!(f.length>this.J)&&(m=this.N.get(h))){var l=k=new Uint8Array(f.length+1);l.set([d]);l.set(f,
1);m.feed(k);this.w.has(h)||this.w.set(h,setTimeout(function(){for(c.w["delete"](h);m.have_more_blocks();){var e=m.get_block();e=g.encrypt(e);c.S(a,b,T,e)}}))}}},destroy:function(){this.ia||(this.F||this.$(),this.a.destroy(),this.ia=!0)},$:function(){var a=this;clearInterval(this.ha);clearInterval(this.la);clearInterval(this.ka);this.A.forEach(function(b,d){a.Z(d)});this.j.forEach(function(b){a.fa(b[0],b[1])});this.s.forEach(function(a){clearTimeout(a[3])});this.c.destroy()},da:function(){return!this.F&&
!!(this.b.size<ba||this.ba(!0).length)},ba:function(a){null==a&&(a=!1);var b=[];var d=+new Date-1E3*V;var f=!1;this.b.forEach(function(g,m){!f&&g<d&&(b.push(m),a&&!f&&(f=!0))});return b},ja:function(){var a,b;if(a=this.P(5)){var d=0;for(b=a.length;d<b;++d){var f=a[d];this.aa(f)}}},aa:function(a){this.I.add(a);this.K(a,Z,new Uint8Array(0))},V:function(a,b){var d;null==b&&(b=[]);var f=null!=(d=this.P(1,b))?d[0]:void 0;return f?(a=this.O(a-1,b.concat([f])))?[f].concat(a):null:null},P:function(a,b){var m,
f,g=[];null==a&&(a=1);null==b&&(b=[]);if(!this.l.size)return this.a.lookup(q(d)),null;var h=Array.from(this.l.values());var k=0;for(f=(m=this.get_bootstrap_nodes()).length;k<f;++k){var c=m[k];b.push(Ga(c.node_id))}var l=A(b);h=h.filter(function(a){return!l.has(a)});if(!h.length)return null;for(k=0;k<a;++k)h.length&&g.push(N(h));return g},O:function(a,b){var d=[];if(this.b.size<a)return null;var f=Array.from(this.b.keys());if(b){var g=A(b);f=f.filter(function(a){return!g.has(a)})}if(f.length<a)return null;
for(b=0;b<a;++b)d.push(N(f));return d},W:function(a,b,d,f){var g=u([d,f]);if(!this.g.has(g)){var h=u([a,b]);this.h.set(h,[d,f]);this.g.set(g,[a,b]);this.N.set(h,x.Multiplexer(this.J,this.ca));this.M.set(h,x.Demultiplexer(this.J,this.ca));this.fire("routing_paths_count",this.h.size)}},fa:function(a,b){var d=this;var f=u([a,b]);if(this.j.has(f)&&(this.j["delete"](f),this.c.destroy_routing_path(a,b),this.B["delete"](f),this.o.forEach(function(a,b){var c=a[0];var g=a[1];a=a[2];c=u([c,g]);D(f,c)&&(clearInterval(a),
d.o["delete"](b))}),this.g.has(f))){b=this.g.get(f);a=b[0];b=b[1];var g=u([a,b]);this.g["delete"](f);this.h["delete"](g);this.w.has(g)&&(clearTimeout(this.w.get(g)),this.w["delete"](g));if(this.i.has(a)){var h=this.i.get(a)[3];h["delete"](b)}if(h=this.v.get(g))h.destroy(),this.v["delete"](g);this.N["delete"](g);this.M["delete"](g);this.ma(a,b);this.fire("routing_paths_count",this.h.size)}},ea:function(a,b){var d=u([a,b]);this.D.add(d);this.fire("connected",a,b);this.fire("application_connections_count",
this.D.size)},ma:function(a,b){var d=u([a,b]);this.D.has(d)&&(this.D["delete"](d),this.fire("disconnected",a,b),this.fire("application_connections_count",this.D.size))},K:function(a,b,d){function f(k){D(a,k)&&(clearTimeout(h),g.a.off("node_connected",f),g.T(a),g.a.send_data(a,b,d))}var g=this;if(this.l.has(a))this.T(a),this.a.send_data(a,b,d);else{this.a.on("node_connected",f);var h=O(Ha,function(){g.a.off("node_connected",f)});this.a.lookup(a)}},S:function(a,b,d,f){a=u([a,b]);this.h.has(a)&&(b=this.h.get(a),
a=b[0],b=b[1],this.m(a,b,d,f))},m:function(a,b,d,f){0===f.length&&(f=new Uint8Array(1));return this.c.send_data(a,b,d,f)},X:function(a,b){var d=u([a,b]);if(this.B.has(d)||!this.j.has(d))return!1;this.m(a,b,la,new Uint8Array(0));return!0},T:function(a){this.A.has(a)||this.ga(a);this.A.set(a,+new Date)},ga:function(a){var b=this.C.get(a)||0;++b;this.C.set(a,b);1===b&&this.a.add_used_tag(a)},Z:function(a){var b;if(b=this.C.get(a))--b,b?this.C.set(a,b):(this.C["delete"](a),this.a.del_used_tag(a))}};h.prototype=
Object.assign(Object.create(w.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});return{ready:function(a){n.ready(function(){r.ready(function(){a()})})},generate_seed:function(){return q(d)},Core:h}}function Ca(d,r){for(var l=-1,n=r.length>>>0;++l<n;)if(d===r[l])return!0;return!1}var W=0;var X=1;var Z=2;var aa=3;var ca=0;var da=1;var ea=2;var ha=3;var Y=4;var ia=5;var ja=6;var T=7;var la=8;var d=32;var E=64;var C=48;var Fa=16;var I=64;var M=30;var Ha=10;var R=60;var Da=
600;var V=300;var ba=1E3;var Ba=30;var fa=0;var S=1;var ma=2;var na=3;var Q=4;var oa=5;var pa=0;var qa=1;var ra=2;var sa=0;var ta=1;var ua=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],J):"object"===typeof exports?module.exports=J(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=J(this.detox_crypto,this.detox_transport,
this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);