/*
 0BSD
*/
(function(){function ua(m){var p;var h=m[0];var n=m.subarray(1,1+d);var v=[];m=m.subarray(1+d);var l=0;for(p=m.length/d;l<p;++l){var x=l;v.push(m.subarray(x*d,(x+1)*d))}return[h,n,v]}function va(m,p,h,n,v,l){var x=new Uint8Array(3*d+B+G+d);x.set(m);x.set(p,d);x.set(h,2*d);x.set(n,3*d);x.set(v,3*d+B);x.set(l,3*d+B+G);return x}function wa(m,p,h,n){var v=new Uint8Array(3*d+n.length);v.set(m);v.set(p,d);v.set(h,2*d);v.set(n,3*d);return v}function xa(m,p,h){var n=new Uint8Array(E+d+B);n.set(m);n.set(p,
E);n.set(h,E+d);return n}function T(m){return[m.subarray(0,E),m.subarray(E,E+d),m.subarray(E+d)]}function ya(m,p){var h=new Uint8Array(d+p.length);h.set(m);h.set(p,d);return h}function H(m,p,h,n,v){function l(a,c,f,r,g,k){var b=this;null==r&&(r=1);null==g&&(g=2);null==k&&(k=10);if(!(this instanceof l))return new l(a,c,f,r,g,k);v.call(this);this.i=w();this.F=m.create_keypair(a);this.I=p.MAX_DATA_SIZE;this.f=w();this.l=A();this.c=w();this.H=A();this.j=w();this.h=w();this.g=w();this.B=w();this.D=w();
this.P=w();this.o=w();this.m=w();this.G=w();this.A=A();this.u=w();this.M=w();this.L=w();this.v=w();this.w=A();this.da=J(P,function(){var a=+new Date-1E3*P;b.P.forEach(function(c,e){if(c<a){if(b.j.has(e)){var d=b.j.get(e);c=d[0];d=d[1];b.ca(c,d)}b.P["delete"](e)}});b.D.forEach(function(c,e){c<a&&(b.fa(e),b.D["delete"](e))})});this.ja=J(P,function(){b.i.forEach(function(a,c){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*K,a<e&&b.W(c));d.forEach(function(a){a=t([c,a]);var e=b.h.get(a);a=e[0];
e=e[1];b.ba(a,e)&&(a=t([a,e]),b.A.add(a))})})});this.ia=J(Aa,function(){b.$()&&b.ha()});this.b=p.DHT(this.F.ed25519["public"],this.F.ed25519["private"],c,f,r,g).on("node_connected",function(a){b.l.add(a);b.fire("connected_nodes_count",b.l.size);b.$()&&b.X(a)}).on("node_disconnected",function(a){b.l["delete"](a);b.fire("connected_nodes_count",b.l.size);b.H["delete"](a)}).on("data",function(a,c,e){var r;switch(c){case U:b.a.process_packet(a,e);break;case V:if(b.C)break;c=[e.subarray(0,d),e.subarray(d)];
var f=c[0];e=c[1];if(!b.m.has(f))break;c=b.m.get(f);f=c[0];c=c[1];b.a.send_data(f,c,W,e);break;case X:var k=b.O(7)||[];k=k.concat(b.N(10-k.length)||[]);e=new Uint8Array(k.length*d);c=0;for(r=k.length;c<r;++c){f=c;var g=k[c];e.set(g,f*d)}b.J(a,Y,e);break;case Y:if(b.H.has(a)&&(b.H["delete"](a),e.length&&0===e.length%d))for(a=e.length/d,k=b.Y(),c=0;c<a;++c)if(f=c,f=e.subarray(f*d,(f+1)*d),!D(f,b.F.ed25519["public"])&&!b.l.has(f))if(b.c.has(f)||b.c.size<Z)b.c.set(f,+new Date),b.fire("aware_of_nodes_count",
b.c.size);else if(k.length)r=L(k),b.c["delete"](r),b.c.set(f,+new Date),b.fire("aware_of_nodes_count",b.c.size);else break}}).on("ready",function(){b.b.lookup(x(d));b.b.lookup(x(d));b.b.lookup(x(d));b.fire("ready")});this.a=p.Router(this.F.x25519["private"],k).on("activity",function(a,c){var e=t([a,c]);b.j.has(e)||b.j.set(e,[a,c]);b.S(a);b.P.set(e,+new Date)}).on("send",function(a,c){b.J(a,U,c)}).on("data",function(a,c,e,f){var r,k;var g=t([a,c]);switch(e){case aa:if(b.C)break;var u=b.b.verify_announcement_message(f);
if(!u)break;b.m.has(u)&&clearInterval(b.m.get(u)[2]);e=J(Ba,function(){b.j.has(g)&&b.b.publish_announcement_message(f)});b.m.set(u,[a,c,e]);b.b.publish_announcement_message(f);break;case ba:if(b.C)break;var q=f;if(q.length!==d)break;var F=function(e,f){var r=q,k;var g=k=new Uint8Array(1+d+f.length*d);g.set([e]);g.set(r,1);e=0;for(r=f.length;e<r;++e){g=e;var l=f[e];k.set(l,1+d+g*d)}b.a.send_data(a,c,ca,k)};b.b.find_introduction_nodes(q,function(a){a.length?F(da,a):F(R,[])},function(){F(R,[])});break;
case ea:if(b.C)break;e=[f.subarray(0,d),f.subarray(d,2*d),f.subarray(2*d,3*d),f.subarray(3*d)];var l=e[0];var h=e[1];q=e[2];u=e[3];if(b.o.has(l))break;e=M(K,function(){b.o["delete"](l)});b.o.set(l,[a,c,q,e]);b.J(h,V,ya(q,u));break;case fa:e=T(f);u=e[0];l=e[1];var x=e[2];if(!b.o.has(l))break;e=b.o.get(l);h=e[0];var p=e[1];q=e[2];e=e[3];if(!m.verify(u,l,q))break;b.o["delete"](l);clearTimeout(e);b.a.send_data(h,p,ha,f);u=t([h,p]);b.G.set(g,[h,p]);b.G.set(u,[a,c]);break;case W:if(!b.g.has(g))break;e=
b.g.get(g);var y=e[0];h=e[1];if(!b.i.has(y))break;e=b.i.get(y);var w=e[0];var Q=e[3];if(!Q.has(h))break;try{p=m.one_way_decrypt(w.x25519["private"],f);u=p.subarray(0,E);var n=p.subarray(E);e=[n.subarray(0,d),n.subarray(d,2*d),n.subarray(2*d,3*d),n.subarray(3*d,3*d+B),n.subarray(3*d+B,3*d+B+G),n.subarray(3*d+B+G,3*d+B+G+d)];q=e[0];var v=e[1];l=e[2];x=e[3];var za=e[4];var D=e[5];var A=r=new Uint8Array(d+n.length);A.set(h);A.set(n,d);if(m.verify(u,r,q)){var z=t([y,q]);if(!b.h.has(z)){if(b.f.has(z)){var C=
b.f.get(z);if(C.K&&!C.s){var N=0;for(k=y.length;N<k;++N){var ia=N;var ja=y[N];if(ja!==q[ia]){if(ja>q[ia])return;C.s=!0;break}}}}else C={K:!1},b.f.set(z,C);f={real_public_key:y,target_id:q,secret:D,application:za,number_of_intermediate_nodes:null};b.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");if(a=b.U(a,[v])){a.push(v);var c=a[0];b.a.construct_routing_path(a).then(function(a){var e=m.Encryptor(!1,w.x25519["private"]);
e.put_handshake_message(x);var f=e.get_handshake_message();b.u.set(z,e);b.V(y,q,c,a);b.f["delete"](z);b.aa(y,q);a=m.sign(l,y,w.ed25519["private"]);b.R(y,q,fa,xa(a,l,f))})["catch"](function(a){I(a);b.f["delete"](z);C.K&&C.s&&b.fire("connection_failed",y,q,O)})}})["catch"](function(a){I(a);b.f["delete"](z);C.K&&C.s&&b.fire("connection_failed",y,q,O)})}}}catch(Ca){u=Ca,I(u)}break;case S:if(b.G.has(g))e=b.G.get(g),h=e[0],p=e[1],b.a.send_data(h,p,S,f);else if(b.g.has(g)&&(e=b.g.get(g),y=e[0],q=e[1],z=
t([y,q]),e=b.u.get(z))&&(u=b.L.get(z)))for(e=e.decrypt(f),u.feed(e);u.have_more_data();)h=u.get_data(),e=h[0],b.fire("data",y,q,e,h.subarray(1));break;case ka:if(b.g.has(g)&&b.A.has(g))b.A["delete"](g);else b.ba(a,c)}});this.Z=this.a.get_max_packet_data_size()-Da}var x=h.random_bytes;var L=h.pull_random_item_from_array;var D=h.are_arrays_equal;var H=h.hex2array;var t=h.concat_arrays;var M=h.timeoutSet;var J=h.intervalSet;var I=h.error_handler;var w=h.ArrayMap;var A=h.ArraySet;l.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=
la;l.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ma;l.CONNECTION_ERROR_NO_INTRODUCTION_NODES=R;l.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=O;l.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=na;l.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=oa;l.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=pa;l.CONNECTION_PROGRESS_INTRODUCTION_SENT=qa;l.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=ra;l.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=sa;l.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=
ta;l.prototype={start_bootstrap_node:function(a,c,f){null==f&&(f=a);this.b.start_bootstrap_node(a,c,f);this.C=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,c,f){a=m.create_keypair(a);var d=a.ed25519["public"];if(this.i.has(d))return null;this.i.set(d,[a,c,f,A()]);this.W(d);return d},W:function(a){function c(c){var e;c&&n.push(c);--p;if(!p)if(n.length){n=n.concat(m);var f=g.b.generate_announcement_message(a,b.ed25519["private"],n);var d=0;for(e=n.length;d<
e;++d)c=n[d],g.R(a,c,aa,f);g.fire("announced",a)}else g.T(a,1),g.fire("announcement_failed",a,sa)}function f(b){var f,k=this;if(f=this.U(h,d.concat(m))){f.push(b);var g=f[0];this.a.construct_routing_path(f).then(function(f){k.V(a,b,g,f);e.add(b);c(b)})["catch"](function(a){I(a);c()})}else this.fire("announcement_failed",a,ta)}var d,g=this;var k=this.i.get(a);var b=k[0];var l=k[1];var h=k[2];var e=k[3];var m=[];e.forEach(function(a){m.push(a)});if(l-=m.length)if(this.T(a,+new Date),d=this.N(l,m)){var p=
l;var n=[];k=0;for(l=d.length;k<l;++k)f.call(this,d[k])}else this.T(a,1),this.fire("announcement_failed",a,ra)},T:function(a,c){this.i.get(a)[4]=c},connect_to:function(a,c,f,r,g){function k(a){n.s||(b.f["delete"](e),b.fire("connection_failed",h,c,a))}var b=this;if(!g)throw Error("Direct connections are not yet supported");var l=m.create_keypair(a);var h=l.ed25519["public"];if(D(h,c))return null;var e=t([h,c]);if(this.f.has(e))return h;var n={K:!0,s:!1};this.f.set(e,n);if(this.h.has(e))return null;
a=this.U(g);if(!a)return k(ma),null;var p=a[0];var w=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function g(g,t,u,v){function F(){function g(f,d,k,r){D(p,f)&&D(a,d)&&k===ha&&(k=T(r),f=k[0],d=k[1],k=k[2],D(d,v)&&m.verify(f,v,c)&&(B.put_handshake_message(k),b.u.set(e,B),clearTimeout(Q),b.a.off("data",g),b.V(h,c,p,a),b.f["delete"](e),b.aa(h,c)))}var q,t;if(!n.s)if(y.length){var u=L(y);var v=x(d);var A=m.convert_public_key(c);var B=m.Encryptor(!0,A);var z=B.get_handshake_message();
z=va(h,w,v,z,f,r);var C=q=new Uint8Array(d+z.length);C.set(u);C.set(z,d);C=m.sign(q,h,l.ed25519["private"]);q=t=new Uint8Array(z.length+E);q.set(C);q.set(z,E);A=m.one_way_encrypt(A,t);b.a.on("data",g);b.a.send_data(p,a,ea,wa(v,u,c,A));b.fire("connection_progress",h,c,qa);var Q=M(K,function(){b.a.off("data",g);B.destroy();F()})}else k(na)}if(D(p,g)&&D(a,t)&&u===ca){g=ua(v);t=g[0];u=g[1];var y=g[2];D(c,u)&&(clearTimeout(q),t!==da?k(t):(b.fire("connection_progress",h,c,pa),F()))}}b.fire("connection_progress",
h,c,oa);b.a.on("data",g);b.a.send_data(p,a,ba,c);var q=M(K,function(){b.a.off("data",g);k(la)})})["catch"](function(a){I(a);k(O)});return h},get_max_data_size:function(){return this.I},send_to:function(a,c,f,d){var g,k,b,h=this;var r=t([a,c]);if((g=this.u.get(r))&&!(d.length>this.I)&&(k=this.M.get(r))){var e=b=new Uint8Array(d.length+1);e.set([f]);e.set(d,1);k.feed(b);this.v.has(r)||this.v.set(r,setTimeout(function(){for(h.v["delete"](r);k.have_more_blocks();){var b=k.get_block();b=g.encrypt(b);h.R(a,
c,S,b)}}))}},destroy:function(){var a=this;this.ga||(clearInterval(this.da),clearInterval(this.ja),clearInterval(this.ia),this.j.forEach(function(c){a.ca(c[0],c[1])}),this.o.forEach(function(a){clearTimeout(a[3])}),this.b.destroy(),this.a.destroy(),this.ga=!0)},$:function(){return!!(this.c.size<Z||this.Y(!0).length)},Y:function(a){null==a&&(a=!1);var c=[];var f=+new Date-1E3*Ea;var d=!1;this.c.forEach(function(g,k){!d&&g<f&&(c.push(k),a&&!d&&(d=!0))});return c},ha:function(){var a,c;if(a=this.O(5)){var f=
0;for(c=a.length;f<c;++f){var d=a[f];this.X(d)}}},X:function(a){this.H.add(a);this.J(a,X,new Uint8Array(0))},U:function(a,c){null==c&&(c=[]);var f=this.O(1,c);return f?(a=this.N(a-1,c.concat([f])))?f.concat(a):null:null},O:function(a,c){var f,h,g=[];null==a&&(a=1);null==c&&(c=[]);if(!this.l.size)return this.b.lookup(x(d)),null;var k=Array.from(this.l.values());var b=0;for(h=(f=this.get_bootstrap_nodes()).length;b<h;++b){var l=f[b];c.push(H(l.node_id))}var m=A(c);k=k.filter(function(a){return!m.has(a)});
if(!k.length)return null;for(b=0;b<a;++b)k.length&&g.push(L(k));return g},N:function(a,c){var f=[];if(this.c.size<a)return null;var d=Array.from(this.c.keys());if(c){var g=A(c);d=d.filter(function(a){return!g.has(a)})}if(d.length<a)return null;for(c=0;c<a;++c)f.push(L(d));return f},V:function(a,c,d,h){var f=t([d,h]);if(!this.g.has(f)){var k=t([a,c]);this.h.set(k,[d,h]);this.g.set(f,[a,c]);this.M.set(k,n.Multiplexer(this.I,this.Z));this.L.set(k,n.Demultiplexer(this.I,this.Z));this.fire("routing_paths_count",
this.h.size)}},ca:function(a,c){var d=this;var h=t([a,c]);if(this.j.has(h)&&(this.j["delete"](h),this.a.destroy_routing_path(a,c),this.A["delete"](h),this.m.forEach(function(a,c){var b=a[0];var e=a[1];a=a[2];b=t([b,e]);D(h,b)&&(clearInterval(a),d.m["delete"](c))}),this.g.has(h))){c=this.g.get(h);a=c[0];c=c[1];var g=t([a,c]);this.g["delete"](h);this.h["delete"](g);this.v.has(g)&&(clearTimeout(this.v.get(g)),this.v["delete"](g));if(this.i.has(a)){var k=this.i.get(a)[3];k["delete"](c)}if(k=this.u.get(g))k.destroy(),
this.u["delete"](g);this.M["delete"](g);this.L["delete"](g);this.ka(a,c);this.fire("routing_paths_count",this.h.size)}},aa:function(a,c){var d=t([a,c]);this.w.add(d);this.fire("connected",a,c);this.fire("application_connections_count",this.w.size)},ka:function(a,c){var d=t([a,c]);this.w.has(d)&&(this.w["delete"](d),this.fire("disconnected",a,c),this.fire("application_connections_count",this.w.size))},J:function(a,c,d){function f(b){D(a,b)&&(clearTimeout(k),g.b.off("node_connected",f),g.S(a),g.b.send_data(a,
c,d))}var g=this;if(this.l.has(a))this.S(a),this.b.send_data(a,c,d);else{this.b.on("node_connected",f);var k=M(Fa,function(){g.b.off("node_connected",f)});this.b.lookup(a)}},R:function(a,c,d,h){a=t([a,c]);this.h.has(a)&&(c=this.h.get(a),a=c[0],c=c[1],this.a.send_data(a,c,d,h))},ba:function(a,c){var d=t([a,c]);if(this.A.has(d)||!this.j.has(d))return!1;this.a.send_data(a,c,ka,new Uint8Array(0));return!0},S:function(a){this.D.has(a)||this.ea(a);this.D.set(a,+new Date)},ea:function(a){var c=this.B.get(a)||
0;++c;this.B.set(a,c);1===c&&this.b.add_used_tag(a)},fa:function(a){var c;if(c=this.B.get(a))--c,c?this.B.set(a,c):(this.B["delete"](a),this.b.del_used_tag(a))}};l.prototype=Object.assign(Object.create(v.prototype),l.prototype);Object.defineProperty(l.prototype,"constructor",{value:l});return{ready:function(a){m.ready(function(){p.ready(function(){a()})})},generate_seed:function(){return x(d)},Core:l}}var U=0;var V=1;var X=2;var Y=3;var aa=0;var ba=1;var ca=2;var ea=3;var W=4;var fa=5;var ha=6;var S=
7;var ka=8;var d=32;var E=64;var B=48;var Da=16;var G=64;var K=30;var Fa=10;var P=60;var Ba=1800;var Ea=300;var Z=1E3;var Aa=30;var da=0;var R=1;var la=2;var ma=3;var O=4;var na=5;var oa=0;var pa=1;var qa=2;var ra=0;var sa=1;var ta=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],H):"object"===typeof exports?module.exports=H(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),
require("async-eventer")):this.detox_core=H(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);