/*
 0BSD
*/
(function(){function qa(m){var r;var l=m[0];var u=m.subarray(1,1+d);var p=[];m=m.subarray(1+d);var h=0;for(r=m.length/d;h<r;++h){var q=h;p.push(m.subarray(q*d,(q+1)*d))}return[l,u,p]}function ra(m,r,l,u,p,h){var q=new Uint8Array(3*d+y+F+d);q.set(m);q.set(r,d);q.set(l,2*d);q.set(u,3*d);q.set(p,3*d+y);q.set(h,3*d+y+F);return q}function sa(m,r,l,u){var p=new Uint8Array(3*d+u.length);p.set(m);p.set(r,d);p.set(l,2*d);p.set(u,3*d);return p}function ta(m,r,l){var u=new Uint8Array(z+d+y);u.set(m);u.set(r,
z);u.set(l,z+d);return u}function P(m){return[m.subarray(0,z),m.subarray(z,z+d),m.subarray(z+d)]}function ua(m,r){var l=new Uint8Array(d+r.length);l.set(m);l.set(r,d);return l}function G(m,r,l,u,p){function h(a,b,n,f,g,k){var c=this;null==f&&(f=1);null==g&&(g=2);null==k&&(k=10);if(!(this instanceof h))return new h(a,b,n,f,g,k);p.call(this);this.g=t();this.w=m.create_keypair(a);this.C=r.MAX_DATA_SIZE;this.m=B();this.f=t();this.B=B();this.h=t();this.j=t();this.c=t();this.v=t();this.G=t();this.L=t();
this.l=t();this.i=t();this.A=t();this.u=B();this.o=t();this.I=t();this.H=t();this.s=t();this.aa=I(M,function(){var a=+new Date-1E3*M;c.L.forEach(function(b,e){if(b<a){if(c.h.has(e)){var d=c.h.get(e);b=d[0];d=d[1];c.Y(b,d)}c.L["delete"](e)}});c.G.forEach(function(b,e){b<a&&(c.ba(e),c.G["delete"](e))})});this.ea=I(M,function(){c.g.forEach(function(a,b){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*J,a<e&&c.S(b));d.forEach(function(a){a=x([b,a]);var e=c.j.get(a);a=e[0];e=e[1];c.X(a,e)&&(a=
x([a,e]),c.u.add(a))})})});this.da=I(va,function(){c.W()&&c.Z()});this.b=r.DHT(this.w.ed25519["public"],this.w.ed25519["private"],b,n,f,g).on("node_connected",function(a){c.m.add(a);c.W()&&c.T(a)}).on("node_disconnected",function(a){c.m["delete"](a);c.B["delete"](a)}).on("data",function(a,b,e){var k;switch(b){case R:c.a.process_packet(a,e);break;case S:if(c.F)break;b=[e.subarray(0,d),e.subarray(d)];var f=b[0];e=b[1];if(!c.i.has(f))break;b=c.i.get(f);f=b[0];b=b[1];c.a.send_data(f,b,T,e);break;case U:var n=
c.K(7)||[];n=n.concat(c.J(10-n.length)||[]);e=new Uint8Array(n.length*d);b=0;for(k=n.length;b<k;++b){f=b;var g=n[b];e.set(g,f*d)}c.D(a,V,e);break;case V:if(c.B.has(a)&&(c.B["delete"](a),e.length&&0===e.length%d))for(a=e.length/d,n=c.U(),b=0;b<a;++b)if(f=b,f=e.subarray(f*d,(f+1)*d),!A(f,c.w.ed25519["public"])&&!c.m.has(f))if(c.f.has(f)||c.f.size<W)c.f.set(f,+new Date);else if(n.length)k=K(n),c.f["delete"](k),c.f.set(f,+new Date);else break}}).on("ready",function(){c.b.lookup(q(d));c.b.lookup(q(d));
c.b.lookup(q(d));c.fire("ready")});this.a=r.Router(this.w.x25519["private"],k).on("activity",function(a,b){var e=x([a,b]);c.h.has(e)||c.h.set(e,[a,b]);c.N(a);c.L.set(e,+new Date)}).on("send",function(a,b){c.D(a,R,b)}).on("data",function(a,b,e,f){var k;var n=x([a,b]);switch(e){case X:if(c.F)break;var g=c.b.verify_announcement_message(f);if(!g)break;c.i.has(g)&&clearInterval(c.i.get(g)[2]);e=I(wa,function(){c.h.has(n)&&c.b.publish_announcement_message(f)});c.i.set(g,[a,b,e]);c.b.publish_announcement_message(f);
break;case Y:if(c.F)break;var v=f;if(v.length!==d)break;var E=function(e,f){var n=v,g;var k=g=new Uint8Array(1+d+f.length*d);k.set([e]);k.set(n,1);e=0;for(n=f.length;e<n;++e){k=e;var h=f[e];g.set(h,1+d+k*d)}c.a.send_data(a,b,Z,g)};c.b.find_introduction_nodes(v,function(a){a.length?E(aa,a):E(N,[])},function(){E(N,[])});break;case ba:if(c.F)break;e=[f.subarray(0,d),f.subarray(d,2*d),f.subarray(2*d,3*d),f.subarray(3*d)];var h=e[0];var l=e[1];v=e[2];g=e[3];if(c.l.has(h))break;e=L(J,function(){c.l["delete"](h)});
c.l.set(h,[a,b,v,e]);c.D(l,S,ua(v,g));break;case ca:e=P(f);g=e[0];h=e[1];var r=e[2];if(!c.l.has(h))break;e=c.l.get(h);l=e[0];var q=e[1];v=e[2];e=e[3];if(!m.verify(g,h,v))break;c.l["delete"](h);clearTimeout(e);c.a.send_data(l,q,da,f);g=x([l,q]);c.A.set(n,[l,q]);c.A.set(g,[a,b]);break;case T:if(!c.c.has(n))break;e=c.c.get(n);var w=e[0];l=e[1];if(!c.g.has(w))break;e=c.g.get(w);var t=e[0];var u=e[3];if(!u.has(l))break;try{q=m.one_way_decrypt(t.x25519["private"],f);g=q.subarray(0,z);var p=q.subarray(z);
e=[p.subarray(0,d),p.subarray(d,2*d),p.subarray(2*d,3*d),p.subarray(3*d,3*d+y),p.subarray(3*d+y,3*d+y+F),p.subarray(3*d+y+F,3*d+y+F+d)];v=e[0];var Q=e[1];h=e[2];r=e[3];var A=e[4];var B=e[5];var D=k=new Uint8Array(d+p.length);D.set(l);D.set(p,d);if(m.verify(g,k,v)){var C=x([w,v]);c.j.has(C)||(f={real_public_key:w,target_id:v,secret:B,application:A,number_of_intermediate_nodes:null},c.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=c.P(a,[Q])){a.push(Q);var b=a[0];c.a.construct_routing_path(a).then(function(a){var e=m.Encryptor(!1,t.x25519["private"]);e.put_handshake_message(r);var f=e.get_handshake_message();c.o.set(C,e);c.R(t.ed25519["public"],v,b,a);a=m.sign(h,t.ed25519["public"],t.ed25519["private"]);c.M(w,v,ca,ta(a,h,f))})["catch"](function(a){H(a)})}})["catch"](function(a){H(a)}))}}catch(xa){g=xa,H(g)}break;case O:c.A.has(n)?(e=c.A.get(n),l=e[0],q=e[1],c.a.send_data(l,q,O,f)):c.c.has(n)&&(e=c.c.get(n),w=e[0],v=e[1],
C=x([w,v]),e=c.o.get(C))&&(g=c.H.get(C))&&(e=e.decrypt(f),g.feed(e),g.have_more_data()&&(g=g.get_data(),e=g[0],c.fire("data",w,v,e,g.subarray(1))));break;case ea:if(c.c.has(n)&&c.u.has(n))c.u["delete"](n);else c.X(a,b)}});this.V=this.a.get_max_packet_data_size()-ya}var q=l.random_bytes;var K=l.pull_random_item_from_array;var A=l.are_arrays_equal;var G=l.hex2array;var x=l.concat_arrays;var L=l.timeoutSet;var I=l.intervalSet;var H=l.error_handler;var t=l.ArrayMap;var B=l.ArraySet;h.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=
fa;h.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ha;h.CONNECTION_ERROR_NO_INTRODUCTION_NODES=N;h.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=ia;h.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=ja;h.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ka;h.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=la;h.CONNECTION_PROGRESS_INTRODUCTION_SENT=ma;h.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=na;h.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=oa;h.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=
pa;h.prototype={start_bootstrap_node:function(a,b){this.b.start_bootstrap_node(a,b);this.F=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,b,d){a=m.create_keypair(a);var f=a.ed25519["public"];if(this.g.has(f))return null;this.g.set(f,[a,b,d,B()]);this.S(f);return f},S:function(a){function b(b){var e;b&&p.push(b);--q;if(!q)if(p.length){p=p.concat(l);var f=g.b.generate_announcement_message(a,c.ed25519["private"],p);var d=0;for(e=p.length;d<e;++d)b=p[d],g.M(a,
b,X,f);g.fire("announced",a)}else g.O(a,1),g.fire("announcement_failed",a,oa)}function d(c){var d,g=this;if(d=this.P(m,f.concat(l))){d.push(c);var k=d[0];this.a.construct_routing_path(d).then(function(f){g.R(a,c,k,f);e.add(c);b(c)})["catch"](function(a){H(a);b()})}else this.fire("announcement_failed",a,pa)}var f,g=this;var k=this.g.get(a);var c=k[0];var h=k[1];var m=k[2];var e=k[3];var l=[];e.forEach(function(a){l.push(a)});if(h-=l.length)if(this.O(a,+new Date),f=this.J(h,l)){var q=h;var p=[];k=0;
for(h=f.length;k<h;++k)d.call(this,f[k])}else this.O(a,1),this.fire("announcement_failed",a,na)},O:function(a,b){this.g.get(a)[4]=b},connect_to:function(a,b,n,f,g){var k=this;if(!g)throw Error("Direct connections are not yet supported");var c=m.create_keypair(a);var h=c.ed25519["public"];var l=x([h,b]);if(this.j.has(l))return null;a=this.P(g);if(!a)return this.fire("connection_failed",h,b,ha),null;var e=a[0];var p=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function g(g,w,r,u){function v(){function g(c,
f,d,n){A(e,c)&&A(a,f)&&d===da&&(d=P(n),c=d[0],f=d[1],d=d[2],A(f,u)&&m.verify(c,u,b)&&(y.put_handshake_message(d),k.o.set(l,y),clearTimeout(B),k.a.off("data",g),k.R(h,b,e,a)))}var w,r;if(x.length){var t=K(x);var u=q(d);var E=m.convert_public_key(b);var y=m.Encryptor(!0,E);var D=y.get_handshake_message();D=ra(h,p,u,D,n,f);var C=w=new Uint8Array(d+D.length);C.set(t);C.set(D,d);C=m.sign(w,h,c.ed25519["private"]);w=r=new Uint8Array(D.length+z);w.set(C);w.set(D,z);E=m.one_way_encrypt(E,r);k.a.on("data",
g);k.a.send_data(e,a,ba,sa(u,t,b,E));k.fire("connection_progress",h,b,ma);var B=L(J,function(){k.a.off("data",g);y.destroy();v()})}else k.fire("connection_failed",h,b,ja)}if(A(e,g)&&A(a,w)&&r===Z){g=qa(u);w=g[0];r=g[1];var x=g[2];A(b,r)&&(clearTimeout(t),w!==aa?k.fire("connection_failed",h,b,w):(k.fire("connection_progress",h,b,la),v()))}}k.fire("connection_progress",h,b,ka);k.a.on("data",g);k.a.send_data(e,a,Y,b);var t=L(J,function(){k.a.off("data",g);k.fire("connection_failed",h,b,fa)})})["catch"](function(a){H(a);
k.fire("connection_failed",h,b,ia)});return h},get_max_data_size:function(){return this.C},send_to:function(a,b,d,f){var g,k,c,n=this;var h=x([a,b]);if((g=this.o.get(h))&&!(f.length>this.C)&&(k=this.I.get(h))){var e=c=new Uint8Array(f.length+1);e.set([d]);e.set(f,1);k.feed(c);this.s.has(h)||this.s.set(h,setTimeout(function(){for(n.s["delete"](h);k.have_more_blocks();){var c=k.get_block();c=g.encrypt(c);n.M(a,b,O,c)}}))}},destroy:function(){var a=this;this.ca||(clearInterval(this.aa),clearInterval(this.ea),
clearInterval(this.da),this.h.forEach(function(b){a.Y(b[0],b[1])}),this.l.forEach(function(a){clearTimeout(a[3])}),this.b.destroy(),this.a.destroy(),this.ca=!0)},W:function(){return!!(this.f.size<W||this.U(!0).length)},U:function(a){null==a&&(a=!1);var b=[];var d=+new Date-1E3*za;var f=!1;this.f.forEach(function(g,k){!f&&g<d&&(b.push(k),a&&!f&&(f=!0))});return b},Z:function(){var a,b;if(a=this.K(5)){var d=0;for(b=a.length;d<b;++d){var f=a[d];this.T(f)}}},T:function(a){this.B.add(a);this.D(a,U,new Uint8Array(0))},
P:function(a,b){null==b&&(b=[]);var d=this.K(1,b);return d?(a=this.J(a-1,b.concat([d])))?d.concat(a):null:null},K:function(a,b){var h,f,g=[];null==a&&(a=1);null==b&&(b=[]);if(!this.m.size)return this.b.lookup(q(d)),null;var k=Array.from(this.m.values());var c=0;for(f=(h=this.get_bootstrap_nodes()).length;c<f;++c){var l=h[c];b.push(G(l.node_id))}var m=B(b);k=k.filter(function(a){return!m.has(a)});if(!k.length)return null;for(c=0;c<a;++c)k.length&&g.push(K(k));return g},J:function(a,b){var d=[];if(this.f.size<
a)return null;var f=Array.from(this.f.keys());if(b){var g=B(b);f=f.filter(function(a){return!g.has(a)})}if(f.length<a)return null;for(b=0;b<a;++b)d.push(K(f));return d},R:function(a,b,d,f){var g=x([d,f]);if(!this.c.has(g)){var h=x([a,b]);this.j.set(h,[d,f]);this.c.set(g,[a,b]);this.I.set(h,u.Multiplexer(this.C,this.V));this.H.set(h,u.Demultiplexer(this.C,this.V));this.fire("connected",a,b)}},Y:function(a,b){var d=this;var f=x([a,b]);if(this.h.has(f)&&(this.h["delete"](f),this.a.destroy_routing_path(a,
b),this.u["delete"](f),this.i.forEach(function(a,b){var c=a[0];var e=a[1];a=a[2];c=x([c,e]);A(f,c)&&(clearInterval(a),d.i["delete"](b))}),this.c.has(f))){b=this.c.get(f);a=b[0];b=b[1];var g=x([a,b]);this.c["delete"](f);this.j["delete"](g);this.s.has(g)&&(clearTimeout(this.s.get(g)),this.s["delete"](g));if(this.g.has(a)){var h=this.g.get(a)[3];h["delete"](b)}if(h=this.o.get(g))h.destroy(),this.o["delete"](g);this.I["delete"](g);this.H["delete"](g);this.fire("disconnected",a,b)}},D:function(a,b,d){function f(c){A(a,
c)&&(clearTimeout(h),g.b.off("node_connected",f),g.N(a),g.b.send_data(a,b,d))}var g=this;if(this.m.has(a))this.N(a),this.b.send_data(a,b,d);else{this.b.on("node_connected",f);var h=L(Aa,function(){g.b.off("node_connected",f)});this.b.lookup(a)}},M:function(a,b,d,f){a=x([a,b]);this.j.has(a)&&(b=this.j.get(a),a=b[0],b=b[1],this.a.send_data(a,b,d,f))},X:function(a,b){var d=x([a,b]);if(this.u.has(d)||!this.h.has(d))return!1;this.a.send_data(a,b,ea,new Uint8Array(0));return!0},N:function(a){this.G.has(a)||
this.$(a);this.G.set(a,+new Date)},$:function(a){var b=this.v.get(a)||0;++b;this.v.set(a,b);1===b&&this.b.add_used_tag(a)},ba:function(a){var b;if(b=this.v.get(a))--b,b?this.v.set(a,b):(this.v["delete"](a),this.b.del_used_tag(a))}};h.prototype=Object.assign(Object.create(p.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{enumerable:!1,value:h});return{ready:function(a){function b(){--d;d||a()}var d=2;m.ready(b);r.ready(b)},generate_seed:function(){return m.create_keypair().seed},
Core:h}}var R=0;var S=1;var U=2;var V=3;var X=0;var Y=1;var Z=2;var ba=3;var T=4;var ca=5;var da=6;var O=7;var ea=8;var d=32;var z=64;var y=48;var ya=16;var F=64;var J=30;var Aa=10;var M=60;var wa=1800;var za=300;var W=1E3;var va=30;var aa=0;var N=1;var fa=2;var ha=3;var ia=4;var ja=5;var ka=0;var la=1;var ma=2;var na=0;var oa=1;var pa=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],G):"object"===typeof exports?
module.exports=G(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=G(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);