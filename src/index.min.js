/*
 0BSD
*/
(function(){function ra(m){var t;var l=m[0];var r=m.subarray(1,1+d);var p=[];m=m.subarray(1+d);var h=0;for(t=m.length/d;h<t;++h){var q=h;p.push(m.subarray(q*d,(q+1)*d))}return[l,r,p]}function sa(m,t,l,r,p,h){var q=new Uint8Array(3*d+x+E+d);q.set(m);q.set(t,d);q.set(l,2*d);q.set(r,3*d);q.set(p,3*d+x);q.set(h,3*d+x+E);return q}function ta(m,t,l,r){var p=new Uint8Array(3*d+r.length);p.set(m);p.set(t,d);p.set(l,2*d);p.set(r,3*d);return p}function ua(m,t,l){var r=new Uint8Array(z+d+x);r.set(m);r.set(t,
z);r.set(l,z+d);return r}function Q(m){return[m.subarray(0,z),m.subarray(z,z+d),m.subarray(z+d)]}function va(m,t){var l=new Uint8Array(d+t.length);l.set(m);l.set(t,d);return l}function M(m,t,l,r,p){function h(a,b,n,f,g,k){var c=this;null==f&&(f=1);null==g&&(g=2);null==k&&(k=10);if(!(this instanceof h))return new h(a,b,n,f,g,k);p.call(this);this.g=u();this.w=m.create_keypair(a);this.C=t.MAX_DATA_SIZE;this.m=G();this.f=u();this.B=G();this.h=u();this.j=u();this.c=u();this.v=u();this.G=u();this.L=u();
this.l=u();this.i=u();this.A=u();this.u=G();this.o=u();this.I=u();this.H=u();this.s=u();this.aa=H(N,function(){var a=+new Date-1E3*N;c.L.forEach(function(b,e){if(b<a){if(c.h.has(e)){var d=c.h.get(e);b=d[0];d=d[1];c.Y(b,d)}c.L["delete"](e)}});c.G.forEach(function(b,e){b<a&&(c.ba(e),c.G["delete"](e))})});this.ea=H(N,function(){c.g.forEach(function(a,b){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*J,a<e&&c.S(b));d.forEach(function(a){a=w([b,a]);var e=c.j.get(a);a=e[0];e=e[1];c.X(a,e)&&(a=
w([a,e]),c.u.add(a))})})});this.da=H(wa,function(){c.W()&&c.Z()});this.b=t.DHT(this.w.ed25519["public"],this.w.ed25519["private"],b,n,f,g).on("node_connected",function(a){c.m.add(a);c.W()&&c.T(a)}).on("node_disconnected",function(a){c.m["delete"](a);c.B["delete"](a)}).on("data",function(a,b,e){var k;switch(b){case R:c.a.process_packet(a,e);break;case S:if(c.F)break;b=[e.subarray(0,d),e.subarray(d)];var f=b[0];e=b[1];if(!c.i.has(f))break;b=c.i.get(f);f=b[0];b=b[1];c.a.send_data(f,b,T,e);break;case U:var g=
c.K(7)||[];g=g.concat(c.J(10-g.length)||[]);e=new Uint8Array(g.length*d);b=0;for(k=g.length;b<k;++b){f=b;var n=g[b];e.set(n,f*d)}c.D(a,V,e);break;case V:if(c.B.has(a)&&(c.B["delete"](a),e.length&&0===e.length%d))for(a=e.length/d,g=c.U(),b=0;b<a;++b)if(f=b,f=e.subarray(f*d,(f+1)*d),!A(f,c.w.ed25519["public"])&&!c.m.has(f))if(c.f.has(f)||c.f.size<W)c.f.set(f,+new Date);else if(g.length)k=K(g),c.f["delete"](k),c.f.set(f,+new Date);else break}}).on("ready",function(){c.b.lookup(q(d));c.b.lookup(q(d));
c.b.lookup(q(d));c.fire("ready")});this.a=t.Router(this.w.x25519["private"],k).on("activity",function(a,b){var e=w([a,b]);c.h.has(e)||c.h.set(e,[a,b]);c.N(a);c.L.set(e,+new Date)}).on("send",function(a,b){c.D(a,R,b)}).on("data",function(a,b,e,f){var k;var g=w([a,b]);switch(e){case X:if(c.F)break;var n=c.b.verify_announcement_message(f);if(!n)break;c.i.has(n)&&clearInterval(c.i.get(n)[2]);e=H(xa,function(){c.h.has(g)&&c.b.publish_announcement_message(f)});c.i.set(n,[a,b,e]);c.b.publish_announcement_message(f);
break;case Y:if(c.F)break;var v=f;if(v.length!==d)break;var D=function(e,f){var n=v,g;var k=g=new Uint8Array(1+d+f.length*d);k.set([e]);k.set(n,1);e=0;for(n=f.length;e<n;++e){k=e;var h=f[e];g.set(h,1+d+k*d)}c.a.send_data(a,b,Z,g)};c.b.find_introduction_nodes(v,function(a){a.length?D(aa,a):D(O,[])},function(){D(O,[])});break;case ba:if(c.F)break;e=[f.subarray(0,d),f.subarray(d,2*d),f.subarray(2*d,3*d),f.subarray(3*d)];var h=e[0];var l=e[1];v=e[2];n=e[3];if(c.l.has(h))break;e=L(J,function(){c.l["delete"](h)});
c.l.set(h,[a,b,v,e]);c.D(l,S,va(v,n));break;case ca:e=Q(f);n=e[0];h=e[1];var t=e[2];if(!c.l.has(h))break;e=c.l.get(h);l=e[0];var r=e[1];v=e[2];e=e[3];if(!m.verify(n,h,v))break;c.l["delete"](h);clearTimeout(e);c.a.send_data(l,r,da,f);n=w([l,r]);c.A.set(g,[l,r]);c.A.set(n,[a,b]);break;case T:if(!c.c.has(g))break;e=c.c.get(g);var q=e[0];l=e[1];if(!c.g.has(q))break;e=c.g.get(q);var y=e[0];var u=e[3];if(!u.has(l))break;try{r=m.one_way_decrypt(y.x25519["private"],f);n=r.subarray(0,z);var p=r.subarray(z);
e=[p.subarray(0,d),p.subarray(d,2*d),p.subarray(2*d,3*d),p.subarray(3*d,3*d+x),p.subarray(3*d+x,3*d+x+E),p.subarray(3*d+x+E,3*d+x+E+d)];v=e[0];var I=e[1];h=e[2];t=e[3];var A=e[4];var za=e[5];var C=k=new Uint8Array(d+p.length);C.set(l);C.set(p,d);if(m.verify(n,k,v)){var B=w([q,v]);c.j.has(B)||(f={real_public_key:q,target_id:v,secret:za,application:A,number_of_intermediate_nodes:null},c.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=c.P(a,[I])){a.push(I);var b=a[0];c.a.construct_routing_path(a).then(function(a){var e=m.Encryptor(!1,y.x25519["private"]);e.put_handshake_message(t);var f=e.get_handshake_message();c.o.set(B,e);c.R(y.ed25519["public"],v,b,a);a=m.sign(h,y.ed25519["public"],y.ed25519["private"]);c.M(q,v,ca,ua(a,h,f))})["catch"](function(a){F(a)})}})["catch"](function(a){F(a)}))}}catch(ya){n=ya,F(n)}break;case P:c.A.has(g)?(e=c.A.get(g),l=e[0],r=e[1],c.a.send_data(l,r,P,f)):c.c.has(g)&&(e=c.c.get(g),q=e[0],v=e[1],
B=w([q,v]),e=c.o.get(B))&&(n=c.H.get(B))&&(e=e.decrypt(f),n.feed(e),n.have_more_data()&&(n=n.get_data(),e=n[0],c.fire("data",q,v,e,n.subarray(1))));break;case ea:if(c.c.has(g)&&c.u.has(g))c.u["delete"](g);else c.X(a,b)}});this.V=this.a.get_max_packet_data_size()-Aa}var q=l.random_bytes;var K=l.pull_random_item_from_array;var A=l.are_arrays_equal;var w=l.concat_arrays;var L=l.timeoutSet;var H=l.intervalSet;var F=l.error_handler;var u=l.ArrayMap;var G=l.ArraySet;h.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=
fa;h.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ha;h.CONNECTION_ERROR_NO_INTRODUCTION_NODES=O;h.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=ia;h.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=ja;h.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ka;h.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=la;h.CONNECTION_PROGRESS_INTRODUCTION_SENT=ma;h.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=na;h.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=oa;h.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=
pa;h.prototype={start_bootstrap_node:function(a,b){this.b.start_bootstrap_node(a,b);this.F=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,b,d){a=m.create_keypair(a);var f=a.ed25519["public"];if(this.g.has(f))return null;this.g.set(f,[a,b,d,G()]);this.S(f);return f},S:function(a){function b(b){var e;b&&q.push(b);--r;if(!r)if(q.length){q=q.concat(l);var f=g.b.generate_announcement_message(a,c.ed25519["private"],q);var d=0;for(e=q.length;d<e;++d)b=q[d],g.M(a,
b,X,f);g.fire("announced",a)}else g.O(a,1),g.fire("announcement_failed",a,oa)}function d(c){var d,g=this;if(d=this.P(m,f.concat(l))){d.push(c);var k=d[0];this.a.construct_routing_path(d).then(function(f){g.R(a,c,k,f);e.add(c);b(c)})["catch"](function(a){F(a);b()})}else this.fire("announcement_failed",a,pa)}var f,g=this;var k=this.g.get(a);var c=k[0];var h=k[1];var m=k[2];var e=k[3];var l=[];e.forEach(function(a){l.push(a)});if(h-=l.length)if(this.O(a,+new Date),f=this.J(h,l)){var r=h;var q=[];k=0;
for(h=f.length;k<h;++k)d.call(this,f[k])}else this.O(a,1),this.fire("announcement_failed",a,na)},O:function(a,b){this.g.get(a)[4]=b},connect_to:function(a,b,n,f,g){var k=this;if(!g)throw Error("Direct connections are not yet supported");var c=m.create_keypair(a);var h=c.ed25519["public"];var l=w([h,b]);if(this.j.has(l))return null;a=this.P(g);if(!a)return this.fire("connection_failed",h,b,ha),null;var e=a[0];var r=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function g(g,p,u,y){function v(){function g(c,
f,d,n){A(e,c)&&A(a,f)&&d===da&&(d=Q(n),c=d[0],f=d[1],d=d[2],A(f,y)&&m.verify(c,y,b)&&(x.put_handshake_message(d),k.o.set(l,x),clearTimeout(I),k.a.off("data",g),k.R(h,b,e,a)))}var p,t;if(w.length){var u=K(w);var y=q(d);var D=m.convert_public_key(b);var x=m.Encryptor(!0,D);var C=x.get_handshake_message();C=sa(h,r,y,C,n,f);var B=p=new Uint8Array(d+C.length);B.set(u);B.set(C,d);B=m.sign(p,h,c.ed25519["private"]);p=t=new Uint8Array(C.length+z);p.set(B);p.set(C,z);D=m.one_way_encrypt(D,t);k.a.on("data",
g);k.a.send_data(e,a,ba,ta(y,u,b,D));k.fire("connection_progress",h,b,ma);var I=L(J,function(){k.a.off("data",g);x.destroy();v()})}else k.fire("connection_failed",h,b,ja)}if(A(e,g)&&A(a,p)&&u===Z){g=ra(y);p=g[0];u=g[1];var w=g[2];A(b,u)&&(clearTimeout(t),p!==aa?k.fire("connection_failed",h,b,p):(k.fire("connection_progress",h,b,la),v()))}}k.fire("connection_progress",h,b,ka);k.a.on("data",g);k.a.send_data(e,a,Y,b);var t=L(J,function(){k.a.off("data",g);k.fire("connection_failed",h,b,fa)})})["catch"](function(a){F(a);
k.fire("connection_failed",h,b,ia)});return h},get_max_data_size:function(){return this.C},send_to:function(a,b,d,f){var g,k,c,n=this;var h=w([a,b]);if((g=this.o.get(h))&&!(f.length>this.C)&&(k=this.I.get(h))){var e=c=new Uint8Array(f.length+1);e.set([d]);e.set(f,1);k.feed(c);this.s.has(h)||this.s.set(h,setTimeout(function(){for(n.s["delete"](h);k.have_more_blocks();){var c=k.get_block();c=g.encrypt(c);n.M(a,b,P,c)}}))}},destroy:function(){var a=this;this.ca||(clearInterval(this.aa),clearInterval(this.ea),
clearInterval(this.da),this.h.forEach(function(b){a.Y(b[0],b[1])}),this.l.forEach(function(a){clearTimeout(a[3])}),this.b.destroy(),this.a.destroy(),this.ca=!0)},W:function(){return!!(this.f.size<W||this.U(!0).length)},U:function(a){null==a&&(a=!1);var b=[];var d=+new Date-1E3*Ba;var f=!1;this.f.forEach(function(g,k){!f&&g<d&&(b.push(k),a&&!f&&(f=!0))});return b},Z:function(){var a,b;if(a=this.K(5)){var d=0;for(b=a.length;d<b;++d){var f=a[d];this.T(f)}}},T:function(a){this.B.add(a);this.D(a,U,new Uint8Array(0))},
P:function(a,b){var d=this.K(1,b);return d?(a=this.J(a-1,b))?d.concat(a):null:null},K:function(a,b){var h,f,g=[];null==a&&(a=1);null==b&&(b=[]);if(!this.m.size)return this.b.lookup(q(d)),null;var k=Array.from(this.m.values());var c=0;for(f=(h=this.get_bootstrap_nodes()).length;c<f;++c){var l=h[c];b.push(l.node_id)}k=k.filter(function(a){return!qa(a,b)});if(!k.length)return null;for(c=0;c<a;++c)k.length&&g.push(K(k));return g},J:function(a,b){var d,f=[];if(this.f.size<a)return null;var g=Array.from(this.f.keys());
b&&(g=g.filter(function(a){return!qa(a,b)}));if(g.length<a)return null;for(d=0;d<a;++d)f.push(K(g));return f},R:function(a,b,d,f){var g=w([d,f]);if(!this.c.has(g)){var h=w([a,b]);this.j.set(h,[d,f]);this.c.set(g,[a,b]);this.I.set(h,r.Multiplexer(this.C,this.V));this.H.set(h,r.Demultiplexer(this.C,this.V));this.fire("connected",a,b)}},Y:function(a,b){var d=this;var f=w([a,b]);if(this.h.has(f)&&(this.h["delete"](f),this.a.destroy_routing_path(a,b),this.u["delete"](f),this.i.forEach(function(a,b){var c=
a[0];var e=a[1];a=a[2];c=w([c,e]);A(f,c)&&(clearInterval(a),d.i["delete"](b))}),this.c.has(f))){b=this.c.get(f);a=b[0];b=b[1];var g=w([a,b]);this.c["delete"](f);this.j["delete"](g);this.s.has(g)&&(clearTimeout(this.s.get(g)),this.s["delete"](g));if(this.g.has(a)){var h=this.g.get(a)[3];h["delete"](b)}if(h=this.o.get(g))h.destroy(),this.o["delete"](g);this.I["delete"](g);this.H["delete"](g);this.fire("disconnected",a,b)}},D:function(a,b,d){function f(c){A(a,c)&&(clearTimeout(h),g.b.off("node_connected",
f),g.N(a),g.b.send_data(a,b,d))}var g=this;if(this.m.has(a))this.N(a),this.b.send_data(a,b,d);else{this.b.on("node_connected",f);var h=L(Ca,function(){g.b.off("node_connected",f)});this.b.lookup(a)}},M:function(a,b,d,f){a=w([a,b]);this.j.has(a)&&(b=this.j.get(a),a=b[0],b=b[1],this.a.send_data(a,b,d,f))},X:function(a,b){var d=w([a,b]);if(this.u.has(d)||!this.h.has(d))return!1;this.a.send_data(a,b,ea,new Uint8Array(0));return!0},N:function(a){this.G.has(a)||this.$(a);this.G.set(a,+new Date)},$:function(a){var b=
this.v.get(a)||0;++b;this.v.set(a,b);1===b&&this.b.add_used_tag(a)},ba:function(a){var b;if(b=this.v.get(a))--b,b?this.v.set(a,b):(this.v["delete"](a),this.b.del_used_tag(a))}};h.prototype=Object.assign(Object.create(p.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{enumerable:!1,value:h});return{ready:function(a){function b(){--d;d||a()}var d=2;m.ready(b);t.ready(b)},generate_seed:function(){return m.create_keypair().seed},Core:h}}function qa(d,t){for(var l=-1,m=t.length>>>
0;++l<m;)if(d===t[l])return!0;return!1}var R=0;var S=1;var U=2;var V=3;var X=0;var Y=1;var Z=2;var ba=3;var T=4;var ca=5;var da=6;var P=7;var ea=8;var d=32;var z=64;var x=48;var Aa=16;var E=64;var J=30;var Ca=10;var N=60;var xa=1800;var Ba=300;var W=1E3;var wa=30;var aa=0;var O=1;var fa=2;var ha=3;var ia=4;var ja=5;var ka=0;var la=1;var ma=2;var na=0;var oa=1;var pa=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],
M):"object"===typeof exports?module.exports=M(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=M(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);