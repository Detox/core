/*
 0BSD
*/
(function(){function ua(p){var r;var m=p[0];var x=p.subarray(1,1+e);var w=[];p=p.subarray(1+e);var g=0;for(r=p.length/e;g<r;++g){var q=g;w.push(p.subarray(q*e,(q+1)*e))}return[m,x,w]}function va(p,r,m,x,w,g){var q=new Uint8Array(3*e+C+I+e);q.set(p);q.set(r,e);q.set(m,2*e);q.set(x,3*e);q.set(w,3*e+C);q.set(g,3*e+C+I);return q}function wa(p,r,m,x){var w=new Uint8Array(3*e+x.length);w.set(p);w.set(r,e);w.set(m,2*e);w.set(x,3*e);return w}function xa(p,r,m){var x=new Uint8Array(E+e+C);x.set(p);x.set(r,
E);x.set(m,E+e);return x}function U(p){return[p.subarray(0,E),p.subarray(E,E+e),p.subarray(E+e)]}function ya(p,r){var m=new Uint8Array(e+r.length);m.set(p);m.set(r,e);return m}function J(p,r,m,x,w){function g(a,b,h,f,l,k,n){var c=this;null==f&&(f=1);null==l&&(l=2);null==k&&(k=10);null==n&&(n={});if(!(this instanceof g))return new g(a,b,h,f,l,k,n);w.call(this);this.i=t();this.G=p.create_keypair(a);this.J=r.MAX_DATA_SIZE;this.f=t();this.l=A();this.c=t();this.I=A();this.j=t();this.h=t();this.g=t();this.C=
t();this.A=t();this.R=t();this.s=t();this.o=t();this.H=t();this.B=A();this.v=t();this.N=t();this.M=t();this.w=t();this.D=A();this.ha=L(R,function(){var a=+new Date-1E3*R;c.R.forEach(function(b,d){if(b<a){if(c.j.has(d)){var e=c.j.get(d);b=e[0];e=e[1];c.fa(b,e)}c.R["delete"](d)}});c.A.forEach(function(b,d){b<a&&(c.Z(d),c.A["delete"](d))})});this.la=L(R/5*4,function(){c.i.forEach(function(a,b){var d=a[1];var e=a[3];a=a[4];e.size<d&&a&&(d=+new Date-3*M,a<d&&c.Y(b));e.forEach(function(a){a=u([b,a]);var d=
c.h.get(a);a=d[0];d=d[1];c.X(a,d)&&(a=u([a,d]),c.B.add(a))})})});this.ka=L(Aa,function(){c.da()&&c.ja()});this.a=r.DHT(this.G.ed25519["public"],this.G.ed25519["private"],b,h,f,l,n).on("node_connected",function(a){c.l.add(a);c.c["delete"](a);c.fire("aware_of_nodes_count",c.c.size);c.fire("connected_nodes_count",c.l.size);var b=J(a);if(c.da()){var d=c.get_bootstrap_nodes().map(function(a){return a.node_id});Ba(b,d)||c.aa(a)}}).on("node_disconnected",function(a){c.l["delete"](a);c.fire("connected_nodes_count",
c.l.size);c.I["delete"](a)}).on("data",function(a,b,d){var f;switch(b){case V:c.b.process_packet(a,d);break;case W:b=[d.subarray(0,e),d.subarray(e)];var h=b[0];d=b[1];if(!c.o.has(h))break;b=c.o.get(h);h=b[0];b=b[1];c.m(h,b,X,d);break;case Y:var k=c.P(7)||[];k=k.concat(c.O(10-k.length)||[]);d=new Uint8Array(k.length*e);b=0;for(f=k.length;b<f;++b){h=b;var n=k[b];d.set(n,h*e)}c.K(a,Z,d);break;case Z:if(c.I.has(a)&&(c.I["delete"](a),d.length&&0===d.length%e))for(a=d.length/e,k=c.ba(),b=0;b<a;++b)if(h=
b,h=d.subarray(h*e,(h+1)*e),!D(h,c.G.ed25519["public"])&&!c.l.has(h))if(c.c.has(h)||c.c.size<aa)c.c.set(h,+new Date),c.fire("aware_of_nodes_count",c.c.size);else if(k.length)f=N(k),c.c["delete"](f),c.c.set(h,+new Date),c.fire("aware_of_nodes_count",c.c.size);else break}}).on("ready",function(){c.a.lookup(q(e));c.a.lookup(q(e));c.a.lookup(q(e));c.fire("ready")});this.b=r.Router(this.G.x25519["private"],k).on("activity",function(a,b){var d=u([a,b]);c.j.has(d)||c.j.set(d,[a,b]);c.T(a);c.R.set(d,+new Date)}).on("send",
function(a,b){c.K(a,V,b)}).on("data",function(a,b,d,f){var h,k;var n=u([a,b]);switch(d){case ba:var l=c.a.verify_announcement_message(f);if(!l)break;c.o.has(l)&&clearInterval(c.o.get(l)[2]);d=L(Ca,function(){c.j.has(n)&&c.a.publish_announcement_message(f)});c.o.set(l,[a,b,d]);c.a.publish_announcement_message(f);break;case ca:var v=f;if(v.length!==e)break;var m=function(d,f){var h=v,l;var k=l=new Uint8Array(1+e+f.length*e);k.set([d]);k.set(h,1);d=0;for(h=f.length;d<h;++d){k=d;var n=f[d];l.set(n,1+
e+k*e)}c.m(a,b,da,l)};c.a.find_introduction_nodes(v,function(a){a.length?m(ea,a):m(S,[])},function(){m(S,[])});break;case fa:d=[f.subarray(0,e),f.subarray(e,2*e),f.subarray(2*e,3*e),f.subarray(3*e)];var y=d[0];var g=d[1];v=d[2];l=d[3];if(c.s.has(y))break;d=O(M,function(){c.s["delete"](y)});c.s.set(y,[a,b,v,d]);c.K(g,W,ya(v,l));break;case ha:d=U(f);l=d[0];y=d[1];var r=d[2];if(!c.s.has(y))break;d=c.s.get(y);g=d[0];var q=d[1];v=d[2];d=d[3];if(!p.verify(l,y,v))break;c.s["delete"](y);clearTimeout(d);c.m(g,
q,ia,f);l=u([g,q]);c.H.set(n,[g,q]);c.H.set(l,[a,b]);break;case X:if(!c.g.has(n))break;d=c.g.get(n);var B=d[0];g=d[1];if(!c.i.has(B))break;d=c.i.get(B);var x=d[0];var t=d[3];if(!t.has(g))break;try{q=p.one_way_decrypt(x.x25519["private"],f);l=q.subarray(0,E);var F=q.subarray(E);d=[F.subarray(0,e),F.subarray(e,2*e),F.subarray(2*e,3*e),F.subarray(3*e,3*e+C),F.subarray(3*e+C,3*e+C+I),F.subarray(3*e+C+I,3*e+C+I+e)];v=d[0];var w=d[1];y=d[2];r=d[3];var D=d[4];var za=d[5];var H=h=new Uint8Array(e+F.length);
H.set(g);H.set(F,e);if(p.verify(l,h,v)){var z=u([B,v]);if(!c.h.has(z)){if(c.f.has(z)){var G=c.f.get(z);if(G.L&&!G.u){var P=0;for(k=B.length;P<k;++P){var A=P;var ja=B[P];if(ja!==v[A]){if(ja>v[A])return;G.u=!0;break}}}}else G={L:!1},c.f.set(z,G);f={real_public_key:B,target_id:v,secret:za,application:D,number_of_intermediate_nodes:null};c.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");if(a=c.V(a,[w])){a.push(w);
var b=a[0];c.b.construct_routing_path(a).then(function(a){var d=p.Encryptor(!1,x.x25519["private"]);d.put_handshake_message(r);var f=d.get_handshake_message();c.v.set(z,d);c.W(B,v,b,a);c.f["delete"](z);c.ea(B,v);a=p.sign(y,B,x.ed25519["private"]);c.S(B,v,ha,xa(a,y,f))})["catch"](function(a){K(a);c.f["delete"](z);G.L&&G.u&&c.fire("connection_failed",B,v,Q)})}})["catch"](function(a){K(a);c.f["delete"](z);G.L&&G.u&&c.fire("connection_failed",B,v,Q)})}}}catch(Da){l=Da,K(l)}break;case T:if(c.H.has(n))d=
c.H.get(n),g=d[0],q=d[1],c.m(g,q,T,f);else if(c.g.has(n)&&(d=c.g.get(n),B=d[0],v=d[1],z=u([B,v]),d=c.v.get(z))&&(l=c.M.get(z)))for(d=d.decrypt(f),l.feed(d);l.have_more_data();)g=l.get_data(),d=g[0],c.fire("data",B,v,d,g.subarray(1));break;case ka:if(c.g.has(n)&&c.B.has(n))c.B["delete"](n);else c.X(a,b)}});this.ca=this.b.get_max_packet_data_size()-Ea}var q=m.random_bytes;var N=m.pull_random_item_from_array;var D=m.are_arrays_equal;var J=m.array2hex;var Fa=m.hex2array;var u=m.concat_arrays;var O=m.timeoutSet;
var L=m.intervalSet;var K=m.error_handler;var t=m.ArrayMap;var A=m.ArraySet;g.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=la;g.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ma;g.CONNECTION_ERROR_NO_INTRODUCTION_NODES=S;g.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=Q;g.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=na;g.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=oa;g.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=pa;g.CONNECTION_PROGRESS_INTRODUCTION_SENT=qa;g.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=
ra;g.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=sa;g.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ta;g.prototype={start_bootstrap_node:function(a,b,h,f){null==h&&(h=a);null==f&&(f=b);this.a.start_bootstrap_node(a,b,h,f);this.F=!0;this.$()},get_bootstrap_nodes:function(){return this.a.get_bootstrap_nodes()},announce:function(a,b,h){if(this.F)return null;a=p.create_keypair(a);var f=a.ed25519["public"];if(this.i.has(f))return null;this.i.set(f,[a,b,h,A()]);this.Y(f);return f},Y:function(a){function b(b){var c;
b&&q.push(b);--m;if(!m)if(q.length){q=q.concat(d);var f=e.a.generate_announcement_message(a,n.ed25519["private"],q);var h=0;for(c=q.length;h<c;++h)b=q[h],e.S(a,b,ba,f);e.fire("announced",a)}else e.U(a,1),e.fire("announcement_failed",a,sa)}function h(c){var h,e=this;if(h=this.V(g,f.concat(d))){h.push(c);var k=h[0];this.b.construct_routing_path(h).then(function(d){e.W(a,c,k,d);p.add(c);b(c)})["catch"](function(a){K(a);b()})}else this.fire("announcement_failed",a,ta)}var f,e=this;var k=this.i.get(a);
var n=k[0];var c=k[1];var g=k[2];var p=k[3];var d=[];p.forEach(function(a){d.push(a)});if(c-=d.length)if(this.U(a,+new Date),f=this.O(c,d)){var m=c;var q=[];k=0;for(c=f.length;k<c;++k)h.call(this,f[k])}else this.U(a,1),this.fire("announcement_failed",a,ra)},U:function(a,b){this.i.get(a)[4]=b},connect_to:function(a,b,h,f,l){function k(a){d.u||(n.f["delete"](m),n.fire("connection_failed",g,b,a))}var n=this;if(this.F)return null;if(!l)throw Error("Direct connections are not yet supported");var c=p.create_keypair(a);
var g=c.ed25519["public"];if(D(g,b))return null;var m=u([g,b]);if(this.f.has(m))return g;var d={L:!0,u:!1};this.f.set(m,d);if(this.h.has(m))return null;a=this.V(l);if(!a)return k(ma),null;var r=a[0];var x=a[a.length-1];this.b.construct_routing_path(a).then(function(a){function l(l,t,u,w){function v(){function l(c,d,f,h){D(r,c)&&D(a,d)&&f===ia&&(f=U(h),c=f[0],d=f[1],f=f[2],D(d,w)&&p.verify(c,w,b)&&(C.put_handshake_message(f),n.v.set(m,C),clearTimeout(G),n.b.off("data",l),n.W(g,b,r,a),n.f["delete"](m),
n.ea(g,b)))}var y,t;if(!d.u)if(F.length){var u=N(F);var w=q(e);var A=p.convert_public_key(b);var C=p.Encryptor(!0,A);var H=C.get_handshake_message();H=va(g,x,w,H,h,f);var z=y=new Uint8Array(e+H.length);z.set(u);z.set(H,e);z=p.sign(y,g,c.ed25519["private"]);y=t=new Uint8Array(H.length+E);y.set(z);y.set(H,E);A=p.one_way_encrypt(A,t);n.b.on("data",l);n.m(r,a,fa,wa(w,u,b,A));n.fire("connection_progress",g,b,qa);var G=O(M,function(){n.b.off("data",l);C.destroy();v()})}else k(na)}if(D(r,l)&&D(a,t)&&u===
da){l=ua(w);t=l[0];u=l[1];var F=l[2];D(b,u)&&(clearTimeout(y),t!==ea?k(t):(n.fire("connection_progress",g,b,pa),v()))}}n.fire("connection_progress",g,b,oa);n.b.on("data",l);n.m(r,a,ca,b);var y=O(M,function(){n.b.off("data",l);k(la)})})["catch"](function(a){K(a);k(Q)});return g},get_max_data_size:function(){return this.J},send_to:function(a,b,h,f){var e,k,n,c=this;if(!this.F){var g=u([a,b]);if((e=this.v.get(g))&&!(f.length>this.J)&&(k=this.N.get(g))){var m=n=new Uint8Array(f.length+1);m.set([h]);m.set(f,
1);k.feed(n);this.w.has(g)||this.w.set(g,setTimeout(function(){for(c.w["delete"](g);k.have_more_blocks();){var d=k.get_block();d=e.encrypt(d);c.S(a,b,T,d)}}))}}},destroy:function(){this.ia||(this.F||this.$(),this.a.destroy(),this.ia=!0)},$:function(){var a=this;clearInterval(this.ha);clearInterval(this.la);clearInterval(this.ka);this.A.forEach(function(b,h){a.Z(h)});this.j.forEach(function(b){a.fa(b[0],b[1])});this.s.forEach(function(a){clearTimeout(a[3])});this.b.destroy()},da:function(){return!this.F&&
!!(this.c.size<aa||this.ba(!0).length)},ba:function(a){null==a&&(a=!1);var b=[];var h=+new Date-1E3*Ga;var f=!1;this.c.forEach(function(e,k){!f&&e<h&&(b.push(k),a&&!f&&(f=!0))});return b},ja:function(){var a,b;if(a=this.P(5)){var h=0;for(b=a.length;h<b;++h){var f=a[h];this.aa(f)}}},aa:function(a){this.I.add(a);this.K(a,Y,new Uint8Array(0))},V:function(a,b){var h;null==b&&(b=[]);var f=null!=(h=this.P(1,b))?h[0]:void 0;return f?(a=this.O(a-1,b.concat([f])))?[f].concat(a):null:null},P:function(a,b){var h,
f,l=[];null==a&&(a=1);null==b&&(b=[]);if(!this.l.size)return this.a.lookup(q(e)),null;var k=Array.from(this.l.values());var g=0;for(f=(h=this.get_bootstrap_nodes()).length;g<f;++g){var c=h[g];b.push(Fa(c.node_id))}var m=A(b);k=k.filter(function(a){return!m.has(a)});if(!k.length)return null;for(g=0;g<a;++g)k.length&&l.push(N(k));return l},O:function(a,b){var h=[];if(this.c.size<a)return null;var f=Array.from(this.c.keys());if(b){var e=A(b);f=f.filter(function(a){return!e.has(a)})}if(f.length<a)return null;
for(b=0;b<a;++b)h.push(N(f));return h},W:function(a,b,e,f){var h=u([e,f]);if(!this.g.has(h)){var g=u([a,b]);this.h.set(g,[e,f]);this.g.set(h,[a,b]);this.N.set(g,x.Multiplexer(this.J,this.ca));this.M.set(g,x.Demultiplexer(this.J,this.ca));this.fire("routing_paths_count",this.h.size)}},fa:function(a,b){var e=this;var f=u([a,b]);if(this.j.has(f)&&(this.j["delete"](f),this.b.destroy_routing_path(a,b),this.B["delete"](f),this.o.forEach(function(a,b){var c=a[0];var h=a[1];a=a[2];c=u([c,h]);D(f,c)&&(clearInterval(a),
e.o["delete"](b))}),this.g.has(f))){b=this.g.get(f);a=b[0];b=b[1];var g=u([a,b]);this.g["delete"](f);this.h["delete"](g);this.w.has(g)&&(clearTimeout(this.w.get(g)),this.w["delete"](g));if(this.i.has(a)){var k=this.i.get(a)[3];k["delete"](b)}if(k=this.v.get(g))k.destroy(),this.v["delete"](g);this.N["delete"](g);this.M["delete"](g);this.ma(a,b);this.fire("routing_paths_count",this.h.size)}},ea:function(a,b){var e=u([a,b]);this.D.add(e);this.fire("connected",a,b);this.fire("application_connections_count",
this.D.size)},ma:function(a,b){var e=u([a,b]);this.D.has(e)&&(this.D["delete"](e),this.fire("disconnected",a,b),this.fire("application_connections_count",this.D.size))},K:function(a,b,e){function f(k){D(a,k)&&(clearTimeout(h),g.a.off("node_connected",f),g.T(a),g.a.send_data(a,b,e))}var g=this;if(this.l.has(a))this.T(a),this.a.send_data(a,b,e);else{this.a.on("node_connected",f);var h=O(Ha,function(){g.a.off("node_connected",f)});this.a.lookup(a)}},S:function(a,b,e,f){a=u([a,b]);this.h.has(a)&&(b=this.h.get(a),
a=b[0],b=b[1],this.m(a,b,e,f))},m:function(a,b,e,f){0===f.length&&(f=new Uint8Array(1));return this.b.send_data(a,b,e,f)},X:function(a,b){var e=u([a,b]);if(this.B.has(e)||!this.j.has(e))return!1;this.m(a,b,ka,new Uint8Array(0));return!0},T:function(a){this.A.has(a)||this.ga(a);this.A.set(a,+new Date)},ga:function(a){var b=this.C.get(a)||0;++b;this.C.set(a,b);1===b&&this.a.add_used_tag(a)},Z:function(a){var b;if(b=this.C.get(a))--b,b?this.C.set(a,b):(this.C["delete"](a),this.a.del_used_tag(a))}};g.prototype=
Object.assign(Object.create(w.prototype),g.prototype);Object.defineProperty(g.prototype,"constructor",{value:g});return{ready:function(a){p.ready(function(){r.ready(function(){a()})})},generate_seed:function(){return q(e)},Core:g}}function Ba(e,r){for(var m=-1,p=r.length>>>0;++m<p;)if(e===r[m])return!0;return!1}var V=0;var W=1;var Y=2;var Z=3;var ba=0;var ca=1;var da=2;var fa=3;var X=4;var ha=5;var ia=6;var T=7;var ka=8;var e=32;var E=64;var C=48;var Ea=16;var I=64;var M=30;var Ha=10;var R=60;var Ca=
1800;var Ga=300;var aa=1E3;var Aa=30;var ea=0;var S=1;var la=2;var ma=3;var Q=4;var na=5;var oa=0;var pa=1;var qa=2;var ra=0;var sa=1;var ta=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],J):"object"===typeof exports?module.exports=J(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=J(this.detox_crypto,
this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);