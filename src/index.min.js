/*
 0BSD
*/
(function(){function xa(n){var q;var k=n[0];var x=n.subarray(1,1+f);var J=[];n=n.subarray(1+f);var v=0;for(q=n.length/f;v<q;++v){var l=v;J.push(n.subarray(l*f,(l+1)*f))}return[k,x,J]}function ya(n,q,k,x,v,C){var l=new Uint8Array(3*f+B+K+f);l.set(n);l.set(q,f);l.set(k,2*f);l.set(x,3*f);l.set(v,3*f+B);l.set(C,3*f+B+K);return l}function za(n,q,k,v){var x=new Uint8Array(3*f+v.length);x.set(n);x.set(q,f);x.set(k,2*f);x.set(v,3*f);return x}function Aa(n,q,k){var x=new Uint8Array(v+f+B);x.set(n);x.set(q,
v);x.set(k,v+f);return x}function V(n){return[n.subarray(0,v),n.subarray(v,v+f),n.subarray(v+f)]}function Ba(n,v){var k=new Uint8Array(f+v.length);k.set(n);k.set(v,f);return k}function H(n,q,k,x,J){function C(a){return n.create_keypair(a)}function l(a,b,g,d,h,m,p){var c=this;null==d&&(d=1);null==h&&(h=2);null==m&&(m=10);null==p&&(p={});if(!(this instanceof l))return new l(a,b,g,d,h,m,p);J.call(this);this.i=r();this.H=C(a);this.K=q.MAX_DATA_SIZE;this.F=y();this.f=r();this.l=y();this.b=r();this.J=y();
this.j=r();this.h=r();this.g=r();this.D=r();this.B=r();this.T=r();this.s=r();this.o=r();this.I=r();this.C=y();this.v=r();this.P=r();this.O=r();this.w=r();this.G=y();this.ka=M(S,function(){var a=+new Date-1E3*S;c.T.forEach(function(b,d){if(b<a){if(c.j.has(d)){var e=c.j.get(d);b=e[0];e=e[1];c.ia(b,e)}c.T["delete"](d)}});c.B.forEach(function(b,d){b<a&&(c.ba(d),c.B["delete"](d))});var b=+new Date-2E3*X;c.b.forEach(function(a,d){if(a<b)c.b["delete"](d)})});this.oa=M(S/5*4,function(){c.i.forEach(function(a,
b){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*N,a<e&&c.aa(b));d.forEach(function(a){a=t([b,a]);var e=c.h.get(a);a=e[0];e=e[1];c.ha(a,e)&&(a=t([a,e]),c.C.add(a))})})});this.na=M(Ca,function(){c.$()&&c.ma()});this.a=q.DHT(this.H.ed25519["public"],this.H.ed25519["private"],b,g,d,h,p).on("node_connected",function(a){c.l.add(a);c.b["delete"](a);c.fire("aware_of_nodes_count",c.b.size);c.fire("connected_nodes_count",c.l.size);var b=Da(a);if(c.$()){var e=c.get_bootstrap_nodes().map(function(a){return a.node_id});
Ea(b,e)||c.da(a)}}).on("node_disconnected",function(a){c.l["delete"](a);c.fire("connected_nodes_count",c.l.size);c.J["delete"](a)}).on("data",function(a,b,e){var d;switch(b){case Y:c.c.process_packet(a,e);break;case Z:b=[e.subarray(0,f),e.subarray(f)];var g=b[0];e=b[1];if(!c.o.has(g))break;b=c.o.get(g);g=b[0];b=b[1];c.m(g,b,aa,e);break;case ba:var m=c.S(7)||[];m=m.concat(c.R(10-m.length)||[]);e=new Uint8Array(m.length*f);b=0;for(d=m.length;b<d;++b){g=b;var p=m[b];e.set(p,g*f)}c.M(a,ca,e);break;case ca:if(c.J.has(a)&&
(c.J["delete"](a),e.length&&0===e.length%f))for(a=e.length/f,m=c.ea(),b=0;b<a;++b)if(g=b,g=e.subarray(g*f,(g+1)*f),!D(g,c.H.ed25519["public"])&&!c.l.has(g))if(c.b.has(g)||c.b.size<da)c.b.set(g,+new Date),c.fire("aware_of_nodes_count",c.b.size);else if(m.length)d=O(m),c.b["delete"](d),c.b.set(g,+new Date),c.fire("aware_of_nodes_count",c.b.size);else break}}).on("ready",function(){c.L();c.L();c.L();c.fire("ready")});this.c=q.Router(this.H.x25519["private"],m).on("activity",function(a,b){var e=t([a,
b]);c.j.has(e)||c.j.set(e,[a,b]);c.V(a);c.T.set(e,+new Date)}).on("send",function(a,b){c.M(a,Y,b)}).on("data",function(a,b,e,d){var g,m;var p=t([a,b]);switch(e){case ea:var h=c.a.verify_announcement_message(d);if(!h)break;c.o.has(h)&&clearInterval(c.o.get(h)[2]);e=M(Fa,function(){c.j.has(p)&&c.a.publish_announcement_message(d)});c.o.set(h,[a,b,e]);c.a.publish_announcement_message(d);break;case fa:var u=d;if(u.length!==f)break;var l=function(d,e){var g=u,h;var m=h=new Uint8Array(1+f+e.length*f);m.set([d]);
m.set(g,1);d=0;for(g=e.length;d<g;++d){m=d;var p=e[d];h.set(p,1+f+m*f)}c.m(a,b,ha,h)};c.a.find_introduction_nodes(u,function(a){a.length?l(ia,a):l(T,[])},function(){l(T,[])});break;case ja:e=[d.subarray(0,f),d.subarray(f,2*f),d.subarray(2*f,3*f),d.subarray(3*f)];var k=e[0];var w=e[1];u=e[2];h=e[3];if(c.s.has(k))break;e=P(N,function(){c.s["delete"](k)});c.s.set(k,[a,b,u,e]);c.M(w,Z,Ba(u,h));break;case ka:e=V(d);h=e[0];k=e[1];var x=e[2];if(!c.s.has(k))break;e=c.s.get(k);w=e[0];var q=e[1];u=e[2];e=e[3];
if(!n.verify(h,k,u))break;c.s["delete"](k);clearTimeout(e);c.m(w,q,la,d);h=t([w,q]);c.I.set(p,[w,q]);c.I.set(h,[a,b]);break;case aa:if(!c.g.has(p))break;e=c.g.get(p);var A=e[0];w=e[1];if(!c.i.has(A))break;e=c.i.get(A);var r=e[0];var I=e[3];if(!I.has(w))break;try{q=n.one_way_decrypt(r.x25519["private"],d);h=q.subarray(0,v);var G=q.subarray(v);e=[G.subarray(0,f),G.subarray(f,2*f),G.subarray(2*f,3*f),G.subarray(3*f,3*f+B),G.subarray(3*f+B,3*f+B+K),G.subarray(3*f+B+K,3*f+B+K+f)];u=e[0];var W=e[1];k=e[2];
x=e[3];var D=e[4];var y=e[5];var F=g=new Uint8Array(f+G.length);F.set(w);F.set(G,f);if(n.verify(h,g,u)){var z=t([A,u]);if(!c.h.has(z)){if(c.f.has(z)){var E=c.f.get(z);if(E.N&&!E.u){var Q=0;for(m=A.length;Q<m;++Q){var C=Q;var ma=A[Q];if(ma!==u[C]){if(ma>u[C])return;E.u=!0;break}}}}else E={N:!1},c.f.set(z,E);d={real_public_key:A,target_id:u,secret:y,application:D,number_of_intermediate_nodes:null};c.fire("introduction",d).then(function(){var a=d.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=c.Y(a,[W])){a.push(W);var b=a[0];c.X(a).then(function(a){var d=n.Encryptor(!1,r.x25519["private"]);d.put_handshake_message(x);var e=d.get_handshake_message();c.v.set(z,d);c.Z(A,u,b,a);c.f["delete"](z);c.ga(A,u);a=n.sign(k,A,r.ed25519["private"]);c.U(A,u,ka,Aa(a,k,e))})["catch"](function(a){L(a);c.f["delete"](z);E.N&&E.u&&c.fire("connection_failed",A,u,R)})}})["catch"](function(a){L(a);c.f["delete"](z);E.N&&E.u&&c.fire("connection_failed",A,u,R)})}}}catch(Ga){h=Ga,L(h)}break;case U:if(c.I.has(p))e=
c.I.get(p),w=e[0],q=e[1],c.m(w,q,U,d);else if(c.g.has(p)&&(e=c.g.get(p),A=e[0],u=e[1],z=t([A,u]),e=c.v.get(z))&&(h=c.O.get(z)))for(e=e.decrypt(d),h.feed(e);h.have_more_data();)w=h.get_data(),e=w[0],c.fire("data",A,u,e,w.subarray(1));break;case na:if(c.g.has(p)&&c.C.has(p))c.C["delete"](p);else c.ha(a,b)}});this.fa=this.c.get_max_packet_data_size()-Ha}var H=k.random_bytes;var O=k.pull_random_item_from_array;var D=k.are_arrays_equal;var Da=k.array2hex;var Ia=k.hex2array;var t=k.concat_arrays;var P=
k.timeoutSet;var M=k.intervalSet;var L=k.error_handler;var r=k.ArrayMap;var y=k.ArraySet;l.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=oa;l.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=pa;l.CONNECTION_ERROR_NO_INTRODUCTION_NODES=T;l.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=R;l.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=qa;l.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ra;l.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=sa;l.CONNECTION_PROGRESS_INTRODUCTION_SENT=ta;l.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=
ua;l.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=va;l.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=wa;l.prototype={start_bootstrap_node:function(a,b,g,d){null==g&&(g=a);null==d&&(d=b);this.a.start_bootstrap_node(a,b,g,d);this.A=!0;this.ca()},get_bootstrap_nodes:function(){return this.a.get_bootstrap_nodes()},announce:function(a,b,g){if(this.A)return null;a=C(a);var d=a.ed25519["public"];if(this.i.has(d))return null;this.i.set(d,[a,b,g,y()]);this.aa(d);return d},aa:function(a){function b(b){var c;
b&&n.push(b);--l;if(!l)if(n.length){n=n.concat(e);var d=h.a.generate_announcement_message(a,f.ed25519["private"],n);var g=0;for(c=n.length;g<c;++g)b=n[g],h.U(a,b,ea,d);h.fire("announced",a)}else h.W(a,1),h.fire("announcement_failed",a,va)}function g(c){var g,h=this;if(g=this.Y(w,d.concat(e))){g.push(c);var m=g[0];this.X(g).then(function(d){h.Z(a,c,m,d);k.add(c);b(c)})["catch"](function(a){L(a);b()})}else this.fire("announcement_failed",a,wa)}var d,h=this;var m=this.i.get(a);var f=m[0];var c=m[1];
var w=m[2];var k=m[3];var e=[];k.forEach(function(a){e.push(a)});if(c-=e.length)if(this.W(a,+new Date),d=this.R(c,e)){var l=c;var n=[];m=0;for(c=d.length;m<c;++m)g.call(this,d[m])}else this.W(a,1),this.fire("announcement_failed",a,ua)},W:function(a,b){this.i.get(a)[4]=b},connect_to:function(a,b,g,d,h){function m(a){if(!e.u){p.f["delete"](l);if(q)p.F["delete"](q);p.fire("connection_failed",k,b,a)}}var p=this;if(this.A)return null;if(!h)throw Error("Direct connections are not yet supported");var c=
C(a);var k=c.ed25519["public"];if(D(k,b))return null;var l=t([k,b]);if(this.f.has(l))return k;var e={N:!0,u:!1};this.f.set(l,e);if(this.h.has(l))return null;a=this.Y(h);if(!a)return m(pa),null;var q=a[0];var x=a[a.length-1];this.X(a).then(function(a){function h(h,r,t,y){function u(){function h(c,d,e,g){D(q,c)&&D(a,d)&&e===la&&(e=V(g),c=e[0],d=e[1],e=e[2],D(d,y)&&n.verify(c,y,b)&&(I.put_handshake_message(e),p.v.set(l,I),clearTimeout(E),p.c.off("data",h),p.Z(k,b,q,a),p.f["delete"](l),p.ga(k,b)))}var w,
r;if(!e.u)if(C.length){var t=O(C);var y=H(f);var B=n.convert_public_key(b);var I=n.Encryptor(!0,B);var F=I.get_handshake_message();F=ya(k,x,y,F,g,d);var z=w=new Uint8Array(f+F.length);z.set(t);z.set(F,f);z=n.sign(w,k,c.ed25519["private"]);w=r=new Uint8Array(F.length+v);w.set(z);w.set(F,v);B=n.one_way_encrypt(B,r);p.c.on("data",h);p.m(q,a,ja,za(y,t,b,B));p.fire("connection_progress",k,b,ta);var E=P(N,function(){p.c.off("data",h);I.destroy();u()})}else m(qa)}if(D(q,h)&&D(a,r)&&t===ha){h=xa(y);r=h[0];
t=h[1];var C=h[2];D(b,t)&&(clearTimeout(w),r!==ia?m(r):(p.fire("connection_progress",k,b,sa),u()))}}p.fire("connection_progress",k,b,ra);p.c.on("data",h);p.m(q,a,fa,b);var w=P(N,function(){p.c.off("data",h);m(oa)})})["catch"](function(a){L(a);m(R)});return k},get_max_data_size:function(){return this.K},send_to:function(a,b,g,d){var h,m,f,c=this;if(!this.A){var k=t([a,b]);if((h=this.v.get(k))&&!(d.length>this.K)&&(m=this.P.get(k))){var l=f=new Uint8Array(d.length+1);l.set([g]);l.set(d,1);m.feed(f);
this.w.has(k)||this.w.set(k,setTimeout(function(){for(c.w["delete"](k);m.have_more_blocks();){var d=m.get_block();d=h.encrypt(d);c.U(a,b,U,d)}}))}}},destroy:function(){this.la||(this.A||this.ca(),this.a.destroy(),this.la=!0)},ca:function(){var a=this;clearInterval(this.ka);clearInterval(this.oa);clearInterval(this.na);this.B.forEach(function(b,g){a.ba(g)});this.j.forEach(function(b){a.ia(b[0],b[1])});this.s.forEach(function(a){clearTimeout(a[3])});this.c.destroy()},$:function(){return!this.A&&!!(this.b.size<
da||this.ea(!0).length)},ea:function(a){null==a&&(a=!1);var b=[];var g=+new Date-1E3*X;var d=!1;this.b.forEach(function(h,f){!d&&h<g&&(b.push(f),a&&!d&&(d=!0))});return b},ma:function(){var a,b;if(a=this.S(5)){var g=0;for(b=a.length;g<b;++g){var d=a[g];this.da(d)}}},da:function(a){this.J.add(a);this.M(a,ba,new Uint8Array(0))},Y:function(a,b){var g;null==b&&(b=[]);b=Array.from(this.F.values()).concat(b);var d=null!=(g=this.S(1,b))?g[0]:void 0;return d?(a=this.R(a-1,b.concat([d])))?[d].concat(a):null:
null},S:function(a,b){var g,d,h=[];null==a&&(a=1);null==b&&(b=[]);if(!this.l.size)return this.L(),null;var f=Array.from(this.l.values());var k=0;for(d=(g=this.get_bootstrap_nodes()).length;k<d;++k){var c=g[k];b.push(Ia(c.node_id))}var l=y(b);f=f.filter(function(a){return!l.has(a)});if(!f.length)return null;for(k=0;k<a;++k)f.length&&h.push(O(f));return h},R:function(a,b){var g=[];if(this.b.size<a)return null;var d=Array.from(this.b.keys());if(b){var h=y(b);d=d.filter(function(a){return!h.has(a)})}if(d.length<
a)return null;for(b=0;b<a;++b)g.push(O(d));return g},L:function(){this.a.lookup(C(null).ed25519["public"])},X:function(a){var b=a[0];this.F.add(b);a=this.c.construct_routing_path(a);a["catch"](function(){this.F["delete"](b)});return a},Z:function(a,b,g,d){var h=t([g,d]);if(!this.g.has(h)){var f=t([a,b]);this.h.set(f,[g,d]);this.g.set(h,[a,b]);this.P.set(f,x.Multiplexer(this.K,this.fa));this.O.set(f,x.Demultiplexer(this.K,this.fa));this.fire("routing_paths_count",this.h.size)}},ia:function(a,b){var g=
this;var d=t([a,b]);if(this.j.has(d)&&(this.F["delete"](a),this.j["delete"](d),this.c.destroy_routing_path(a,b),this.C["delete"](d),this.o.forEach(function(a,b){var c=a[0];var f=a[1];a=a[2];c=t([c,f]);D(d,c)&&(clearInterval(a),g.o["delete"](b))}),this.g.has(d))){b=this.g.get(d);a=b[0];b=b[1];var h=t([a,b]);this.g["delete"](d);this.h["delete"](h);this.w.has(h)&&(clearTimeout(this.w.get(h)),this.w["delete"](h));if(this.i.has(a)){var f=this.i.get(a)[3];f["delete"](b)}if(f=this.v.get(h))f.destroy(),this.v["delete"](h);
this.P["delete"](h);this.O["delete"](h);this.pa(a,b);this.fire("routing_paths_count",this.h.size)}},ga:function(a,b){var g=t([a,b]);this.G.add(g);this.fire("connected",a,b);this.fire("application_connections_count",this.G.size)},pa:function(a,b){var g=t([a,b]);this.G.has(g)&&(this.G["delete"](g),this.fire("disconnected",a,b),this.fire("application_connections_count",this.G.size))},M:function(a,b,g){function d(h){D(a,h)&&(clearTimeout(k),f.a.off("node_connected",d),f.V(a),f.a.send_data(a,b,g))}var f=
this;if(this.l.has(a))this.V(a),this.a.send_data(a,b,g);else{this.a.on("node_connected",d);var k=P(Ja,function(){f.a.off("node_connected",d)});this.a.lookup(a)}},U:function(a,b,f,d){a=t([a,b]);this.h.has(a)&&(b=this.h.get(a),a=b[0],b=b[1],this.m(a,b,f,d))},m:function(a,b,f,d){0===d.length&&(d=new Uint8Array(1));return this.c.send_data(a,b,f,d)},ha:function(a,b){var f=t([a,b]);if(this.C.has(f)||!this.j.has(f))return!1;this.m(a,b,na,new Uint8Array(0));return!0},V:function(a){this.B.has(a)||this.ja(a);
this.B.set(a,+new Date)},ja:function(a){var b=this.D.get(a)||0;++b;this.D.set(a,b);1===b&&this.a.add_used_tag(a)},ba:function(a){var b;if(b=this.D.get(a))--b,b?this.D.set(a,b):(this.D["delete"](a),this.a.del_used_tag(a))}};l.prototype=Object.assign(Object.create(J.prototype),l.prototype);Object.defineProperty(l.prototype,"constructor",{value:l});return{ready:function(a){n.ready(function(){q.ready(function(){a()})})},generate_seed:function(){return H(f)},Core:l}}function Ea(f,q){for(var k=-1,n=q.length>>>
0;++k<n;)if(f===q[k])return!0;return!1}var Y=0;var Z=1;var ba=2;var ca=3;var ea=0;var fa=1;var ha=2;var ja=3;var aa=4;var ka=5;var la=6;var U=7;var na=8;var f=32;var v=64;var B=48;var Ha=16;var K=64;var N=30;var Ja=10;var S=60;var Fa=600;var X=300;var da=1E3;var Ca=30;var ia=0;var T=1;var oa=2;var pa=3;var R=4;var qa=5;var ra=0;var sa=1;var ta=2;var ua=0;var va=1;var wa=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],
H):"object"===typeof exports?module.exports=H(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=H(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);