/*
 0BSD
*/
(function(){function G(d){var h=d.length;if(1===h)return d.pop();--h;var p=x(4);p=(new Uint32Array(p.buffer))[0];return d.splice(Math.floor(p/Math.pow(2,32)*(h+1)),1)[0]}function u(d,q){return d.join(",")+q.join(",")}function oa(h){var q;var p=h[0];var r=h.subarray(1,1+d);var f=[];h=h.subarray(1+d);var a=0;for(q=h.length/d;a<q;++a){var b=a;f.push(h.subarray(b*d,(b+1)*d))}return[p,r,f]}function pa(h,q,p,r,f,a){var b=new Uint8Array(3*d+t+y+d);b.set(h);b.set(q,d);b.set(p,2*d);b.set(r,3*d);b.set(f,3*
d+t);b.set(a,3*d+t+y);return b}function qa(h,q,p,r){var f=new Uint8Array(3*d+r.length);f.set(h);f.set(q,d);f.set(p,2*d);f.set(r,3*d);return f}function ra(h,q,p){var r=new Uint8Array(v+d+t);r.set(h);r.set(q,v);r.set(p,v+d);return r}function L(h){return[h.subarray(0,v),h.subarray(v,v+d),h.subarray(v+d)]}function sa(h,q){var p=new Uint8Array(d+q.length);p.set(h);p.set(q,d);return p}function z(d){if(d instanceof Error)return console.error(d)}function F(h,q,p,r){function f(a,b,c,n,g,l,k){var e=this;null==
g&&(g=1);null==l&&(l=2);null==k&&(k=10);if(!(this instanceof f))return new f(a,b,c,n,g,l,k);r.call(this);this.j=h.create_keypair(a);this.B=h.create_keypair(b);this.F=q.MAX_DATA_SIZE;this.o=new Map;this.f=new Map;this.D=new Set;this.g=new Map;this.i=new Map;this.c=new Map;this.l=new Map;this.A=new Map;this.M=new Map;this.u=new Map;this.m=new Map;this.h=new Map;this.C=new Map;this.w=new Set;this.v=0;this.s=new Map;this.J=new Map;this.I=new Map;this.ca=setInterval(function(){var a=+new Date-1E3*I;e.M.forEach(function(b,
d){if(b<a){if(e.g.has(d)){var c=e.g.get(d);b=c[0];c=c[1];e.$(b,c)}e.M["delete"](d)}});e.A.forEach(function(b,d){var c=b[0];b=b[1];c<a&&(e.aa(b),e.A["delete"](d))})},1E3*I);this.fa=setInterval(function(){e.m.forEach(function(b,a){a=e.i.get(a);b=a[0];a=a[1];e.Y(b,a)&&(b=u(b,a),e.w.add(b))});if(e.m.size<e.X&&e.v){var b=+new Date-3*H;e.v<b&&e.S()}},I/2*1E3);this.ea=setInterval(function(){e.W()&&e.da()},1E3*ua);this.Z=function(b){return h.sign(b,e.j.ed25519["public"],e.j.ed25519["private"])};this.b=q.DHT(this.B.ed25519["public"],
this.B.ed25519["private"],c,n,g,l).on("node_connected",function(b){e.o.set(b.join(","),b);e.W()&&e.T(b)}).on("node_disconnected",function(b){b=b.join(",");e.o["delete"](b);e.D["delete"](b)}).on("data",function(b,a,c){var g;switch(a){case O:e.a.process_packet(b,c);break;case P:if(e.H)break;a=[c.subarray(0,d),c.subarray(d)];var l=a[0];c=a[1];a=l.join(",");if(!e.h.has(a))break;a=e.h.get(a);l=a[1];a=a[2];e.a.send_data(l,a,Q,c);break;case R:var h=e.L(7)||[];h=h.concat(e.K(10-h.length)||[]);c=new Uint8Array(h.length*
d);a=0;for(g=h.length;a<g;++a){l=a;var n=h[a];c.set(n,l*d)}e.G(b,S,c);break;case S:if(a=b.join(","),e.D.has(a)&&(e.D["delete"](a),c.length&&0===c.length%d))for(b=c.length/d,h=e.U(),a=0;a<b;++a)if(l=a,l=c.subarray(l*d,(l+1)*d),g=l.join(","),g!==e.B.ed25519["public"].join(",")&&!e.o.has(g))if(e.f.has(g)||e.f.size<T)e.f.set(g,[l,+new Date]);else if(h.length)n=G(h),e.f["delete"](n),e.f.set(g,[l,+new Date]);else break}}).on("ready",function(){e.b.lookup(x(d));e.b.lookup(x(d));e.b.lookup(x(d));e.fire("ready")});
this.a=q.Router(this.B.x25519["private"],k).on("activity",function(a,b){var c=u(a,b);e.g.has(c)||e.g.set(c,[a,b]);e.O(a);e.M.set(c,+new Date)}).on("send",function(a,b){e.G(a,O,b)}).on("data",function(a,b,c,g){var l;var n=u(a,b);switch(c){case U:if(e.H)break;var k=e.b.verify_announcement_message(g);if(!k)break;var m=k.join(",");e.h.has(m)&&clearInterval(e.h.get(m)[3]);c=setInterval(function(){e.g.has(n)&&e.b.publish_announcement_message(g)},1E3*va);e.h.set(m,[k,a,b,c]);e.b.publish_announcement_message(g);
break;case V:if(e.H)break;var f=g;if(f.length!==d)break;var q=function(c,g){var l=f,n;var k=n=new Uint8Array(1+d+g.length*d);k.set([c]);k.set(l,1);c=0;for(l=g.length;c<l;++c){k=c;var h=g[c];n.set(h,1+d+k*d)}e.a.send_data(a,b,W,n)};e.b.find_introduction_nodes(f,function(a){a.length?q(X,a):q(J,[])},function(){q(J,[])});break;case Y:if(e.H)break;m=[g.subarray(0,d),g.subarray(d,2*d),g.subarray(2*d,3*d),g.subarray(3*d)];var p=m[0];c=m[1];f=m[2];k=m[3];var r=p.join(",");if(e.u.has(r))break;m=setTimeout(function(){e.u["delete"](r)},
1E3*H);e.u.set(r,[a,b,f,m]);e.G(c,P,sa(f,k));break;case Z:m=L(g);k=m[0];p=m[1];var N=m[2];r=p.join(",");if(!e.u.has(r))break;m=e.u.get(r);c=m[0];var C=m[1];f=m[2];m=m[3];if(!h.verify(k,p,f))break;clearTimeout(m);e.a.send_data(c,C,aa,g);k=u(c,C);e.C.set(n,[c,C]);e.C.set(k,[a,b]);break;case Q:if(!e.c.has(n))break;c=e.c.get(n);var E=c.join(",");if(!e.m.has(E))break;try{C=h.one_way_decrypt(e.j.x25519["private"],g);k=C.subarray(0,v);var D=C.subarray(v);m=[D.subarray(0,d),D.subarray(d,2*d),D.subarray(2*
d,3*d),D.subarray(3*d,3*d+t),D.subarray(3*d+t,3*d+t+y),D.subarray(3*d+t+y,3*d+t+y+d)];f=m[0];var M=m[1];p=m[2];N=m[3];var ta=m[4];var x=m[5];var B=l=new Uint8Array(d+D.length);B.set(c);B.set(D,d);if(h.verify(k,l,f)){var w=f.join(",");e.i.has(w)||(g={target_id:f,secret:x,application:ta,number_of_intermediate_nodes:null},e.fire("introduction",g).then(function(){var a=g.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");if(a=e.P(a,[M])){a.push(M);var b=a[0];e.a.construct_routing_path(a).then(function(a){var c=
h.Encryptor(!1,e.j.x25519["private"]);c.put_handshake_message(N);var g=c.get_handshake_message();e.s.set(w,c);e.R(f,b,a);a=e.Z(p);e.N(f,Z,ra(a,p,g))})["catch"](function(a){z(a)})}})["catch"](function(a){z(a)}))}}catch(wa){k=wa,z(k)}break;case K:e.C.has(n)?(m=e.C.get(n),c=m[0],C=m[1],e.a.send_data(c,C,K,g)):e.c.has(n)&&(f=e.c.get(n),w=f.join(","),m=e.s.get(w))&&(k=e.I.get(w))&&(m=m.decrypt(g),k.feed(m),k.have_more_data()&&(k=k.get_data(),c=k[0],e.fire("data",f,c,k.subarray(1))));break;case ba:if(e.c.has(n)&&
(f=e.c.get(n),w=f.join(","),e.w.has(n))){e.w["delete"](n);break}e.Y(a,b)}});this.V=this.a.get_max_packet_data_size()-xa}f.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=ca;f.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=da;f.CONNECTION_ERROR_NO_INTRODUCTION_NODES=J;f.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=ea;f.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=fa;f.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ha;f.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=ia;f.CONNECTION_PROGRESS_INTRODUCTION_SENT=
ja;f.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=ka;f.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=la;f.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ma;f.prototype={start_bootstrap_node:function(a,b){this.b.start_bootstrap_node(a,b);this.H=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,b){this.X=a;this.ga=b;this.S()},S:function(){function a(a){var b;a&&f.push(a);--h;if(!h)if(f.length){f=f.concat(k);var e=l.b.generate_announcement_message(l.j.ed25519["public"],
l.j.ed25519["private"],f);var c=0;for(b=f.length;c<b;++c){a=f[c];l.N(a,U,e);var g=a.join(",");l.m.set(g,a)}l.fire("announced")}else l.v=1,l.fire("announcement_failed",la)}function b(b){var c,g=this;if(c=this.P(e,d.concat(k))){c.push(b);var l=c[0];this.a.construct_routing_path(c).then(function(c){g.R(b,l,c);a(b)})["catch"](function(b){z(b);a()})}else this.fire("announcement_failed",ma)}var c,d,g,l=this;var k=[];this.m.forEach(function(a){k.push(a)});if(c=this.X-k.length){var e=this.ga;this.v=+new Date;
if(d=this.K(c,k)){var h=c;var f=[];c=0;for(g=d.length;c<g;++c)b.call(this,d[c])}else this.v=1,this.fire("announcement_failed",ka)}},connect_to:function(a,b,c,n){var g=this;if(!n)throw Error("Direct connections are not yet supported");var l=a.join(",");if(!this.i.has(l))if(n=this.P(n)){var k=n[0];var e=n[n.length-1];this.a.construct_routing_path(n).then(function(n){function f(a,n,f,t){function m(){function a(b,c,e,d){if(p===b.join(",")&&q===c.join(",")&&e===aa){var f=L(d);e=f[0];d=f[1];f=f[2];d.join(",")===
E.join(",")&&h.verify(e,E,A)&&(z.put_handshake_message(f),g.s.set(l,z),clearTimeout(F),g.a.off("data",a),g.R(A,b,c))}}var f,r;if(u.length){var t=G(u);var E=x(d);var y=h.convert_public_key(A);var z=h.Encryptor(!0,y);var B=z.get_handshake_message();B=pa(g.j.ed25519["public"],e,E,B,b,c);var w=f=new Uint8Array(d+B.length);w.set(t);w.set(B,d);w=g.Z(f);f=r=new Uint8Array(B.length+v);f.set(w);f.set(B,v);y=h.one_way_encrypt(y,r);g.a.on("data",a);g.a.send_data(k,n,Y,qa(E,t,A,y));g.fire("connection_progress",
A,ja);var F=setTimeout(function(){g.a.off("data",a);z.destroy();m()},1E3*H)}else g.fire("connection_failed",A,fa)}if(p===a.join(",")&&q===n.join(",")&&f===W){a=oa(t);f=a[0];var A=a[1];var u=a[2];l===A.join(",")&&(clearTimeout(r),f!==X?g.fire("connection_failed",A,f):(g.fire("connection_progress",A,ia),m()))}}g.fire("connection_progress",a,ha);var p=k.join(",");var q=n.join(",");g.a.on("data",f);g.a.send_data(k,n,V,a);var r=setTimeout(function(){g.a.off("data",f);g.fire("connection_failed",a,ca)},
1E3*H)})["catch"](function(b){z(b);g.fire("connection_failed",a,ea)})}else this.fire("connection_failed",a,da)},get_max_data_size:function(){return this.F},send_to:function(a,b,c){var d,g;var f=a.join(",");if((d=this.s.get(f))&&!(c.length>this.F)&&(f=this.J.get(f))){var k=g=new Uint8Array(c.length+1);k.set([b]);k.set(c,1);for(f.feed(g);f.have_more_blocks();)b=f.get_block(),b=d.encrypt(b),this.N(a,K,b)}},destroy:function(){var a=this;clearInterval(this.ca);clearInterval(this.fa);clearInterval(this.ea);
this.g.forEach(function(b){a.$(b[0],b[1])});this.u.forEach(function(a){clearTimeout(a[3])});this.b.destroy();this.a.destroy()},W:function(){return!!(this.f.size<T||this.U(!0).length)},U:function(a){var b,c;null==a&&(a=!1);var d=[];var g=+new Date-1E3*ya;var f=0;for(c=(b=Array.from(this.f.values())).length;f<c;++f){var k=b[f];var e=k[0];k=k[1];if(k<g&&(d.push(e.join(",")),a))break}return d},da:function(){var a,b;if(a=this.L(5)){var c=0;for(b=a.length;c<b;++c){var d=a[c];this.T(d)}}},T:function(a){this.D.add(a.join(","));
this.G(a,R,new Uint8Array(0))},P:function(a,b){var c=this.L(1,b);return c?(a=this.K(a-1,b))?c.concat(a):null:null},L:function(a,b){var c,f,g=[];null==a&&(a=1);null==b&&(b=[]);if(!this.o.size)return this.b.lookup(x(d)),null;var h=Array.from(this.o.values());var k=0;for(f=(c=this.get_bootstrap_nodes()).length;k<f;++k){var e=c[k];b.push(e.node_id)}h=h.filter(function(a){return!na(a,b)});if(!h.length)return null;for(k=0;k<a;++k)h.length&&g.push(G(h));return g},K:function(a,b){var c,d=[];if(this.f.size<
a)return null;var f=Array.from(this.f.values());b&&(f=f.filter(function(a){return!na(a,b)}));if(f.length<a)return null;for(c=0;c<a;++c)d.push(G(f)[0]);return d},R:function(a,b,c){var d=u(b,c);var f=a.join(",");this.c.has(d)||(this.i.set(f,[b,c]),this.c.set(d,a),this.J.set(f,p.Multiplexer(this.F,this.V)),this.I.set(f,p.Demultiplexer(this.F,this.V)),this.fire("connected",a))},$:function(a,b){var c,f=this;var d=u(a,b);if(this.g.has(d)&&(this.g["delete"](d),this.a.destroy_routing_path(a,b),this.c["delete"](d),
this.w["delete"](d),this.h.forEach(function(a,b){var c=a[1];var g=a[2];a=a[3];d===u(c,g)&&(clearInterval(a),f.h["delete"](b))}),a=this.c.get(d))){b=a.join(",");this.i["delete"](b);this.m["delete"](b);if(c=this.s.get(b))c.destroy(),this.s["delete"](b);this.J["delete"](b);this.I["delete"](b);this.fire("disconnected",a)}},G:function(a,b,c){function d(a){h===a.join(",")&&(clearTimeout(k),f.b.off("node_connected",d),f.O(a),f.b.send_data(a,b,c))}var f=this;var h=a.join(",");if(this.o.has(h))this.O(a),this.b.send_data(a,
b,c);else{this.b.on("node_connected",d);var k=setTimeout(function(){f.b.off("node_connected",d)},1E3*za);this.b.lookup(a)}},N:function(a,b,c){a=a.join(",");if(this.i.has(a)){var d=this.i.get(a);a=d[0];d=d[1];this.a.send_data(a,d,b,c)}},Y:function(a,b){var c=u(a,b);if(this.w.has(c)||!this.g.has(c))return!1;this.a.send_data(a,b,ba,new Uint8Array(0));return!0},O:function(a){var b=a.join(",");this.A.has(b)||this.ba(a);this.A.set(b,[+new Date,a])},ba:function(a){var b=a.join(",");var c=0;this.l.has(b)&&
(c=this.l.get(b));++c;this.l.set(b,c);1===c&&this.b.add_used_tag(a)},aa:function(a){var b=a.join(",");if(this.l.has(b)){var c=this.l.get(b);--c;c?this.l.set(b,c):(this.l["delete"](b),this.b.del_used_tag(a))}}};f.prototype=Object.assign(Object.create(r.prototype),f.prototype);Object.defineProperty(f.prototype,"constructor",{enumerable:!1,value:f});return{ready:function(a){function b(){--c;c||a()}var c=2;h.ready(b);q.ready(b)},generate_seed:function(){return h.create_keypair().seed},Core:f}}function na(d,
q){for(var h=-1,r=q.length>>>0;++h<r;)if(d===q[h])return!0;return!1}var x;var O=0;var P=1;var R=2;var S=3;var U=0;var V=1;var W=2;var Y=3;var Q=4;var Z=5;var aa=6;var K=7;var ba=8;var d=32;var v=64;var t=48;var xa=16;var y=64;var H=30;var za=10;var I=60;var va=1800;var ya=300;var T=1E3;var ua=30;var X=0;var J=1;var ca=2;var da=3;var ea=4;var fa=5;var ha=0;var ia=1;var ja=2;var ka=0;var la=1;var ma=2;"undefined"!==typeof crypto?x=function(d){d=new Uint8Array(d);crypto.getRandomValues(d);return d}:
x=require("crypto").randomBytes;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","fixed-size-multiplexer","async-eventer"],F):"object"===typeof exports?module.exports=F(require("@detox/crypto"),require("@detox/transport"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=F(this.detox_crypto,this.detox_transport,this.fixed_size_multiplexer,this.async_eventer)}).call(this);