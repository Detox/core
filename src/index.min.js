/*
 0BSD
*/
(function(){function ua(l){var n;var f=l[0];var t=l.subarray(1,1+d);var y=[];l=l.subarray(1+d);var m=0;for(n=l.length/d;m<n;++m){var x=m;y.push(l.subarray(x*d,(x+1)*d))}return[f,t,y]}function va(l,n,f,t,y,m){var x=new Uint8Array(3*d+C+G+d);x.set(l);x.set(n,d);x.set(f,2*d);x.set(t,3*d);x.set(y,3*d+C);x.set(m,3*d+C+G);return x}function wa(l,n,f,t){var y=new Uint8Array(3*d+t.length);y.set(l);y.set(n,d);y.set(f,2*d);y.set(t,3*d);return y}function xa(l,n,f){var t=new Uint8Array(E+d+C);t.set(l);t.set(n,
E);t.set(f,E+d);return t}function T(l){return[l.subarray(0,E),l.subarray(E,E+d),l.subarray(E+d)]}function ya(l,n){var f=new Uint8Array(d+n.length);f.set(l);f.set(n,d);return f}function H(l,n,f,t,y){function m(a,c,g,w,k,h){var b=this;null==w&&(w=1);null==k&&(k=2);null==h&&(h=10);if(!(this instanceof m))return new m(a,c,g,w,k,h);y.call(this);this.h=p();this.B=l.create_keypair(a);this.F=n.MAX_DATA_SIZE;this.c=p();this.s=B();this.g=p();this.D=B();this.i=p();this.l=p();this.f=p();this.A=p();this.J=p();
this.P=p();this.m=p();this.j=p();this.C=p();this.w=B();this.u=p();this.M=p();this.L=p();this.v=p();this.K=B();this.fa=J(P,function(){var a=+new Date-1E3*P;b.P.forEach(function(c,e){if(c<a){if(b.i.has(e)){var d=b.i.get(e);c=d[0];d=d[1];b.ca(c,d)}b.P["delete"](e)}});b.J.forEach(function(c,e){c<a&&(b.da(e),b.J["delete"](e))})});this.ja=J(P,function(){b.h.forEach(function(a,c){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*K,a<e&&b.W(c));d.forEach(function(a){a=u([c,a]);var e=b.l.get(a);a=e[0];
e=e[1];b.ba(a,e)&&(a=u([a,e]),b.w.add(a))})})});this.ia=J(Aa,function(){b.$()&&b.ha()});this.b=n.DHT(this.B.ed25519["public"],this.B.ed25519["private"],c,g,w,k).on("node_connected",function(a){b.s.add(a);b.$()&&b.X(a)}).on("node_disconnected",function(a){b.s["delete"](a);b.D["delete"](a)}).on("data",function(a,c,e){var w;switch(c){case U:b.a.process_packet(a,e);break;case V:if(b.I)break;c=[e.subarray(0,d),e.subarray(d)];var g=c[0];e=c[1];if(!b.j.has(g))break;c=b.j.get(g);g=c[0];c=c[1];b.a.send_data(g,
c,W,e);break;case X:var h=b.O(7)||[];h=h.concat(b.N(10-h.length)||[]);e=new Uint8Array(h.length*d);c=0;for(w=h.length;c<w;++c){g=c;var k=h[c];e.set(k,g*d)}b.G(a,Y,e);break;case Y:if(b.D.has(a)&&(b.D["delete"](a),e.length&&0===e.length%d))for(a=e.length/d,h=b.Y(),c=0;c<a;++c)if(g=c,g=e.subarray(g*d,(g+1)*d),!F(g,b.B.ed25519["public"])&&!b.s.has(g))if(b.g.has(g)||b.g.size<Z)b.g.set(g,+new Date);else if(h.length)w=L(h),b.g["delete"](w),b.g.set(g,+new Date);else break}}).on("ready",function(){b.b.lookup(x(d));
b.b.lookup(x(d));b.b.lookup(x(d));b.fire("ready")});this.a=n.Router(this.B.x25519["private"],h).on("activity",function(a,c){var e=u([a,c]);b.i.has(e)||b.i.set(e,[a,c]);b.S(a);b.P.set(e,+new Date)}).on("send",function(a,c){b.G(a,U,c)}).on("data",function(a,c,e,g){var w,h;var k=u([a,c]);switch(e){case aa:if(b.I)break;var v=b.b.verify_announcement_message(g);if(!v)break;b.j.has(v)&&clearInterval(b.j.get(v)[2]);e=J(Ba,function(){b.i.has(k)&&b.b.publish_announcement_message(g)});b.j.set(v,[a,c,e]);b.b.publish_announcement_message(g);
break;case ba:if(b.I)break;var r=g;if(r.length!==d)break;var m=function(e,g){var w=r,h;var k=h=new Uint8Array(1+d+g.length*d);k.set([e]);k.set(w,1);e=0;for(w=g.length;e<w;++e){k=e;var q=g[e];h.set(q,1+d+k*d)}b.a.send_data(a,c,ca,h)};b.b.find_introduction_nodes(r,function(a){a.length?m(da,a):m(R,[])},function(){m(R,[])});break;case ea:if(b.I)break;e=[g.subarray(0,d),g.subarray(d,2*d),g.subarray(2*d,3*d),g.subarray(3*d)];var q=e[0];var f=e[1];r=e[2];v=e[3];if(b.m.has(q))break;e=M(K,function(){b.m["delete"](q)});
b.m.set(q,[a,c,r,e]);b.G(f,V,ya(r,v));break;case fa:e=T(g);v=e[0];q=e[1];var x=e[2];if(!b.m.has(q))break;e=b.m.get(q);f=e[0];var n=e[1];r=e[2];e=e[3];if(!l.verify(v,q,r))break;b.m["delete"](q);clearTimeout(e);b.a.send_data(f,n,ha,g);v=u([f,n]);b.C.set(k,[f,n]);b.C.set(v,[a,c]);break;case W:if(!b.f.has(k))break;e=b.f.get(k);var z=e[0];f=e[1];if(!b.h.has(z))break;e=b.h.get(z);var p=e[0];var Q=e[3];if(!Q.has(f))break;try{n=l.one_way_decrypt(p.x25519["private"],g);v=n.subarray(0,E);var t=n.subarray(E);
e=[t.subarray(0,d),t.subarray(d,2*d),t.subarray(2*d,3*d),t.subarray(3*d,3*d+C),t.subarray(3*d+C,3*d+C+G),t.subarray(3*d+C+G,3*d+C+G+d)];r=e[0];var y=e[1];q=e[2];x=e[3];var za=e[4];var F=e[5];var B=w=new Uint8Array(d+t.length);B.set(f);B.set(t,d);if(l.verify(v,w,r)){var A=u([z,r]);if(!b.l.has(A)){if(b.c.has(A)){var D=b.c.get(A);if(D.H&&!D.o){var N=0;for(h=z.length;N<h;++N){var ia=N;var ja=z[N];if(ja!==r[ia]){if(ja>r[ia])return;D.o=!0;break}}}}else D={H:!1},b.c.set(A,D);g={real_public_key:z,target_id:r,
secret:F,application:za,number_of_intermediate_nodes:null};b.fire("introduction",g).then(function(){var a=g.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");if(a=b.U(a,[y])){a.push(y);var c=a[0];b.a.construct_routing_path(a).then(function(a){var e=l.Encryptor(!1,p.x25519["private"]);e.put_handshake_message(x);var g=e.get_handshake_message();b.u.set(A,e);b.V(z,r,c,a);b.c["delete"](A);b.aa(z,r);a=l.sign(q,z,p.ed25519["private"]);b.R(z,r,fa,xa(a,q,g))})["catch"](function(a){I(a);
b.c["delete"](A);D.H&&D.o&&b.fire("connection_failed",z,r,O)})}})["catch"](function(a){I(a);b.c["delete"](A);D.H&&D.o&&b.fire("connection_failed",z,r,O)})}}}catch(Ca){v=Ca,I(v)}break;case S:if(b.C.has(k))e=b.C.get(k),f=e[0],n=e[1],b.a.send_data(f,n,S,g);else if(b.f.has(k)&&(e=b.f.get(k),z=e[0],r=e[1],A=u([z,r]),e=b.u.get(A))&&(v=b.L.get(A)))for(e=e.decrypt(g),v.feed(e);v.have_more_data();)f=v.get_data(),e=f[0],b.fire("data",z,r,e,f.subarray(1));break;case ka:if(b.f.has(k)&&b.w.has(k))b.w["delete"](k);
else b.ba(a,c)}});this.Z=this.a.get_max_packet_data_size()-Da}var x=f.random_bytes;var L=f.pull_random_item_from_array;var F=f.are_arrays_equal;var H=f.hex2array;var u=f.concat_arrays;var M=f.timeoutSet;var J=f.intervalSet;var I=f.error_handler;var p=f.ArrayMap;var B=f.ArraySet;m.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=la;m.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ma;m.CONNECTION_ERROR_NO_INTRODUCTION_NODES=R;m.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_NODE=O;m.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=
na;m.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=oa;m.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=pa;m.CONNECTION_PROGRESS_INTRODUCTION_SENT=qa;m.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=ra;m.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=sa;m.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ta;m.prototype={start_bootstrap_node:function(a,c){this.b.start_bootstrap_node(a,c);this.I=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,c,g){a=
l.create_keypair(a);var d=a.ed25519["public"];if(this.h.has(d))return null;this.h.set(d,[a,c,g,B()]);this.W(d);return d},W:function(a){function c(c){var e;c&&n.push(c);--m;if(!m)if(n.length){n=n.concat(l);var g=k.b.generate_announcement_message(a,b.ed25519["private"],n);var d=0;for(e=n.length;d<e;++d)c=n[d],k.R(a,c,aa,g);k.fire("announced",a)}else k.T(a,1),k.fire("announcement_failed",a,sa)}function g(b){var g,h=this;if(g=this.U(q,d.concat(l))){g.push(b);var k=g[0];this.a.construct_routing_path(g).then(function(g){h.V(a,
b,k,g);e.add(b);c(b)})["catch"](function(a){I(a);c()})}else this.fire("announcement_failed",a,ta)}var d,k=this;var h=this.h.get(a);var b=h[0];var f=h[1];var q=h[2];var e=h[3];var l=[];e.forEach(function(a){l.push(a)});if(f-=l.length)if(this.T(a,+new Date),d=this.N(f,l)){var m=f;var n=[];h=0;for(f=d.length;h<f;++h)g.call(this,d[h])}else this.T(a,1),this.fire("announcement_failed",a,ra)},T:function(a,c){this.h.get(a)[4]=c},connect_to:function(a,c,g,w,k){function h(a){n.o||(this.c["delete"](e),this.fire("connection_failed",
q,c,a))}var b=this;if(!k)throw Error("Direct connections are not yet supported");var f=l.create_keypair(a);var q=f.ed25519["public"];var e=u([q,c]);if(this.c.has(e))return q;var n={H:!0,o:!1};this.c.set(e,n);if(this.l.has(e))return null;a=this.U(k);if(!a)return h(ma),null;var m=a[0];var t=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function k(k,p,u,v){function y(){function k(g,d,h,w){F(m,g)&&F(a,d)&&h===ha&&(h=T(w),g=h[0],d=h[1],h=h[2],F(d,v)&&l.verify(g,v,c)&&(C.put_handshake_message(h),
b.u.set(e,C),clearTimeout(Q),b.a.off("data",k),b.V(q,c,m,a),b.c["delete"](e),b.aa(q,c)))}var p,r;if(!n.o)if(z.length){var u=L(z);var v=x(d);var B=l.convert_public_key(c);var C=l.Encryptor(!0,B);var A=C.get_handshake_message();A=va(q,t,v,A,g,w);var D=p=new Uint8Array(d+A.length);D.set(u);D.set(A,d);D=l.sign(p,q,f.ed25519["private"]);p=r=new Uint8Array(A.length+E);p.set(D);p.set(A,E);B=l.one_way_encrypt(B,r);b.a.on("data",k);b.a.send_data(m,a,ea,wa(v,u,c,B));b.fire("connection_progress",q,c,qa);var Q=
M(K,function(){b.a.off("data",k);C.destroy();y()})}else h(na)}if(F(m,k)&&F(a,p)&&u===ca){k=ua(v);p=k[0];u=k[1];var z=k[2];F(c,u)&&(clearTimeout(r),p!==da?h(p):(b.fire("connection_progress",q,c,pa),y()))}}b.fire("connection_progress",q,c,oa);b.a.on("data",k);b.a.send_data(m,a,ba,c);var r=M(K,function(){b.a.off("data",k);h(la)})})["catch"](function(a){I(a);h(O)});return q},get_max_data_size:function(){return this.F},send_to:function(a,c,g,d){var k,h,b,w=this;var f=u([a,c]);if((k=this.u.get(f))&&!(d.length>
this.F)&&(h=this.M.get(f))){var e=b=new Uint8Array(d.length+1);e.set([g]);e.set(d,1);h.feed(b);this.v.has(f)||this.v.set(f,setTimeout(function(){for(w.v["delete"](f);h.have_more_blocks();){var b=h.get_block();b=k.encrypt(b);w.R(a,c,S,b)}}))}},destroy:function(){var a=this;this.ga||(clearInterval(this.fa),clearInterval(this.ja),clearInterval(this.ia),this.i.forEach(function(c){a.ca(c[0],c[1])}),this.m.forEach(function(a){clearTimeout(a[3])}),this.b.destroy(),this.a.destroy(),this.ga=!0)},$:function(){return!!(this.g.size<
Z||this.Y(!0).length)},Y:function(a){null==a&&(a=!1);var c=[];var g=+new Date-1E3*Ea;var d=!1;this.g.forEach(function(k,h){!d&&k<g&&(c.push(h),a&&!d&&(d=!0))});return c},ha:function(){var a,c;if(a=this.O(5)){var d=0;for(c=a.length;d<c;++d){var f=a[d];this.X(f)}}},X:function(a){this.D.add(a);this.G(a,X,new Uint8Array(0))},U:function(a,c){null==c&&(c=[]);var d=this.O(1,c);return d?(a=this.N(a-1,c.concat([d])))?d.concat(a):null:null},O:function(a,c){var g,f,k=[];null==a&&(a=1);null==c&&(c=[]);if(!this.s.size)return this.b.lookup(x(d)),
null;var h=Array.from(this.s.values());var b=0;for(f=(g=this.get_bootstrap_nodes()).length;b<f;++b){var l=g[b];c.push(H(l.node_id))}var m=B(c);h=h.filter(function(a){return!m.has(a)});if(!h.length)return null;for(b=0;b<a;++b)h.length&&k.push(L(h));return k},N:function(a,c){var d=[];if(this.g.size<a)return null;var f=Array.from(this.g.keys());if(c){var k=B(c);f=f.filter(function(a){return!k.has(a)})}if(f.length<a)return null;for(c=0;c<a;++c)d.push(L(f));return d},V:function(a,c,d,f){var g=u([d,f]);
if(!this.f.has(g)){var h=u([a,c]);this.l.set(h,[d,f]);this.f.set(g,[a,c]);this.M.set(h,t.Multiplexer(this.F,this.Z));this.L.set(h,t.Demultiplexer(this.F,this.Z))}},ca:function(a,c){var d=this;var f=u([a,c]);if(this.i.has(f)&&(this.i["delete"](f),this.a.destroy_routing_path(a,c),this.w["delete"](f),this.j.forEach(function(a,c){var b=a[0];var e=a[1];a=a[2];b=u([b,e]);F(f,b)&&(clearInterval(a),d.j["delete"](c))}),this.f.has(f))){c=this.f.get(f);a=c[0];c=c[1];var k=u([a,c]);this.f["delete"](f);this.l["delete"](k);
this.v.has(k)&&(clearTimeout(this.v.get(k)),this.v["delete"](k));if(this.h.has(a)){var h=this.h.get(a)[3];h["delete"](c)}if(h=this.u.get(k))h.destroy(),this.u["delete"](k);this.M["delete"](k);this.L["delete"](k);this.ka(a,c)}},aa:function(a,c){var d=u([a,c]);this.K.add(d);this.fire("connected",a,c)},ka:function(a,c){var d=u([a,c]);this.K.has(d)&&(this.K["delete"](d),this.fire("disconnected",a,c))},G:function(a,c,d){function g(b){F(a,b)&&(clearTimeout(h),f.b.off("node_connected",g),f.S(a),f.b.send_data(a,
c,d))}var f=this;if(this.s.has(a))this.S(a),this.b.send_data(a,c,d);else{this.b.on("node_connected",g);var h=M(Fa,function(){f.b.off("node_connected",g)});this.b.lookup(a)}},R:function(a,c,d,f){a=u([a,c]);this.l.has(a)&&(c=this.l.get(a),a=c[0],c=c[1],this.a.send_data(a,c,d,f))},ba:function(a,c){var d=u([a,c]);if(this.w.has(d)||!this.i.has(d))return!1;this.a.send_data(a,c,ka,new Uint8Array(0));return!0},S:function(a){this.J.has(a)||this.ea(a);this.J.set(a,+new Date)},ea:function(a){var c=this.A.get(a)||
0;++c;this.A.set(a,c);1===c&&this.b.add_used_tag(a)},da:function(a){var c;if(c=this.A.get(a))--c,c?this.A.set(a,c):(this.A["delete"](a),this.b.del_used_tag(a))}};m.prototype=Object.assign(Object.create(y.prototype),m.prototype);Object.defineProperty(m.prototype,"constructor",{value:m});return{ready:function(a){l.ready(function(){n.ready(function(){a()})})},generate_seed:function(){return x(d)},Core:m}}var U=0;var V=1;var X=2;var Y=3;var aa=0;var ba=1;var ca=2;var ea=3;var W=4;var fa=5;var ha=6;var S=
7;var ka=8;var d=32;var E=64;var C=48;var Da=16;var G=64;var K=30;var Fa=10;var P=60;var Ba=1800;var Ea=300;var Z=1E3;var Aa=30;var da=0;var R=1;var la=2;var ma=3;var O=4;var na=5;var oa=0;var pa=1;var qa=2;var ra=0;var sa=1;var ta=2;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],H):"object"===typeof exports?module.exports=H(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),
require("async-eventer")):this.detox_core=H(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);