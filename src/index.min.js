/*
 0BSD
*/
(function(){function qa(n){var p;var m=n[0];var w=n.subarray(1,1+d);var q=[];n=n.subarray(1+d);var g=0;for(p=n.length/d;g<p;++g){var v=g;q.push(n.subarray(v*d,(v+1)*d))}return[m,w,q]}function ra(n,p,m,w,q,g){var v=new Uint8Array(3*d+z+E+d);v.set(n);v.set(p,d);v.set(m,2*d);v.set(w,3*d);v.set(q,3*d+z);v.set(g,3*d+z+E);return v}function sa(n,p,m,w){var q=new Uint8Array(3*d+w.length);q.set(n);q.set(p,d);q.set(m,2*d);q.set(w,3*d);return q}function ta(n,p,m){var w=new Uint8Array(A+d+z);w.set(n);w.set(p,
A);w.set(m,A+d);return w}function P(n){return[n.subarray(0,A),n.subarray(A,A+d),n.subarray(A+d)]}function ua(n,p){var m=new Uint8Array(d+p.length);m.set(n);m.set(p,d);return m}function F(n,p,m,w,q){function g(a,b,k,f,l,h){var c=this;null==f&&(f=1);null==l&&(l=2);null==h&&(h=10);if(!(this instanceof g))return new g(a,b,k,f,l,h);q.call(this);this.g=r();this.w=n.create_keypair(a);this.C=p.MAX_DATA_SIZE;this.m=y();this.f=r();this.B=y();this.h=r();this.j=r();this.c=r();this.v=r();this.G=r();this.M=r();
this.l=r();this.i=r();this.A=r();this.u=y();this.o=r();this.J=r();this.I=r();this.s=r();this.H=y();this.ca=H(M,function(){var a=+new Date-1E3*M;c.M.forEach(function(b,e){if(b<a){if(c.h.has(e)){var d=c.h.get(e);b=d[0];d=d[1];c.$(b,d)}c.M["delete"](e)}});c.G.forEach(function(b,e){b<a&&(c.aa(e),c.G["delete"](e))})});this.ga=H(M,function(){c.g.forEach(function(a,b){var e=a[1];var d=a[3];a=a[4];d.size<e&&a&&(e=+new Date-3*J,a<e&&c.T(b));d.forEach(function(a){a=t([b,a]);var e=c.j.get(a);a=e[0];e=e[1];c.Z(a,
e)&&(a=t([a,e]),c.u.add(a))})})});this.fa=H(va,function(){c.X()&&c.ea()});this.b=p.DHT(this.w.ed25519["public"],this.w.ed25519["private"],b,k,f,l).on("node_connected",function(a){c.m.add(a);c.X()&&c.U(a)}).on("node_disconnected",function(a){c.m["delete"](a);c.B["delete"](a)}).on("data",function(a,b,e){var h;switch(b){case Q:c.a.process_packet(a,e);break;case R:if(c.F)break;b=[e.subarray(0,d),e.subarray(d)];var f=b[0];e=b[1];if(!c.i.has(f))break;b=c.i.get(f);f=b[0];b=b[1];c.a.send_data(f,b,S,e);break;
case T:var k=c.L(7)||[];k=k.concat(c.K(10-k.length)||[]);e=new Uint8Array(k.length*d);b=0;for(h=k.length;b<h;++b){f=b;var l=k[b];e.set(l,f*d)}c.D(a,U,e);break;case U:if(c.B.has(a)&&(c.B["delete"](a),e.length&&0===e.length%d))for(a=e.length/d,k=c.V(),b=0;b<a;++b)if(f=b,f=e.subarray(f*d,(f+1)*d),!B(f,c.w.ed25519["public"])&&!c.m.has(f))if(c.f.has(f)||c.f.size<V)c.f.set(f,+new Date);else if(k.length)h=K(k),c.f["delete"](h),c.f.set(f,+new Date);else break}}).on("ready",function(){c.b.lookup(v(d));c.b.lookup(v(d));
c.b.lookup(v(d));c.fire("ready")});this.a=p.Router(this.w.x25519["private"],h).on("activity",function(a,b){var e=t([a,b]);c.h.has(e)||c.h.set(e,[a,b]);c.O(a);c.M.set(e,+new Date)}).on("send",function(a,b){c.D(a,Q,b)}).on("data",function(a,b,e,f){var h;var k=t([a,b]);switch(e){case W:if(c.F)break;var l=c.b.verify_announcement_message(f);if(!l)break;c.i.has(l)&&clearInterval(c.i.get(l)[2]);e=H(wa,function(){c.h.has(k)&&c.b.publish_announcement_message(f)});c.i.set(l,[a,b,e]);c.b.publish_announcement_message(f);
break;case X:if(c.F)break;var u=f;if(u.length!==d)break;var D=function(e,f){var k=u,h;var l=h=new Uint8Array(1+d+f.length*d);l.set([e]);l.set(k,1);e=0;for(k=f.length;e<k;++e){l=e;var g=f[e];h.set(g,1+d+l*d)}c.a.send_data(a,b,Y,h)};c.b.find_introduction_nodes(u,function(a){a.length?D(Z,a):D(N,[])},function(){D(N,[])});break;case aa:if(c.F)break;e=[f.subarray(0,d),f.subarray(d,2*d),f.subarray(2*d,3*d),f.subarray(3*d)];var g=e[0];var m=e[1];u=e[2];l=e[3];if(c.l.has(g))break;e=L(J,function(){c.l["delete"](g)});
c.l.set(g,[a,b,u,e]);c.D(m,R,ua(u,l));break;case ba:e=P(f);l=e[0];g=e[1];var v=e[2];if(!c.l.has(g))break;e=c.l.get(g);m=e[0];var p=e[1];u=e[2];e=e[3];if(!n.verify(l,g,u))break;c.l["delete"](g);clearTimeout(e);c.a.send_data(m,p,ca,f);l=t([m,p]);c.A.set(k,[m,p]);c.A.set(l,[a,b]);break;case S:if(!c.c.has(k))break;e=c.c.get(k);var x=e[0];m=e[1];if(!c.g.has(x))break;e=c.g.get(x);var r=e[0];var w=e[3];if(!w.has(m))break;try{p=n.one_way_decrypt(r.x25519["private"],f);l=p.subarray(0,A);var q=p.subarray(A);
e=[q.subarray(0,d),q.subarray(d,2*d),q.subarray(2*d,3*d),q.subarray(3*d,3*d+z),q.subarray(3*d+z,3*d+z+E),q.subarray(3*d+z+E,3*d+z+E+d)];u=e[0];var I=e[1];g=e[2];v=e[3];var B=e[4];var y=e[5];var da=h=new Uint8Array(d+q.length);da.set(m);da.set(q,d);if(n.verify(l,h,u)){var C=t([x,u]);c.j.has(C)||(f={real_public_key:x,target_id:u,secret:y,application:B,number_of_intermediate_nodes:null},c.fire("introduction",f).then(function(){var a=f.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=c.R(a,[I])){a.push(I);var b=a[0];c.a.construct_routing_path(a).then(function(a){var e=n.Encryptor(!1,r.x25519["private"]);e.put_handshake_message(v);var f=e.get_handshake_message();c.o.set(C,e);c.S(x,u,b,a);c.Y(x,u);a=n.sign(g,x,r.ed25519["private"]);c.N(x,u,ba,ta(a,g,f))})["catch"](function(a){G(a)})}})["catch"](function(a){G(a)}))}}catch(xa){l=xa,G(l)}break;case O:if(c.A.has(k))e=c.A.get(k),m=e[0],p=e[1],c.a.send_data(m,p,O,f);else if(c.c.has(k)&&(e=c.c.get(k),x=e[0],u=e[1],C=t([x,u]),e=c.o.get(C))&&
(l=c.I.get(C)))for(e=e.decrypt(f),l.feed(e);l.have_more_data();)m=l.get_data(),e=m[0],c.fire("data",x,u,e,m.subarray(1));break;case ea:if(c.c.has(k)&&c.u.has(k))c.u["delete"](k);else c.Z(a,b)}});this.W=this.a.get_max_packet_data_size()-ya}var v=m.random_bytes;var K=m.pull_random_item_from_array;var B=m.are_arrays_equal;var F=m.hex2array;var t=m.concat_arrays;var L=m.timeoutSet;var H=m.intervalSet;var G=m.error_handler;var r=m.ArrayMap;var y=m.ArraySet;g.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=
fa;g.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ha;g.CONNECTION_ERROR_NO_INTRODUCTION_NODES=N;g.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=ia;g.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=ja;g.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ka;g.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=la;g.CONNECTION_PROGRESS_INTRODUCTION_SENT=ma;g.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=na;g.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=oa;g.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=
pa;g.prototype={start_bootstrap_node:function(a,b){this.b.start_bootstrap_node(a,b);this.F=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,b,k){a=n.create_keypair(a);var f=a.ed25519["public"];if(this.g.has(f))return null;this.g.set(f,[a,b,k,y()]);this.T(f);return f},T:function(a){function b(b){var e;b&&q.push(b);--p;if(!p)if(q.length){q=q.concat(n);var f=d.b.generate_announcement_message(a,c.ed25519["private"],q);var k=0;for(e=q.length;k<e;++k)b=q[k],d.N(a,
b,W,f);d.fire("announced",a)}else d.P(a,1),d.fire("announcement_failed",a,oa)}function k(c){var d,k=this;if(d=this.R(m,f.concat(n))){d.push(c);var h=d[0];this.a.construct_routing_path(d).then(function(f){k.S(a,c,h,f);e.add(c);b(c)})["catch"](function(a){G(a);b()})}else this.fire("announcement_failed",a,pa)}var f,d=this;var h=this.g.get(a);var c=h[0];var g=h[1];var m=h[2];var e=h[3];var n=[];e.forEach(function(a){n.push(a)});if(g-=n.length)if(this.P(a,+new Date),f=this.K(g,n)){var p=g;var q=[];h=0;
for(g=f.length;h<g;++h)k.call(this,f[h])}else this.P(a,1),this.fire("announcement_failed",a,na)},P:function(a,b){this.g.get(a)[4]=b},connect_to:function(a,b,k,f,l){var h=this;if(!l)throw Error("Direct connections are not yet supported");var c=n.create_keypair(a);var g=c.ed25519["public"];var m=t([g,b]);if(this.j.has(m))return null;a=this.R(l);if(!a)return this.fire("connection_failed",g,b,ha),null;var e=a[0];var q=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function l(l,x,r,t){function u(){function l(c,
f,d,k){B(e,c)&&B(a,f)&&d===ca&&(d=P(k),c=d[0],f=d[1],d=d[2],B(f,t)&&n.verify(c,t,b)&&(z.put_handshake_message(d),h.o.set(m,z),clearTimeout(I),h.a.off("data",l),h.S(g,b,e,a),h.Y(g,b)))}var p,x;if(w.length){var r=K(w);var t=v(d);var D=n.convert_public_key(b);var z=n.Encryptor(!0,D);var y=z.get_handshake_message();y=ra(g,q,t,y,k,f);var C=p=new Uint8Array(d+y.length);C.set(r);C.set(y,d);C=n.sign(p,g,c.ed25519["private"]);p=x=new Uint8Array(y.length+A);p.set(C);p.set(y,A);D=n.one_way_encrypt(D,x);h.a.on("data",
l);h.a.send_data(e,a,aa,sa(t,r,b,D));h.fire("connection_progress",g,b,ma);var I=L(J,function(){h.a.off("data",l);z.destroy();u()})}else h.fire("connection_failed",g,b,ja)}if(B(e,l)&&B(a,x)&&r===Y){l=qa(t);x=l[0];r=l[1];var w=l[2];B(b,r)&&(clearTimeout(p),x!==Z?h.fire("connection_failed",g,b,x):(h.fire("connection_progress",g,b,la),u()))}}h.fire("connection_progress",g,b,ka);h.a.on("data",l);h.a.send_data(e,a,X,b);var p=L(J,function(){h.a.off("data",l);h.fire("connection_failed",g,b,fa)})})["catch"](function(a){G(a);
h.fire("connection_failed",g,b,ia)});return g},get_max_data_size:function(){return this.C},send_to:function(a,b,d,f){var k,h,c,g=this;var m=t([a,b]);if((k=this.o.get(m))&&!(f.length>this.C)&&(h=this.J.get(m))){var e=c=new Uint8Array(f.length+1);e.set([d]);e.set(f,1);h.feed(c);this.s.has(m)||this.s.set(m,setTimeout(function(){for(g.s["delete"](m);h.have_more_blocks();){var c=h.get_block();c=k.encrypt(c);g.N(a,b,O,c)}}))}},destroy:function(){var a=this;this.da||(clearInterval(this.ca),clearInterval(this.ga),
clearInterval(this.fa),this.h.forEach(function(b){a.$(b[0],b[1])}),this.l.forEach(function(a){clearTimeout(a[3])}),this.b.destroy(),this.a.destroy(),this.da=!0)},X:function(){return!!(this.f.size<V||this.V(!0).length)},V:function(a){null==a&&(a=!1);var b=[];var d=+new Date-1E3*za;var f=!1;this.f.forEach(function(k,h){!f&&k<d&&(b.push(h),a&&!f&&(f=!0))});return b},ea:function(){var a,b;if(a=this.L(5)){var d=0;for(b=a.length;d<b;++d){var f=a[d];this.U(f)}}},U:function(a){this.B.add(a);this.D(a,T,new Uint8Array(0))},
R:function(a,b){null==b&&(b=[]);var d=this.L(1,b);return d?(a=this.K(a-1,b.concat([d])))?d.concat(a):null:null},L:function(a,b){var k,f,l=[];null==a&&(a=1);null==b&&(b=[]);if(!this.m.size)return this.b.lookup(v(d)),null;var h=Array.from(this.m.values());var c=0;for(f=(k=this.get_bootstrap_nodes()).length;c<f;++c){var g=k[c];b.push(F(g.node_id))}var m=y(b);h=h.filter(function(a){return!m.has(a)});if(!h.length)return null;for(c=0;c<a;++c)h.length&&l.push(K(h));return l},K:function(a,b){var d=[];if(this.f.size<
a)return null;var f=Array.from(this.f.keys());if(b){var l=y(b);f=f.filter(function(a){return!l.has(a)})}if(f.length<a)return null;for(b=0;b<a;++b)d.push(K(f));return d},S:function(a,b,d,f){var k=t([d,f]);if(!this.c.has(k)){var h=t([a,b]);this.j.set(h,[d,f]);this.c.set(k,[a,b]);this.J.set(h,w.Multiplexer(this.C,this.W));this.I.set(h,w.Demultiplexer(this.C,this.W))}},$:function(a,b){var d=this;var f=t([a,b]);if(this.h.has(f)&&(this.h["delete"](f),this.a.destroy_routing_path(a,b),this.u["delete"](f),
this.i.forEach(function(a,b){var c=a[0];var e=a[1];a=a[2];c=t([c,e]);B(f,c)&&(clearInterval(a),d.i["delete"](b))}),this.c.has(f))){b=this.c.get(f);a=b[0];b=b[1];var g=t([a,b]);this.c["delete"](f);this.j["delete"](g);this.s.has(g)&&(clearTimeout(this.s.get(g)),this.s["delete"](g));if(this.g.has(a)){var h=this.g.get(a)[3];h["delete"](b)}if(h=this.o.get(g))h.destroy(),this.o["delete"](g);this.J["delete"](g);this.I["delete"](g);this.ha(a,b)}},Y:function(a,b){var d=t([a,b]);this.H.add(d);this.fire("connected",
a,b)},ha:function(a,b){var d=t([a,b]);this.H.has(d)&&(this.H["delete"](d),this.fire("disconnected",a,b))},D:function(a,b,d){function f(c){B(a,c)&&(clearTimeout(h),g.b.off("node_connected",f),g.O(a),g.b.send_data(a,b,d))}var g=this;if(this.m.has(a))this.O(a),this.b.send_data(a,b,d);else{this.b.on("node_connected",f);var h=L(Aa,function(){g.b.off("node_connected",f)});this.b.lookup(a)}},N:function(a,b,d,f){a=t([a,b]);this.j.has(a)&&(b=this.j.get(a),a=b[0],b=b[1],this.a.send_data(a,b,d,f))},Z:function(a,
b){var d=t([a,b]);if(this.u.has(d)||!this.h.has(d))return!1;this.a.send_data(a,b,ea,new Uint8Array(0));return!0},O:function(a){this.G.has(a)||this.ba(a);this.G.set(a,+new Date)},ba:function(a){var b=this.v.get(a)||0;++b;this.v.set(a,b);1===b&&this.b.add_used_tag(a)},aa:function(a){var b;if(b=this.v.get(a))--b,b?this.v.set(a,b):(this.v["delete"](a),this.b.del_used_tag(a))}};g.prototype=Object.assign(Object.create(q.prototype),g.prototype);Object.defineProperty(g.prototype,"constructor",{enumerable:!1,
value:g});return{ready:function(a){function b(){--d;d||a()}var d=2;n.ready(b);p.ready(b)},generate_seed:function(){return v(d)},Core:g}}var Q=0;var R=1;var T=2;var U=3;var W=0;var X=1;var Y=2;var aa=3;var S=4;var ba=5;var ca=6;var O=7;var ea=8;var d=32;var A=64;var z=48;var ya=16;var E=64;var J=30;var Aa=10;var M=60;var wa=1800;var za=300;var V=1E3;var va=30;var Z=0;var N=1;var fa=2;var ha=3;var ia=4;var ja=5;var ka=0;var la=1;var ma=2;var na=0;var oa=1;var pa=2;"function"===typeof define&&define.amd?
define(["@detox/crypto","@detox/transport","@detox/utils","fixed-size-multiplexer","async-eventer"],F):"object"===typeof exports?module.exports=F(require("@detox/crypto"),require("@detox/transport"),require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=F(this.detox_crypto,this.detox_transport,this.detox_utils,this.fixed_size_multiplexer,this.async_eventer)}).call(this);