/*
 0BSD
*/
(function(){function I(c,p){return setTimeout(p,1E3*c)}function J(c,p){return setInterval(p,1E3*c)}function K(c){var m=c.length;if(1===m)return c.pop();--m;var r=A(4);r=(new Uint32Array(r.buffer))[0];return c.splice(Math.floor(r/Math.pow(2,32)*(m+1)),1)[0]}function v(c,p){return c.join(",")+p.join(",")}function ta(m){var p;var r=m[0];var q=m.subarray(1,1+c);var l=[];m=m.subarray(1+c);var a=0;for(p=m.length/c;a<p;++a){var b=a;l.push(m.subarray(b*c,(b+1)*c))}return[r,q,l]}function ua(m,p,r,q,l,a){var b=
new Uint8Array(3*c+w+C+c);b.set(m);b.set(p,c);b.set(r,2*c);b.set(q,3*c);b.set(l,3*c+w);b.set(a,3*c+w+C);return b}function va(m,p,r,q){var l=new Uint8Array(3*c+q.length);l.set(m);l.set(p,c);l.set(r,2*c);l.set(q,3*c);return l}function wa(m,p,r){var q=new Uint8Array(y+c+w);q.set(m);q.set(p,y);q.set(r,y+c);return q}function Q(m){return[m.subarray(0,y),m.subarray(y,y+c),m.subarray(y+c)]}function xa(m,p){var r=new Uint8Array(c+p.length);r.set(m);r.set(p,c);return r}function D(c){if(c instanceof Error)return console.error(c)}
function M(m,p,r,q){function l(a,b,n,k,g,e){var d=this;null==k&&(k=1);null==g&&(g=2);null==e&&(e=10);if(!(this instanceof l))return new l(a,b,n,k,g,e);q.call(this);this.i=new Map;this.F=m.create_keypair(a);this.A=p.MAX_DATA_SIZE;this.m=new Map;this.f=new Map;this.w=new Set;this.g=new Map;this.h=new Map;this.c=new Map;this.l=new Map;this.D=new Map;this.K=new Map;this.s=new Map;this.j=new Map;this.v=new Map;this.u=new Set;this.o=new Map;this.H=new Map;this.G=new Map;this.$=J(N,function(){var a=+new Date-
1E3*N;d.K.forEach(function(b,f){if(b<a){if(d.g.has(f)){var c=d.g.get(f);b=c[0];c=c[1];d.X(b,c)}d.K["delete"](f)}});d.D.forEach(function(b,f){var c=b[0];b=b[1];c<a&&(d.aa(b),d.D["delete"](f))})});this.Y=J(N,function(){d.i.forEach(function(b){var a=b[0];var c=b[1];var h=b[3];b=b[4];var e=a.ed25519["public"].join(",");h.size<c&&b&&(a=+new Date-3*L,b<a&&d.R(e));h.forEach(function(b,a){d.h.has(e+a)&&(a=d.h.get(e+a),b=a[0],a=a[1],d.W(b,a)&&(b=v(b,a),d.u.add(b)))})})});this.ca=J(za,function(){d.V()&&d.ba()});
this.b=p.DHT(this.F.ed25519["public"],this.F.ed25519["private"],b,n,k,g).on("node_connected",function(b){d.m.set(b.join(","),b);d.V()&&d.S(b)}).on("node_disconnected",function(b){b=b.join(",");d.m["delete"](b);d.w["delete"](b)}).on("data",function(b,a,f){var e;switch(a){case S:d.a.process_packet(b,f);break;case T:if(d.C)break;a=[f.subarray(0,c),f.subarray(c)];var n=a[0];f=a[1];a=n.join(",");if(!d.j.has(a))break;a=d.j.get(a);n=a[1];a=a[2];d.a.send_data(n,a,U,f);break;case V:var h=d.J(7)||[];h=h.concat(d.I(10-
h.length)||[]);f=new Uint8Array(h.length*c);a=0;for(e=h.length;a<e;++a){n=a;var k=h[a];f.set(k,n*c)}d.B(b,W,f);break;case W:if(a=b.join(","),d.w.has(a)&&(d.w["delete"](a),f.length&&0===f.length%c))for(b=f.length/c,h=d.T(),a=0;a<b;++a)if(n=a,n=f.subarray(n*c,(n+1)*c),e=n.join(","),e!==d.F.ed25519["public"].join(",")&&!d.m.has(e))if(d.f.has(e)||d.f.size<X)d.f.set(e,[n,+new Date]);else if(h.length)k=K(h),d.f["delete"](k),d.f.set(e,[n,+new Date]);else break}}).on("ready",function(){d.b.lookup(A(c));d.b.lookup(A(c));
d.b.lookup(A(c));d.fire("ready")});this.a=p.Router(this.F.x25519["private"],e).on("activity",function(a,b){var c=v(a,b);d.g.has(c)||d.g.set(c,[a,b]);d.M(a);d.K.set(c,+new Date)}).on("send",function(a,b){d.B(a,S,b)}).on("data",function(a,b,f,e){var n;var k=v(a,b);switch(f){case Y:if(d.C)break;var h=d.b.verify_announcement_message(e);if(!h)break;f=h.join(",");d.j.has(f)&&clearInterval(d.j.get(f)[3]);var g=J(Aa,function(){d.g.has(k)&&d.b.publish_announcement_message(e)});d.j.set(f,[h,a,b,g]);d.b.publish_announcement_message(e);
break;case Z:if(d.C)break;var l=e;if(l.length!==c)break;var p=function(e,f){var n=l,h;var k=h=new Uint8Array(1+c+f.length*c);k.set([e]);k.set(n,1);e=0;for(n=f.length;e<n;++e){k=e;var g=f[e];h.set(g,1+c+k*c)}d.a.send_data(a,b,aa,h)};d.b.find_introduction_nodes(l,function(a){a.length?p(ba,a):p(O,[])},function(){p(O,[])});break;case ca:if(d.C)break;f=[e.subarray(0,c),e.subarray(c,2*c),e.subarray(2*c,3*c),e.subarray(3*c)];var r=f[0];g=f[1];l=f[2];h=f[3];var q=r.join(",");if(d.s.has(q))break;f=I(L,function(){d.s["delete"](q)});
d.s.set(q,[a,b,l,f]);d.B(g,T,xa(l,h));break;case da:f=Q(e);h=f[0];r=f[1];var R=f[2];q=r.join(",");if(!d.s.has(q))break;f=d.s.get(q);g=f[0];var u=f[1];l=f[2];f=f[3];if(!m.verify(h,r,l))break;clearTimeout(f);d.a.send_data(g,u,ea,e);h=v(g,u);d.v.set(k,[g,u]);d.v.set(h,[a,b]);break;case U:if(!d.c.has(k))break;f=d.c.get(k);var B=f[0];g=f[1];var t=B.join(",");var A=g.join(",");if(!d.i.has(t))break;f=d.i.get(t);var H=f[0];var ya=f[3];if(!ya.has(A))break;try{u=m.one_way_decrypt(H.x25519["private"],e);h=u.subarray(0,
y);var z=u.subarray(y);f=[z.subarray(0,c),z.subarray(c,2*c),z.subarray(2*c,3*c),z.subarray(3*c,3*c+w),z.subarray(3*c+w,3*c+w+C),z.subarray(3*c+w+C,3*c+w+C+c)];l=f[0];var fa=f[1];r=f[2];R=f[3];var Ba=f[4];var G=f[5];var E=n=new Uint8Array(c+z.length);E.set(g);E.set(z,c);if(m.verify(h,n,l)){var x=l.join(",");d.h.has(t+x)||(e={real_public_key:B,target_id:l,secret:G,application:Ba,number_of_intermediate_nodes:null},d.fire("introduction",e).then(function(){var a=e.number_of_intermediate_nodes;if(!a)throw Error("Direct connections are not yet supported");
if(a=d.O(a,[fa])){a.push(fa);var b=a[0];d.a.construct_routing_path(a).then(function(a){var e=m.Encryptor(!1,H.x25519["private"]);e.put_handshake_message(R);var c=e.get_handshake_message();d.o.set(t+x,e);d.P(H.ed25519["public"],l,b,a);a=m.sign(r,H.ed25519["public"],H.ed25519["private"]);d.L(B,l,da,wa(a,r,c))})["catch"](function(a){D(a)})}})["catch"](function(a){D(a)}))}}catch(F){h=F,D(h)}break;case P:d.v.has(k)?(f=d.v.get(k),g=f[0],u=f[1],d.a.send_data(g,u,P,e)):d.c.has(k)&&(f=d.c.get(k),B=f[0],l=
f[1],t=B.join(","),x=l.join(","),f=d.o.get(t+x))&&(h=d.G.get(t+x))&&(f=f.decrypt(e),h.feed(f),h.have_more_data()&&(h=h.get_data(),f=h[0],d.fire("data",B,l,f,h.subarray(1))));break;case ha:if(d.c.has(k)&&d.u.has(k))d.u["delete"](k);else d.W(a,b)}});this.U=this.a.get_max_packet_data_size()-Ca}l.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=ia;l.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ja;l.CONNECTION_ERROR_NO_INTRODUCTION_NODES=O;l.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=ka;l.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=
la;l.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=ma;l.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=na;l.CONNECTION_PROGRESS_INTRODUCTION_SENT=oa;l.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONNECTED=pa;l.ANNOUNCEMENT_ERROR_NO_INTRODUCTION_NODES_CONFIRMED=qa;l.ANNOUNCEMENT_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=ra;l.prototype={start_bootstrap_node:function(a,b){this.b.start_bootstrap_node(a,b);this.C=!0},get_bootstrap_nodes:function(){return this.b.get_bootstrap_nodes()},announce:function(a,b,c){a=
m.create_keypair(a);var n=a.ed25519["public"];var g=n.join(",");if(this.i.has(g))return null;this.i.set(g,[a,b,c,new Map]);this.R(g);return n},R:function(a){function b(b){var e;b&&q.push(b);--r;if(!r)if(q.length){q=q.concat(p);var c=g.b.generate_announcement_message(m,d.ed25519["private"],q);var n=0;for(e=q.length;n<e;++n){b=q[n];g.L(m,b,Y,c);var h=b.join(",");f.set(h,b)}g.fire("announced",m)}else g.N(a,1),g.fire("announcement_failed",m,qa)}function c(a){var d,e=this;if(d=this.O(l,k.concat(p))){d.push(a);
var c=d[0];this.a.construct_routing_path(d).then(function(d){e.P(m,a,c,d);b(a)})["catch"](function(a){D(a);b()})}else this.fire("announcement_failed",m,ra)}var k,g=this;var e=this.i.get(a);var d=e[0];var h=e[1];var l=e[2];var f=e[3];var m=d.ed25519["public"];var p=[];f.forEach(function(a){p.push(a)});if(h-=p.length)if(this.N(a,+new Date),k=this.I(h,p)){var r=h;var q=[];e=0;for(h=k.length;e<h;++e)c.call(this,k[e])}else this.N(a,1),this.fire("announcement_failed",m,pa)},N:function(a,b){this.i.get(a)[4]=
b},connect_to:function(a,b,n,k,g){var e=this;if(!g)throw Error("Direct connections are not yet supported");var d=m.create_keypair(a);var h=d.ed25519["public"];var l=h.join(",");var f=b.join(",");if(this.h.has(l+f))return null;a=this.O(g);if(!a)return this.fire("connection_failed",h,b,ja),null;var p=a[0];var r=a[a.length-1];this.a.construct_routing_path(a).then(function(a){function g(a,b,g,u){function B(){function a(b,d,c,n){if(q===b.join(",")&&w===d.join(",")&&c===ea){var g=Q(n);c=g[0];n=g[1];g=g[2];
n.join(",")===u.join(",")&&m.verify(c,u,t)&&(E.put_handshake_message(g),e.o.set(l+f,E),clearTimeout(D),e.a.off("data",a),e.P(h,t,b,d))}}var g,z;if(C.length){var v=K(C);var u=A(c);var G=m.convert_public_key(t);var E=m.Encryptor(!0,G);var x=E.get_handshake_message();x=ua(h,r,u,x,n,k);var F=g=new Uint8Array(c+x.length);F.set(v);F.set(x,c);F=m.sign(g,h,d.ed25519["private"]);g=z=new Uint8Array(x.length+y);g.set(F);g.set(x,y);G=m.one_way_encrypt(G,z);e.a.on("data",a);e.a.send_data(p,b,ca,va(u,v,t,G));e.fire("connection_progress",
h,t,oa);var D=I(L,function(){e.a.off("data",a);E.destroy();B()})}else e.fire("connection_failed",h,t,la)}if(q===a.join(",")&&w===b.join(",")&&g===aa){a=ta(u);g=a[0];var t=a[1];var C=a[2];f===t.join(",")&&(clearTimeout(v),g!==ba?e.fire("connection_failed",h,t,g):(e.fire("connection_progress",h,t,na),B()))}}e.fire("connection_progress",h,b,ma);var q=p.join(",");var w=a.join(",");e.a.on("data",g);e.a.send_data(p,a,Z,b);var v=I(L,function(){e.a.off("data",g);e.fire("connection_failed",h,b,ia)})})["catch"](function(a){D(a);
e.fire("connection_failed",h,b,ka)});return h},get_max_data_size:function(){return this.A},send_to:function(a,b,c,k){var n,e;var d=a.join(",");var h=b.join(",");if((n=this.o.get(d+h))&&!(k.length>this.A)&&(d=this.H.get(d+h)))for(h=e=new Uint8Array(k.length+1),h.set([c]),h.set(k,1),d.feed(e);d.have_more_blocks();)c=d.get_block(),c=n.encrypt(c),this.L(a,b,P,c)},destroy:function(){var a=this;clearInterval(this.$);clearInterval(this.Y);clearInterval(this.ca);this.g.forEach(function(b){a.X(b[0],b[1])});
this.s.forEach(function(a){clearTimeout(a[3])});this.b.destroy();this.a.destroy()},V:function(){return!!(this.f.size<X||this.T(!0).length)},T:function(a){var b,c;null==a&&(a=!1);var k=[];var g=+new Date-1E3*Da;var e=0;for(c=(b=Array.from(this.f.values())).length;e<c;++e){var d=b[e];var h=d[0];d=d[1];if(d<g&&(k.push(h.join(",")),a))break}return k},ba:function(){var a,b;if(a=this.J(5)){var c=0;for(b=a.length;c<b;++c){var k=a[c];this.S(k)}}},S:function(a){this.w.add(a.join(","));this.B(a,V,new Uint8Array(0))},
O:function(a,b){var c=this.J(1,b);return c?(a=this.I(a-1,b))?c.concat(a):null:null},J:function(a,b){var n,k,g=[];null==a&&(a=1);null==b&&(b=[]);if(!this.m.size)return this.b.lookup(A(c)),null;var e=Array.from(this.m.values());var d=0;for(k=(n=this.get_bootstrap_nodes()).length;d<k;++d){var h=n[d];b.push(h.node_id)}e=e.filter(function(a){return!sa(a,b)});if(!e.length)return null;for(d=0;d<a;++d)e.length&&g.push(K(e));return g},I:function(a,b){var c,k=[];if(this.f.size<a)return null;var g=Array.from(this.f.values());
b&&(g=g.filter(function(a){return!sa(a,b)}));if(g.length<a)return null;for(c=0;c<a;++c)k.push(K(g)[0]);return k},P:function(a,b,c,k){var g=v(c,k);var e=a.join(",");var d=b.join(",");this.c.has(g)||(this.h.set(e+d,[c,k]),this.c.set(g,[a,b]),this.H.set(e+d,r.Multiplexer(this.A,this.U)),this.G.set(e+d,r.Demultiplexer(this.A,this.U)),this.fire("connected",a,b))},X:function(a,b){var c=this;var k=v(a,b);if(this.g.has(k)&&(this.g["delete"](k),this.a.destroy_routing_path(a,b),this.u["delete"](k),this.j.forEach(function(a,
b){var d=a[1];var e=a[2];a=a[3];k===v(d,e)&&(clearInterval(a),c.j["delete"](b))}),this.c.has(k))){b=this.c.get(k);a=b[0];b=b[1];var g=a.join(",");var e=b.join(",");this.c["delete"](k);this.h["delete"](g+e);this.i.forEach(function(a){a[3]["delete"](e)});if(g=this.o.get(e))g.destroy(),this.o["delete"](e);this.H["delete"](e);this.G["delete"](e);this.fire("disconnected",a,b)}},B:function(a,b,c){function k(a){e===a.join(",")&&(clearTimeout(d),g.b.off("node_connected",k),g.M(a),g.b.send_data(a,b,c))}var g=
this;var e=a.join(",");if(this.m.has(e))this.M(a),this.b.send_data(a,b,c);else{this.b.on("node_connected",k);var d=I(Ea,function(){g.b.off("node_connected",k)});this.b.lookup(a)}},L:function(a,b,c,k){a=a.join(",");b=b.join(",");this.h.has(a+b)&&(a=this.h.get(a+b),b=a[0],a=a[1],this.a.send_data(b,a,c,k))},W:function(a,b){var c=v(a,b);if(this.u.has(c)||!this.g.has(c))return!1;this.a.send_data(a,b,ha,new Uint8Array(0));return!0},M:function(a){var b=a.join(",");this.D.has(b)||this.Z(a);this.D.set(b,[+new Date,
a])},Z:function(a){var b=a.join(",");var c=0;this.l.has(b)&&(c=this.l.get(b));++c;this.l.set(b,c);1===c&&this.b.add_used_tag(a)},aa:function(a){var b=a.join(",");if(this.l.has(b)){var c=this.l.get(b);--c;c?this.l.set(b,c):(this.l["delete"](b),this.b.del_used_tag(a))}}};l.prototype=Object.assign(Object.create(q.prototype),l.prototype);Object.defineProperty(l.prototype,"constructor",{enumerable:!1,value:l});return{ready:function(a){function b(){--c;c||a()}var c=2;m.ready(b);p.ready(b)},generate_seed:function(){return m.create_keypair().seed},
Core:l}}function sa(c,p){for(var m=-1,q=p.length>>>0;++m<q;)if(c===p[m])return!0;return!1}var A;var S=0;var T=1;var V=2;var W=3;var Y=0;var Z=1;var aa=2;var ca=3;var U=4;var da=5;var ea=6;var P=7;var ha=8;var c=32;var y=64;var w=48;var Ca=16;var C=64;var L=30;var Ea=10;var N=60;var Aa=1800;var Da=300;var X=1E3;var za=30;var ba=0;var O=1;var ia=2;var ja=3;var ka=4;var la=5;var ma=0;var na=1;var oa=2;var pa=0;var qa=1;var ra=2;"undefined"!==typeof crypto?A=function(c){c=new Uint8Array(c);crypto.getRandomValues(c);
return c}:A=require("crypto").randomBytes;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/transport","fixed-size-multiplexer","async-eventer"],M):"object"===typeof exports?module.exports=M(require("@detox/crypto"),require("@detox/transport"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_core=M(this.detox_crypto,this.detox_transport,this.fixed_size_multiplexer,this.async_eventer)}).call(this);